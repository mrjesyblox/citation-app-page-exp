<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow LE Web | Secure Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://shadowle.com/">
    <meta property="og:title" content="Shadow LE Web | Secure Access">
    <meta property="og:description" content="Law Enforcement Mobile Data Computer (MDC).&#10;Secure access for citations, arrests, and shift logging.&#10;Authorized Personnel Only.">
    
    <meta property="og:image" content="https://images.shadowle.com/embed_banner.png">

    <meta name="theme-color" content="#2563eb">
    
    <meta name="twitter:card" content="summary_large_image">
    <style>
    /* --- AUTOCOMPLETE THEME FIX --- */
        /* Dark Mode Autocomplete */
        .dark input:-webkit-autofill,
        .dark input:-webkit-autofill:hover,
        .dark input:-webkit-autofill:focus,
        .dark input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1e293b inset !important; /* Matches slate-800 */
            -webkit-text-fill-color: #e2e8f0 !important; /* Matches slate-200 */
            transition: background-color 5000s ease-in-out 0s;
            caret-color: white;
        }
        
        /* Light Mode Autocomplete */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #f8fafc inset !important; /* Matches slate-50 */
            -webkit-text-fill-color: #0f172a !important; /* Matches slate-900 */
            transition: background-color 5000s ease-in-out 0s;
        }

        /* Custom Styles & Animations */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Glassmorphism utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .slide-up {
            animation: slideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- NEW MODERN INPUT STYLES --- */
        .form-field-group {
            position: relative;
            margin-top: 1.5rem; /* Space for the label to float up */
        }
        
        .modern-input {
            /* Input Base: Border-bottom style */
            width: 100%;
            padding: 0.75rem 0.25rem 0.5rem 0.25rem; /* p-3 equivalent, adjusted for floating label */
            border: none;
            border-bottom: 2px solid #e2e8f0; /* slate-200 */
            background: transparent;
            color: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            border-radius: 0;
        }
        
        .dark .modern-input {
            border-bottom: 2px solid #475569; /* slate-700 */
        }
        
        /* Input Focus & Filled State */
        .modern-input:focus,
        .modern-input.filled {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: none;
            /* Ensure background is stable (inherited from card) */
            background-color: inherit; 
        }

        /* Input Textarea Fix (Themed) */
        .modern-input-textarea {
             width: 100%;
             padding: 0.75rem;
             border: 2px solid #e2e8f0; /* slate-200 */
             border-radius: 0.75rem;
             min-height: 120px;
             background-color: #f8fafc; /* slate-50 (Light mode bg) */
             color: #0f172a; /* slate-900 (Light mode text) */
             font-family: inherit;
             resize: vertical;
             transition: all 0.2s ease-in-out;
        }

        /* Dark Mode Styles */
        .dark .modern-input-textarea {
             border-color: #334155; /* slate-700 */
             background-color: #1e293b; /* slate-800 (Dark mode bg) */
             color: #e2e8f0; /* slate-200 (Dark mode text) */
        }

        /* Focus States */
        .modern-input-textarea:focus {
             outline: none;
             border-color: #3b82f6; /* blue-500 */
             background-color: #ffffff; /* White on focus (Light) */
             box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .dark .modern-input-textarea:focus {
             background-color: #0f172a; /* Darker on focus (Dark) */
             border-color: #60a5fa; /* blue-400 */
        }
        
        /* Floating Label Base */
        .floating-label {
            position: absolute;
            left: 0.25rem;
            top: 0.75rem; /* Matches input padding-top */
            font-size: 1rem;
            color: #64748b; /* slate-500 */
            pointer-events: none;
            transition: all 0.2s ease-out;
            transform-origin: top left;
        }
        
        .dark .floating-label {
             color: #94a3b8; /* slate-400 */
        }

        /* Floating Label - Transformation on Focus/Fill */
        .modern-input:focus + .floating-label,
        .modern-input.filled + .floating-label,
        .modern-input:not([value=""]):valid + .floating-label {
            transform: translateY(-1.5rem) scale(0.8);
            font-weight: 600;
            color: #3b82f6; /* blue-500 (Accent) */
        }
        
        /* Specific fix for number inputs (which don't accept empty string value="") */
        .modern-input[type="number"]:not([value="0"]):valid + .floating-label {
             transform: translateY(-1.5rem) scale(0.8);
             font-weight: 600;
             color: #3b82f6;
        }
        
        .modern-input[readonly] + .floating-label,
        .modern-input[disabled] + .floating-label {
            transform: translateY(-1.5rem) scale(0.8);
            font-weight: 600;
            color: #94a3b8; /* slate-400 */
        }

        /* Readonly/Disabled Input visual fix */
        .modern-input[readonly],
        .modern-input[disabled] {
            border-bottom-style: solid; /* Now a solid line */
            background-color: rgba(0,0,0,0.02); /* Optional: slight background to show it's disabled */
            color: #94a3b8 !important; 
        }

        /* --- END NEW MODERN INPUT STYLES --- */


        /* Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Ban Level Colors */
        .ban-level-0 { color: #22c55e; } 
        .ban-level-1 { color: #facc15; } 
        .ban-level-2 { color: #f97316; } 
        .ban-level-3 { color: #ef4444; } 
        .ban-level-4 { color: #b91c1c; }

        /* Autocomplete suggestions */
        /* --- MODERN DROPDOWN STYLES --- */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }

        .dropdown-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 50; /* High Z-Index to float above everything */
            margin-top: 4px;
            max-height: 250px;
            overflow-y: auto;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: none; /* Hidden by default */
        }
        
        /* Dark Mode for Dropdown */
        .dark .dropdown-results {
            background-color: #1e293b; /* Slate-800 */
            border-color: #334155;     /* Slate-700 */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .dark .dropdown-item {
            border-color: #334155;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f8fafc; /* Slate-50 */
        }
        .dark .dropdown-item:hover {
            background-color: #334155; /* Slate-700 */
        }

        /* Text Styling inside Dropdown */
        .dropdown-code { font-weight: 700; color: #3b82f6; font-family: monospace; font-size: 0.9em; flex-shrink: 0; }
        .dropdown-desc { font-weight: 500; color: #1e293b; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dropdown-meta { font-size: 0.75rem; color: #64748b; font-weight: 600; text-align: right; flex-shrink: 0; background: #f1f5f9; padding: 2px 8px; rounded-md; }
        
        .dark .dropdown-code { color: #60a5fa; }
        .dark .dropdown-desc { color: #f1f5f9; }
        .dark .dropdown-meta { color: #cbd5e1; background: #0f172a; }

        .dropdown-results.show { display: block; }

        /* Dynamic Groups */
        .charge-group, .penal-code-group {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: end;
        }
        @media (max-width: 768px) {
            .charge-group, .penal-code-group { grid-template-columns: 1fr; }
        }

        /* Image Preview */
        .image-preview-container {
            margin-top: 1rem;
            border: 2px dashed #cbd5e1;
            padding: 1rem;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
        }
        .dark .image-preview-container {
            border-color: #475569;
            background-color: #1e293b;
        }
        .image-preview-container img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        /* Radio Container */
        .radio-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.5rem 0;
        }
        .radio-container input[type="radio"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #2563eb;
        }
        
        .penal-code-list-modal-content {
            max-height: 400px;
            overflow-y: auto;
        }

        /* --- PODIUM STYLES --- */
        .podium-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 1rem;
            min-height: 320px;
            padding-bottom: 2rem;
        }

        .podium-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100px;
            position: relative;
        }

        @media (min-width: 768px) {
            .podium-step { width: 140px; }
            .podium-container { gap: 2rem; }
        }

        .podium-step:hover {
            transform: translateY(-5px);
        }

        .podium-avatar-container {
            position: relative;
            margin-bottom: 1rem;
            z-index: 2;
        }

        .podium-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 4px solid;
            object-fit: cover;
            background-color: #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s;
        }

        @media (min-width: 768px) {
            .podium-avatar { width: 80px; height: 80px; }
        }

        .podium-rank-badge {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dark .podium-rank-badge { border-color: #1e293b; }

        .podium-bar {
            width: 100%;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .podium-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }

        .rank-1-step { order: 2; z-index: 10; margin-bottom: 0; }
        .rank-1-step .podium-bar { height: 200px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .rank-1-step .podium-avatar { border-color: #f59e0b; box-shadow: 0 0 25px rgba(245, 158, 11, 0.4); }
        .rank-1-step .podium-rank-badge { background-color: #d97706; }

        .rank-2-step { order: 1; margin-bottom: 0; }
        .rank-2-step .podium-bar { height: 150px; background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
        .rank-2-step .podium-avatar { border-color: #94a3b8; }
        .rank-2-step .podium-rank-badge { background-color: #64748b; }

        .rank-3-step { order: 3; margin-bottom: 0; }
        .rank-3-step .podium-bar { height: 120px; background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
        .rank-3-step .podium-avatar { border-color: #b45309; }
        .rank-3-step .podium-rank-badge { background-color: #78350f; }

        .podium-score { font-weight: 900; color: white; font-size: 1.75rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-bottom: 0.25rem; }
        .podium-label { color: rgba(255,255,255,0.9); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .podium-name { margin-top: 0.5rem; font-weight: 700; text-align: center; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 120%; color: inherit; }
        
        .leaderboard-list-item { transition: all 0.2s; }
        .leaderboard-list-item:hover { transform: scale(1.01); background-color: rgba(248, 250, 252, 1); }
        .dark .leaderboard-list-item:hover { background-color: rgba(51, 65, 85, 0.5); }

        /* --- CUSTOM SCROLLBARS --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Slate-300 */
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Slate-400 */
        }

        /* Dark Mode Scrollbar */
        .dark ::-webkit-scrollbar-thumb {
            background: #334155; /* Slate-700 */
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #475569; /* Slate-600 */
        }

        /* Firefox Support */
        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .dark * {
            scrollbar-color: #334155 transparent;
        }

        /* Fix for Date inputs so label doesn't overlap the date picker text */
        .modern-input[type="date"] + .floating-label,
        .modern-input[type="datetime-local"] + .floating-label {
            transform: translateY(-1.5rem) scale(0.8);
            font-weight: 600;
            color: #3b82f6; /* Blue-500 */
        }
        .dark .modern-input[type="date"] + .floating-label,
        .dark .modern-input[type="datetime-local"] + .floating-label {
            color: #60a5fa; /* Blue-400 */
        }

        select.modern-input {
            appearance: none; /* Removes default system arrow */
            -webkit-appearance: none;
            /* Custom Arrow Icon (Grey) */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2394a3b8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0rem top 50%;
            background-size: 0.65rem auto;
            padding-right: 1.5rem;
        }

        /* Dropdown Options - Light Mode */
        select.modern-input option {
            background-color: #ffffff;
            color: #0f172a;
        }

        /* Dropdown Options - Dark Mode */
        .dark select.modern-input {
            background-color: transparent; /* Blends with container */
            color: #e2e8f0;
        }
        
        .dark select.modern-input option {
            background-color: #1e293b; /* Dark Slate Background */
            color: #e2e8f0; /* Light Text */
        }

        /* --- MODAL ANIMATIONS --- */
        @keyframes modalPopIn {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .animate-modal-pop {
            animation: modalPopIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

       /* --- MODERN SMOOTH ANIMATIONS --- */

        /* 1. Modal Overlay (The Background) */
        .modal-overlay {
            opacity: 0;
            visibility: hidden; /* Hides it from clicks when closed */
            transition: all 0.3s ease-in-out;
        }
        
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* 2. Modal Content (The Card) */
        .modal-content {
            opacity: 0;
            transform: scale(0.95) translateY(10px); /* Starts slightly smaller and lower */
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); /* "Spring" ease */
        }

        .modal-overlay.open .modal-content {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        /* 3. Dropdowns (Search Results) */
        .dropdown-results {
            /* Overwrite existing display:none logic with this: */
            display: block !important; 
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.98);
            transform-origin: top center;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none; /* Can't click when hidden */
        }

        .dropdown-results.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* Add this inside your <style> tag */
.role-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}
.role-checkbox-label:hover {
    background-color: #f8fafc;
    border-color: #cbd5e1;
}
.role-checkbox-label:has(input:checked) {
    background-color: #eff6ff; /* blue-50 */
    border-color: #3b82f6; /* blue-500 */
    color: #1d4ed8; /* blue-700 */
}
.dark .role-checkbox-label {
    border-color: #334155;
}
.dark .role-checkbox-label:hover {
    background-color: #1e293b;
}
.dark .role-checkbox-label:has(input:checked) {
    background-color: #1e3a8a; /* blue-900 */
    border-color: #60a5fa; /* blue-400 */
    color: #93c5fd; /* blue-300 */
}

    </style>
</head>
<body class="antialiased h-screen w-full overflow-hidden relative bg-[#f5f5f7] text-[#1d1d1f] dark:bg-slate-950 dark:text-slate-200 transition-colors duration-300">

    <div id="customModalOverlay" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 max-w-sm w-full border border-slate-200 dark:border-slate-800 modal-content">
            <h3 id="customModalTitle" class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Alert</h3>
            <p id="customModalMessage" class="text-slate-600 dark:text-slate-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="customModalCancelBtn" class="hidden px-4 py-2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 font-medium transition-colors">Cancel</button>
                <button id="customModalOkBtn" class="px-4 py-2 bg-slate-900 dark:bg-blue-600 text-white rounded-lg font-bold hover:opacity-90 transition-opacity">OK</button>
            </div>
        </div>
    </div>

    <div id="penalCodeListModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 max-w-2xl w-full border border-slate-200 dark:border-slate-800 flex flex-col max-h-[80vh] modal-content">
            <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-800 pb-2">Available Penal Codes</h3>
            
            <div class="mb-4 relative">
                <i class="ph-bold ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                <input type="text" id="penalCodeSearchInput" class="w-full pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 border border-transparent focus:bg-white dark:focus:bg-slate-900 focus:border-blue-500 rounded-xl text-slate-900 dark:text-white transition-all outline-none" placeholder="Search codes, crimes, or types...">
            </div>

            <div id="penalCodeListModalContent" class="penal-code-list-modal-content flex-1 overflow-y-auto space-y-2 pr-2">
            </div>
            
            <div class="flex justify-end mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                <button id="penalCodeListModalCloseBtn" onclick="toggleModal('penalCodeListModalOverlay', false)" class="px-6 py-2 bg-slate-900 dark:bg-blue-600 text-white rounded-lg font-bold hover:opacity-90">Close</button>
            </div>
        </div>
    </div>

    <section id="login-view" class="absolute inset-0 z-50 flex items-center justify-center w-full h-full bg-[#f5f5f7] dark:bg-slate-950 transition-colors duration-300">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
            <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-200 dark:bg-blue-900 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-[80px] opacity-30 animate-pulse transition-colors duration-300"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-indigo-200 dark:bg-indigo-900 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-[80px] opacity-30 animate-pulse transition-colors duration-300" style="animation-delay: 2s"></div>
        </div>

        <div class="glass-panel w-full max-w-md p-8 md:p-12 rounded-3xl shadow-2xl relative z-10 slide-up mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-slate-800 to-slate-900 dark:from-blue-600 dark:to-blue-800 text-white rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="ph-duotone ph-shield-check text-4xl"></i>
                </div>
                <h1 class="text-2xl font-semibold tracking-tight text-slate-900 dark:text-white">Shadow LE Web</h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-2">Law Enforcement Secure Access</p>
            </div>

            <form id="login-form" class="space-y-5">
                <div class="form-field-group !mt-0">
                    <input type="text" id="login-username" class="modern-input" value="" placeholder="" required onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                    <label for="login-username" class="floating-label">Badge ID / Username</label>
                </div>
                
                <div class="form-field-group">
                    <input type="password" id="login-password" class="modern-input" value="" placeholder="" required onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                    <label for="login-password" class="floating-label">Password</label>
                </div>

                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center gap-3 cursor-pointer group select-none">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="login-remember" class="peer sr-only">
                            
                            <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-blue-600 peer-checked:border-blue-600 peer-focus:ring-2 peer-focus:ring-blue-500/30 transition-all duration-200 shadow-sm group-hover:border-blue-400 dark:group-hover:border-blue-500"></div>
                            
                            <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                        </div>
                        <span class="text-slate-500 dark:text-slate-400 font-medium group-hover:text-slate-700 dark:group-hover:text-slate-200 transition-colors">Remember me</span>
                    </label>
                </div>

                <button type="submit" id="login-submit-btn" class="w-full py-3.5 bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-500 text-white font-medium rounded-xl shadow-lg hover:shadow-xl transform active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-2">
                    <span>Sign In</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </form>
            
            <p class="text-center text-xs text-slate-400 dark:text-slate-500 mt-8">Authorized Personnel Only. <br>Access is monitored and logged.</p>
        </div>
    </section>

    <div id="dashboard-view" class="hidden flex h-screen w-full bg-[#f5f5f7] dark:bg-slate-900 transition-colors duration-300">
        
        <aside class="w-20 lg:w-72 bg-white dark:bg-slate-900 h-full border-r border-slate-200 dark:border-slate-800 flex flex-col justify-between transition-all duration-300 z-20 shadow-sm relative">
            <div class="flex flex-col h-full">
                <div class="h-20 flex items-center justify-center lg:justify-start lg:px-8 border-b border-slate-100 dark:border-slate-800 shrink-0">
                    <div class="w-10 h-10 bg-slate-900 dark:bg-blue-600 text-white rounded-xl flex items-center justify-center shadow-md shrink-0">
                        <i class="ph-duotone ph-shield-check text-xl"></i>
                    </div>
                    <span class="ml-3 font-bold text-lg text-slate-900 dark:text-white hidden lg:block tracking-tight">Shadow LE</span>
                </div>

                <nav class="p-4 space-y-1 mt-4 overflow-y-auto flex-1 no-scrollbar">
                     <button onclick="router('home')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="home">
                        <i class="ph-duotone ph-squares-four text-xl"></i>
                        <span class="hidden lg:block">Dashboard</span>
                    </button>
                    <button onclick="router('leaderboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="leaderboard">
                        <i class="ph-duotone ph-trophy text-xl"></i>
                        <span class="hidden lg:block">Leaderboard</span>
                    </button>
                    <button onclick="router('citation')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="citation">
                        <i class="ph-duotone ph-notepad text-xl"></i>
                        <span class="hidden lg:block">Issue Citation</span>
                    </button>
                    <button onclick="router('arrest')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="arrest">
                        <i class="ph-duotone ph-siren text-xl"></i>
                        <span class="hidden lg:block">Process Arrest</span>
                    </button>
                    <button onclick="router('registry')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="registry">
                        <i class="ph-duotone ph-car text-xl"></i>
                        <span class="hidden lg:block">Vehicle Registry</span>
                    </button>
                    <button onclick="router('shift')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="shift">
                        <i class="ph-duotone ph-clipboard-text text-xl"></i>
                        <span class="hidden lg:block">Shift Log</span>
                    </button>
                    <button onclick="router('moderation')" class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item" data-target="moderation">
                        <i class="ph-duotone ph-gavel text-xl"></i>
                        <span class="hidden lg:block">Moderation</span>
                    </button>
                    <button id="admin-nav-btn" onclick="router('admin')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item hidden" data-target="admin">
                        <i class="ph-duotone ph-shield-check text-xl"></i>
                        <span class="hidden lg:block">Admin Panel</span>
                    </button>
                    <button onclick="router('settings')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white font-medium transition-all group nav-item mt-4 border-t border-slate-100 dark:border-slate-800 pt-4" data-target="settings">
                        <i class="ph-duotone ph-gear text-xl"></i>
                        <span class="hidden lg:block">Settings</span>
                    </button>
                </nav>
            </div>

            <div class="p-4 border-t border-slate-100 dark:border-slate-800 shrink-0">
                <button id="logout-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 font-medium transition-all justify-center lg:justify-start">
                    <i class="ph-duotone ph-sign-out text-xl"></i>
                    <span class="hidden lg:block">Log Out</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <header class="h-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 sticky top-0 z-10 transition-colors duration-300">
                <h2 class="text-xl font-semibold text-slate-800 dark:text-white" id="page-title">User Dashboard</h2>
                
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3 pl-6 border-l border-slate-200 dark:border-slate-700">
                        <div class="text-right hidden md:block">
                            <p id="display-username" class="text-sm font-semibold text-slate-900 dark:text-white">Officer</p>
                            <p id="display-badge" class="text-xs text-slate-500 dark:text-slate-400">Badge: ---</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-white dark:border-slate-800 shadow-sm">
                            <img id="profile-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Officer" alt="Profile" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-6 lg:p-10 no-scrollbar relative">
                
                <div id="view-home" class="page-view fade-in">
                    <div class="bg-gradient-to-r from-slate-900 to-slate-800 dark:from-blue-900 dark:to-slate-900 rounded-3xl p-8 text-white shadow-lg mb-8 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        <div class="relative z-10">
                            <h3 id="welcome-message" class="text-2xl font-bold mb-2">Welcome back.</h3>
                            <p class="text-slate-300 max-w-lg">Access the latest reports, registry data, and submit your shift logs.</p>
                            <button onclick="router('citation')" class="mt-6 px-6 py-2.5 bg-white text-slate-900 rounded-full text-sm font-semibold hover:bg-slate-100 transition shadow-sm">New Citation</button>
                        </div>
                    </div>

                    <h4 class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-6">Quick Selection</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <button onclick="router('leaderboard')" class="group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 flex items-center justify-center mb-4 group-hover:bg-yellow-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-trophy text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Leaderboard</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">View rankings.</p>
                        </button>
                        
                        <button onclick="router('citation')" class="group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-notepad text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Issue Citation</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">File a new ticket.</p>
                        </button>

                        <button onclick="router('arrest')" class="group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 flex items-center justify-center mb-4 group-hover:bg-rose-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-siren text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Process Arrest</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Log custody.</p>
                        </button>

                        <button onclick="router('shift')" class="group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 flex items-center justify-center mb-4 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-clipboard-text text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Submit Shift Log</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Record hours and activity.</p>
                        </button>

                        <button onclick="router('registry')" class="group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 flex items-center justify-center mb-4 group-hover:bg-amber-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-car text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Vehicle Registry</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Search plates.</p>
                        </button>
                        
                        <button id="home-mod-btn" onclick="router('moderation')" class="hidden group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 flex items-center justify-center mb-4 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-gavel text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Moderation Panel</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Review flagged content.</p>
                        </button>

                        <button onclick="router('settings')" class="group bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg dark:hover:bg-slate-850 hover:-translate-y-1 transition-all duration-300 text-left">
                            <div class="w-12 h-12 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 flex items-center justify-center mb-4 group-hover:bg-slate-800 dark:group-hover:bg-slate-600 group-hover:text-white transition-colors">
                                <i class="ph-duotone ph-gear text-2xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Settings</h5>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Preferences & Account.</p>
                        </button>
                    </div>
                </div>

                <div id="view-shift" class="page-view hidden animate-fade-in space-y-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-200 dark:bg-slate-700" id="shift-status-bar"></div>
                
                <div class="flex flex-col items-center text-center py-6">
                    <div id="shift-icon-container" class="w-20 h-20 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4 transition-colors duration-500">
                        <i id="shift-icon" class="ph-duotone ph-clock text-4xl text-slate-400"></i>
                    </div>
                    
                    <h2 id="shift-status-text" class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Off Duty</h2>
                    <p id="shift-timer" class="text-4xl font-mono font-bold text-slate-700 dark:text-slate-300 tracking-wider mb-6">00:00:00</p>
                    
                    <div class="w-full flex gap-3">
                        <button id="btn-start-shift" onclick="startShift()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 transition-all flex items-center justify-center gap-2">
                            <i class="ph-bold ph-play"></i> Start Shift
                        </button>
                        <button id="btn-end-shift" onclick="openEndShiftModal()" class="hidden flex-1 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold shadow-lg shadow-rose-500/30 transition-all flex items-center justify-center gap-2">
                            <i class="ph-bold ph-stop"></i> End Shift
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800">
                <h3 class="font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                    <i class="ph-duotone ph-clock-counter-clockwise text-blue-500"></i> Recent Shifts
                </h3>
                <div id="recent-shifts-list" class="space-y-3">
                    <div class="text-center text-slate-400 text-sm py-4">Loading history...</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            
            <div id="live-tracker-card" class="bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800 opacity-50 pointer-events-none transition-all">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <i class="ph-duotone ph-crosshair text-red-500"></i> Live Activity Tracker
                    </h3>
                    <span class="text-xs font-medium text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">Session Stats</span>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-100 dark:border-slate-800 flex flex-col items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Traffic Stops</span>
                        <div class="flex items-center gap-4">
                            <button onclick="updateLiveStat('stops', -1)" class="w-8 h-8 rounded-lg bg-white dark:bg-slate-700 shadow text-slate-500 hover:text-red-500 transition-colors"><i class="ph-bold ph-minus"></i></button>
                            <span id="live-stops" class="text-3xl font-black text-slate-900 dark:text-white w-12 text-center">0</span>
                            <button onclick="updateLiveStat('stops', 1)" class="w-8 h-8 rounded-lg bg-blue-600 shadow text-white hover:bg-blue-700 transition-colors"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-100 dark:border-slate-800 flex flex-col items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Citations</span>
                        <div class="flex items-center gap-4">
                            <button onclick="updateLiveStat('citations', -1)" class="w-8 h-8 rounded-lg bg-white dark:bg-slate-700 shadow text-slate-500 hover:text-red-500 transition-colors"><i class="ph-bold ph-minus"></i></button>
                            <span id="live-citations" class="text-3xl font-black text-slate-900 dark:text-white w-12 text-center">0</span>
                            <button onclick="updateLiveStat('citations', 1)" class="w-8 h-8 rounded-lg bg-emerald-600 shadow text-white hover:bg-emerald-700 transition-colors"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-100 dark:border-slate-800 flex flex-col items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Arrests</span>
                        <div class="flex items-center gap-4">
                            <button onclick="updateLiveStat('arrests', -1)" class="w-8 h-8 rounded-lg bg-white dark:bg-slate-700 shadow text-slate-500 hover:text-red-500 transition-colors"><i class="ph-bold ph-minus"></i></button>
                            <span id="live-arrests" class="text-3xl font-black text-slate-900 dark:text-white w-12 text-center">0</span>
                            <button onclick="updateLiveStat('arrests', 1)" class="w-8 h-8 rounded-lg bg-rose-600 shadow text-white hover:bg-rose-700 transition-colors"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>
                </div>
                <p class="text-center text-xs text-slate-400 mt-4">Stats tracked here will automatically appear in your End Shift report.</p>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-blue-800 dark:text-blue-300 mb-2">Shift Guidelines</h3>
                <ul class="list-disc list-inside space-y-2 text-blue-700 dark:text-blue-400 text-sm">
                    <li>Start your shift <strong>immediately</strong> upon going on duty (10-41).</li>
                    <li>Use the <strong>Live Activity Tracker</strong> above to count stops as they happen.</li>
                    <li>End your shift <strong>immediately</strong> before going off duty (10-42).</li>
                    <li>You must upload a screenshot of your game/map/MDC when ending your shift for verification.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

                <div id="view-settings" class="page-view hidden">
                    <div class="max-w-4xl mx-auto">
                         <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Settings</h2>
                            <button onclick="router('home')" class="text-sm text-slate-500 hover:text-slate-900 dark:hover:text-white">Back to Home</button>
                         </div>

                         <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 md:p-8 border border-slate-200 dark:border-slate-800 shadow-sm mb-8">
                             <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                 <i class="ph-duotone ph-lock-key text-blue-600 dark:text-blue-400"></i>
                                 Account Security
                             </h3>
                             <form onsubmit="saveProfileSettings(event)" class="space-y-6">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                     <div class="form-field-group !mt-0">
                                         <input type="text" id="settings-username" class="modern-input" disabled readonly value="">
                                         <label for="settings-username" class="floating-label">Display Username</label>
                                     </div>
                                     <div class="form-field-group !mt-0">
                                         <input type="text" id="settings-badge" disabled class="modern-input" value="">
                                         <label for="settings-badge" class="floating-label">Badge Number</label>
                                     </div>
                                 </div>
                                 
                                 <div class="border-t border-slate-100 dark:border-slate-800 pt-8">
                                     <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-4">Change Password</h4>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                        <div class="form-field-group !mt-0">
                                            <input type="password" id="settings-old-pass" class="modern-input" required onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                                            <label for="settings-old-pass" class="floating-label">Current Password</label>
                                        </div>
                                        <div class="form-field-group !mt-0">
                                            <input type="password" id="settings-new-pass" class="modern-input" required onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                                            <label for="settings-new-pass" class="floating-label">New Password</label>
                                        </div>
                                     </div>
                                     <p id="password-change-message" class="text-sm mt-3 hidden"></p>
                                 </div>

                                 <div class="flex justify-end pt-2">
                                     <button type="submit" class="px-6 py-2.5 bg-slate-900 dark:bg-blue-600 text-white font-medium rounded-xl hover:bg-slate-800 dark:hover:bg-blue-700 transition-colors shadow-sm">Save Changes</button>
                                 </div>
                             </form>
                         </div>

                         <div id="settings-transfer-card" class="bg-white dark:bg-slate-900 rounded-2xl p-6 md:p-8 border border-slate-200 dark:border-slate-800 shadow-sm mb-8">
                             <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                 <i class="ph-duotone ph-briefcase text-emerald-600 dark:text-emerald-400"></i>
                                 Department Transfer
                             </h3>
                             <form onsubmit="submitDeptTransfer(event)" class="space-y-6">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                     <div class="form-field-group !mt-0">
                                         <input type="text" id="transfer-current" class="modern-input" disabled readonly value="">
                                         <label for="transfer-current" class="floating-label">Current Department</label>
                                     </div>
                                     
                                     <div class="custom-dropdown-container form-field-group !mt-0 relative">
                                         <input type="text" id="transfer-new" class="modern-input cursor-pointer" readonly placeholder=" " autocomplete="off">
                                         <label for="transfer-new" class="floating-label">Requested Department</label>
                                         
                                         <div id="transfer-dept-arrow" class="absolute right-0 top-4 mr-2 pointer-events-none text-slate-400 transition-transform duration-200 origin-center">
                                             <i class="ph-bold ph-caret-down"></i>
                                         </div>
                                         
                                         <div id="transfer-dept-results" class="dropdown-results"></div>
                                     </div>
                                 </div>
                                 
                                 <div class="form-field-group">
                                     <textarea id="transfer-reason" class="modern-input-textarea" required placeholder="Reason for transfer request..."></textarea>
                                 </div>

                                 <div class="flex justify-end pt-2">
                                     <button type="submit" class="px-6 py-2.5 bg-emerald-600 text-white font-medium rounded-xl hover:bg-emerald-700 transition-colors shadow-sm">Submit Request</button>
                                 </div>
                             </form>
                         </div>

                         <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 md:p-8 border border-slate-200 dark:border-slate-800 shadow-sm mb-8">
                             <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                 <i class="ph-duotone ph-paint-brush text-purple-600 dark:text-purple-400"></i>
                                 Appearance
                             </h3>
                             <div class="flex items-center justify-between">
                                 <div>
                                     <p class="font-medium text-slate-900 dark:text-white">Interface Theme</p>
                                     <p class="text-sm text-slate-500 dark:text-slate-400">Customize how Shadow LE looks on your device.</p>
                                 </div>
                                 <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                     <button onclick="setTheme('light')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:text-slate-900 dark:hover:text-white" id="theme-btn-light">Light</button>
                                     <button onclick="setTheme('dark')" class="px-4 py-2 rounded-lg text-sm font-medium transition-all hover:text-slate-900 dark:hover:text-white" id="theme-btn-dark">Dark</button>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>

                <div id="view-leaderboard" class="page-view hidden">
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 shrink-0">
                            <div>
                                <button onclick="router('home')" class="flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:hover:text-white transition-colors text-sm font-medium mb-1">
                                    <i class="ph-duotone ph-arrow-left"></i> Back
                                </button>
                                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Department Rankings</h2>
                            </div>
                            
                            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex gap-1">
                                <button onclick="switchLeaderboardTab('citation')" id="tab-citation" class="px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white dark:bg-slate-600 shadow-sm text-slate-900 dark:text-white">
                                    Citations
                                </button>
                                <button onclick="switchLeaderboardTab('shift')" id="tab-shift" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
                                    Shift Logs
                                </button>
                            </div>
                        </div>

                        <div id="podium-area" class="shrink-0 mb-8 pt-4">
                            <div class="text-center text-slate-400 py-12">Loading Podium...</div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex-1 overflow-hidden flex flex-col">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/30">
                                <h3 class="font-bold text-slate-900 dark:text-white text-sm uppercase tracking-wide">Honorable Mentions</h3>
                            </div>
                            <div id="leaderboard-list-area" class="overflow-y-auto flex-1 p-2 space-y-2">
                                </div>
                        </div>
                    </div>
                </div>

                <div id="view-arrest" class="page-view hidden">
                    <div class="max-w-4xl mx-auto">
                        <button onclick="router('home')" class="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:hover:text-white transition-colors text-sm font-medium">
                            <i class="ph-duotone ph-arrow-left"></i> Back to Dashboard
                        </button>
                        
                        <h2 class="text-3xl font-extrabold text-center mb-10 text-slate-900 dark:text-white tracking-tight">Process Arrest Report</h2>

                        <form id="arrestForm" class="space-y-8">
                            <div class="p-8 rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl">
                                <h3 class="font-bold text-xl mb-6 flex items-center text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-3">
                                    <i class="ph-duotone ph-identification-badge text-blue-600 dark:text-blue-400 mr-3 text-2xl"></i>
                                    Personnel & Suspect Information
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="arrestingOfficerBadge" name="arrestingOfficerBadge" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="arrestingOfficerBadge" class="floating-label">Officer Badge Number</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="yourUsername" name="yourUsername" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="yourUsername" class="floating-label">Your Username</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="officerDepartmentDisplayArrest" name="officerDepartmentDisplay" class="modern-input" readonly value="" />
                                        <label for="officerDepartmentDisplayArrest" class="floating-label">Department</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="suspectName" name="suspectName" required class="modern-input" value="" autocomplete="off" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="suspectName" class="floating-label">Suspect's USER ID</label>
                                    </div>

                                    <div class="form-field-group">
                                        <input type="text" id="leoUsernames" name="leoUsernames" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="leoUsernames" class="floating-label">Officer Name(s)</label>
                                    </div>

                                    <div class="form-field-group">
                                        <input type="text" id="ranks" name="ranks" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="ranks" class="floating-label">Officer Rank(s)</label>
                                    </div>
                                </div>
                            </div>

                            <div class="p-8 rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl">
                                <h3 class="font-bold text-xl mb-6 flex items-center text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-3">
                                    <i class="ph-duotone ph-gavel text-rose-600 dark:text-rose-400 mr-3 text-2xl"></i>
                                    Charges & Sentencing
                                </h3>
                                <div id="chargeInputsContainer" class="space-y-4">
                                    <div class="charge-group" data-group-id="0">
                                        <div class="relative form-field-group !mt-0">
                                            <input type="text" id="chargeCode_0" class="modern-input charge-code-input" autocomplete="off" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                            <label for="chargeCode_0" class="floating-label">Charge Code</label>
                                            <div id="chargeSuggestions_0" class="autocomplete-suggestions hidden"></div>
                                        </div>
                                        <div class="form-field-group !mt-0">
                                            <input type="number" id="jailTime_0" readonly class="modern-input jail-time-input" value="0">
                                            <label for="jailTime_0" class="floating-label">Jail (Sec)</label>
                                        </div>
                                        <button type="button" class="self-end p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg remove-charge-btn hidden" onclick="this.closest('.charge-group').remove(); updateArrestTotals();">
                                            <i class="ph-duotone ph-trash text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-4 mt-8">
                                    <button type="button" id="addChargeBtn" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-md flex items-center gap-2">
                                        <i class="ph-bold ph-plus-circle text-lg"></i> Add Charge
                                    </button>
                                    <button type="button" onclick="showPenalCodeModal()" class="px-6 py-2.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shadow-sm">View Penal Codes</button>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10 pt-6 border-t border-slate-100 dark:border-slate-700">
                                    <div class="text-left bg-slate-50 dark:bg-slate-800 p-4 rounded-xl shadow-inner">
                                        <p class="mb-2 font-bold text-lg text-slate-900 dark:text-white">TOTAL JAIL TIME</p>
                                        <input type="text" id="totalJailTimeSum" name="jailTime" class="w-full text-right font-black text-3xl bg-rose-100 dark:bg-rose-900/30 border-none text-rose-700 dark:text-rose-400 rounded-xl px-4 py-2 transition-all" value="0" readonly>
                                    </div>
                                    <div class="text-left bg-slate-50 dark:bg-slate-800 p-4 rounded-xl shadow-inner">
                                        <p class="mb-2 font-bold text-lg text-slate-900 dark:text-white">TOTAL FINES</p>
                                        <input type="text" id="totalFinesSum" name="totalFines" class="w-full text-right font-black text-3xl bg-emerald-100 dark:bg-emerald-900/30 border-none text-emerald-700 dark:text-emerald-400 rounded-xl px-4 py-2 transition-all" value="$0.00" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="p-8 rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl">
                                <h3 class="font-bold text-xl mb-6 flex items-center text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-3">
                                    <i class="ph-duotone ph-siren text-red-600 dark:text-red-400 mr-3 text-2xl"></i>
                                    Warrant & Evidence
                                </h3>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block mb-2 font-bold text-md text-slate-900 dark:text-white">Warrant Needed?</label>
                                        <div class="radio-container text-slate-700 dark:text-slate-300">
                                            <input type="radio" id="warrantNeededNo" name="warrantNeeded" value="NO" checked><label for="warrantNeededNo">NO (Final Arrest)</label>
                                            <input type="radio" id="warrantNeededYes" name="warrantNeeded" value="YES"><label for="warrantNeededYes">YES (Request Warrant)</label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block mb-2 font-bold text-md text-slate-900 dark:text-white">Serving Warrant?</label>
                                        <div class="radio-container text-slate-700 dark:text-slate-300">
                                            <input type="radio" id="servingWarrantNo" name="servingWarrant" value="NO" checked><label for="servingWarrantNo">NO</label>
                                            <input type="radio" id="servingWarrantYes" name="servingWarrant" value="YES"><label for="servingWarrantYes">YES</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="warrantJailTimeContainer" class="mt-6 hidden p-4 border border-blue-200 dark:border-blue-900/50 rounded-lg bg-blue-50 dark:bg-blue-950/50">
                                    <div class="form-field-group !mt-0">
                                        <input type="number" id="warrantJailTime" step="1" min="0" value="0" class="modern-input" onfocus="this.classList.add('filled')" onblur="if(this.value === '0') this.classList.remove('filled')" />
                                        <label for="warrantJailTime" class="floating-label text-blue-800 dark:text-blue-300">Jail Time (Seconds) on Warrant</label>
                                    </div>
                                </div>

                                <div class="mt-8 border-t border-slate-100 dark:border-slate-700 pt-6">
                                    <div class="flex justify-between items-end mb-3">
                                        <label class="font-medium text-slate-700 dark:text-slate-300 text-sm">Suspect Mugshot:</label>
                                        
                                        <button type="button" id="noMugshotBtn" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 rounded-lg text-xs font-bold transition-colors flex items-center gap-2">
                                            <i class="ph-bold ph-user-minus"></i> No Photo Available
                                        </button>
                                    </div>

                                    <input type="file" id="mugshotUpload" accept="image/*" class="w-full p-3 border border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-colors shadow-sm">
                                    
                                    <p class="text-center my-3 font-semibold text-slate-500">OR</p>
                                    <div id="pasteMugshotTarget" tabindex="0" class="p-3 border border-dashed border-slate-300 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 text-center font-medium cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-600 dark:text-slate-400">
                                        Paste mugshot image here (Ctrl+V)
                                    </div>
                                    
                                    <div id="mugshotPreview" class="image-preview-container mt-4">
                                        <p class="text-slate-400 text-sm">No image selected</p>
                                    </div>
                                    
                                    <div class="mt-6 form-field-group">
                                        <label class="block mb-2 font-medium text-slate-700 dark:text-slate-300 text-sm">Incident Narrative</label>
                                        <textarea id="incidentDetails" name="incidentDetails" required class="w-full modern-input-textarea transition-colors" placeholder="Provide detailed account of the arrest..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-wrap justify-center gap-4 pt-4">
                                <button type="submit" class="px-10 py-3.5 bg-red-600 text-white rounded-xl font-semibold text-lg hover:bg-red-700 transition-colors shadow-xl transform active:scale-[0.98]">Submit Arrest Report</button>
                                <button type="button" id="clearArrestFormBtn" class="px-10 py-3.5 bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-xl font-semibold hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors shadow-md">Clear Form</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="view-citation" class="page-view hidden">
                    <div class="max-w-4xl mx-auto">
                        <button onclick="router('home')" class="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:hover:text-white transition-colors text-sm font-medium">
                            <i class="ph-duotone ph-arrow-left"></i> Back to Dashboard
                        </button>
                        
                        <h2 class="text-3xl font-extrabold text-center mb-10 text-slate-900 dark:text-white tracking-tight">Issue Citation Details</h2>
                        
                        <form id="citationForm" class="space-y-8">
                            <div class="p-8 rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl">
                                <h3 class="font-bold text-xl mb-6 flex items-center text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-3">
                                    <i class="ph-duotone ph-user-focus text-blue-600 dark:text-blue-400 mr-3 text-2xl"></i>
                                    Personnel & Violator Information
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="officerBadge" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="officerBadge" class="floating-label">Officer Badge Number</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="officerName" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="officerName" class="floating-label">Officer Username</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="officerDepartmentDisplayCitation" class="modern-input" readonly value="" />
                                        <label for="officerDepartmentDisplayCitation" class="floating-label">Department</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="violatorName" required class="modern-input" value="" autocomplete="off" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="violatorName" class="floating-label">Violator's USER ID</label>
                                    </div>
                                    
                                    <div class="form-field-group">
                                        <input type="text" id="citationOfficerRank" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="citationOfficerRank" class="floating-label">Officer Rank</label>
                                    </div>

                                    <div class="form-field-group">
                                        <input type="text" id="citationOfficerSignature" required class="modern-input" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                        <label for="citationOfficerSignature" class="floating-label">RP Name (Signature)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-8 rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl">
                                <h3 class="font-bold text-xl mb-6 flex items-center text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-3">
                                    <i class="ph-duotone ph-ticket text-green-600 dark:text-green-400 mr-3 text-2xl"></i>
                                    Fines & Violation Codes
                                </h3>
                                <div id="penalCodeInputsContainer" class="space-y-4">
                                    <div class="penal-code-group" data-group-id="0">
                                        <div class="relative form-field-group !mt-0">
                                            <input type="text" id="penalCode_0" class="modern-input penal-code-input" autocomplete="off" value="" onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')" />
                                            <label for="penalCode_0" class="floating-label">Penal Code</label>
                                            <div id="penalCodeSuggestions_0" class="autocomplete-suggestions hidden"></div>
                                        </div>
                                        <div class="form-field-group !mt-0">
                                            <input type="number" id="amountDue_0" step="0.01" min="0" value="0.00" class="modern-input amount-due-input" readonly>
                                            <label for="amountDue_0" class="floating-label">Amount Due</label>
                                        </div>
                                        <button type="button" class="self-end p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg remove-code-btn hidden" onclick="this.closest('.penal-code-group').remove(); updateCitationTotals();">
                                            <i class="ph-duotone ph-trash text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-4 mt-8">
                                    <button type="button" id="addPenalCodeBtn" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-md flex items-center gap-2">
                                        <i class="ph-bold ph-plus-circle text-lg"></i> Add Code
                                    </button>
                                    <button type="button" onclick="showPenalCodeModal()" class="px-6 py-2.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shadow-sm">View Penal Codes</button>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10 pt-6 border-t border-slate-100 dark:border-slate-700">
                                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl shadow-inner">
                                        <p class="mb-2 font-bold text-lg text-slate-900 dark:text-white">TOTAL FINE</p>
                                        <input type="text" id="totalAmountDueSum" class="w-full text-right font-black text-3xl bg-emerald-100 dark:bg-emerald-900/30 border-none text-emerald-700 dark:text-emerald-400 rounded-xl px-4 py-2 transition-all" value="$0.00" readonly>
                                    </div>
                                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl shadow-inner">
                                        <p class="mb-1 font-bold text-lg text-slate-900 dark:text-white">VIOLATION TYPE(S)</p>
                                        <input type="text" id="violationType" required class="w-full text-right font-extrabold text-lg bg-transparent border-none text-slate-700 dark:text-slate-300" placeholder="Auto-filled from Code(s)" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-8 rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-xl">
                                <h3 class="font-bold text-xl mb-6 flex items-center text-slate-900 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-3">
                                    <i class="ph-duotone ph-notebook text-purple-600 dark:text-purple-400 mr-3 text-2xl"></i>
                                    Narrative & Signature
                                </h3>
                                
                                <div class="mb-6 form-field-group">
                                    <label class="block mb-2 font-medium text-slate-700 dark:text-slate-300 text-sm">Violation Narrative</label>
                                    <textarea id="violationDetails" placeholder="Provide detailed narrative (location, time, sequence of events)..." class="w-full modern-input-textarea transition-colors"></textarea>
                                </div>
                                
                                <label class="block mb-3 font-bold text-md text-slate-900 dark:text-white">Violator Signed?</label>
                                <div class="radio-container text-slate-700 dark:text-slate-300">
                                    <input type="radio" id="signedYes" name="signedStatus" value="YES" checked><label for="signedYes">YES</label>
                                    <input type="radio" id="signedNo" name="signedStatus" value="NO"><label for="signedNo">NO</label>
                                </div>
                                
                                <div id="notSignedReasonContainer" class="mt-4 hidden p-4 border border-rose-200 dark:border-rose-900/50 rounded-lg bg-rose-50 dark:bg-rose-950/50">
                                    <div class="form-field-group !mt-0">
                                        <label class="block mb-2 font-medium text-rose-800 dark:text-rose-300 text-sm">Override Reason</label>
                                        <textarea id="notSignedReason" placeholder="Explain why the violator didn't sign." class="w-full modern-input-textarea transition-colors"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap justify-center gap-4 pt-4">
                                <button type="submit" class="px-10 py-3.5 bg-blue-600 text-white rounded-xl font-semibold text-lg hover:bg-blue-700 transition-colors shadow-xl transform active:scale-[0.98]">Submit Citation</button>
                                <button type="button" id="clearCitationFormBtn" class="px-10 py-3.5 bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-xl font-semibold hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors shadow-md">Clear Form</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="view-registry" class="page-view hidden">
                     <div class="max-w-5xl mx-auto">
                        <button onclick="router('home')" class="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:hover:text-white transition-colors text-sm font-medium">
                            <i class="ph-duotone ph-arrow-left"></i> Back to Dashboard
                        </button>
                        
                        <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Vehicle Registry</h2>
                                <p class="text-slate-500 mt-2">Search database for vehicle or trailer registration.</p>
                            </div>
                            
                            <div class="flex flex-col md:flex-row gap-4 items-end w-full border-b border-slate-100 dark:border-slate-800 pb-8">
                                
                                <div class="form-field-group !mt-0 flex-1 min-w-[120px] w-full">
                                    <input type="text" 
                                           id="reg-search-plate" 
                                           name="search_plate_no_fill" 
                                           autocomplete="off" 
                                           class="modern-input w-full uppercase font-mono text-lg" 
                                           value="" 
                                           placeholder="" 
                                           oninput="this.value = this.value.toUpperCase()" 
                                           onfocus="this.classList.add('filled')" 
                                           onblur="if(this.value === '') this.classList.remove('filled')">
                                    <label for="reg-search-plate" class="floating-label">License Plate</label>
                                </div>
                                
                                <div class="custom-dropdown-container form-field-group !mt-0 w-full md:w-[220px] shrink-0 relative">
                                    <input type="text" id="reg-search-state" class="modern-input font-mono" autocomplete="off" placeholder=" " oninput="this.value = this.value.toUpperCase()">
                                    <label for="reg-search-state" class="floating-label">State (Code)</label>
                                    <div id="reg-state-results" class="dropdown-results"></div>
                                </div>
                            
                                <button onclick="lookupPlate()" class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all active:scale-95 shrink-0">
                                    Search
                                </button>
                            </div>

                            <div id="registry-result" class="mt-8 hidden animate-fade-in-up w-full">
                            </div>
                        </div>
                    </div>
                </div>

               

                <div id="view-moderation" class="page-view hidden">
                     <div class="max-w-7xl mx-auto space-y-6 pb-12">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-3">
                                <button onclick="router('home')" class="p-2 text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">
                                    <i class="ph-bold ph-arrow-left text-xl"></i>
                                </button>
                                <h2 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">Moderation Queue</h2>
                            </div>
                            
                            <div class="flex items-center gap-3 w-full md:w-auto">
                                <button id="launchQueueBtn" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/20 transition-all transform active:scale-95">
                                    <i class="ph-duotone ph-play-circle text-xl"></i>
                                    <span>Start Review</span>
                                    <span id="queueBadge" class="bg-white text-emerald-700 text-xs font-extrabold px-2 py-0.5 rounded-full">0</span>
                                </button>
                                <button onclick="refreshModeration()" class="p-3 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 transition-colors shadow-sm">
                                    <i class="ph-duotone ph-arrows-clockwise text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <div class="bg-white dark:bg-slate-900 rounded-2xl p-5 border border-slate-200 dark:border-slate-800 shadow-sm">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-2">
                                    <i class="ph-duotone ph-faders text-purple-500"></i> Filters
                                </h3>
                                <div>
                                    <div class="form-field-group">
                                        <input type="text" id="modFilterUser" class="modern-input" placeholder="" onkeyup="applyModFilters()">
                                        <label for="modFilterUser" class="floating-label">Submitted By (User)</label>
                                    </div>
                                    <div class="form-field-group">
                                        <input type="text" id="modFilterTarget" class="modern-input" placeholder="" onkeyup="applyModFilters()">
                                        <label for="modFilterTarget" class="floating-label">Violator / Suspect Name</label>
                                    </div>
                                    <div class="form-field-group">
                                        <input type="date" id="modFilterStart" class="modern-input" onchange="applyModFilters()">
                                        <label for="modFilterStart" class="floating-label">Date</label>
                                    </div>
                                    <div class="flex justify-end pt-4">
                                        <button onclick="clearModFilters()" class="text-xs font-bold text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">Reset Filters</button>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden flex flex-col">
                                <div class="p-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                                    <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <i class="ph-duotone ph-chart-bar text-blue-500"></i> Activity Stats
                                    </h3>
                                </div>
                                <div class="overflow-x-auto overflow-y-auto max-h-[250px]"> <table class="w-full text-left text-sm">
                                        <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">User</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-center">Unpaid Citations</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-center">Unpaid Arrests</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-center">Paid Citations</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-center">Paid Arrests</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-center">Total</th>
                                        </tr>
                                        </thead>
                                        <tbody id="modStatsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex flex-wrap gap-4 justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-ticket text-blue-500"></i> Manage Citations
                                    <span id="mod-count-citations" class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs px-2 py-0.5 rounded-full">0</span>
                                </h3>
                            </div>
                            <div class="overflow-x-auto max-h-[400px] overflow-y-auto"> 
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">ID</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Date</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Violator</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Amount</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Status</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Proof</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modCitationsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex flex-wrap gap-4 justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-handcuffs text-rose-500"></i> Manage Arrests
                                    <span id="mod-count-arrests" class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs px-2 py-0.5 rounded-full">0</span>
                                </h3>
                            </div>
                            <div class="overflow-x-auto max-h-[400px] overflow-y-auto"> 
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">ID</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Date</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Suspect</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Fines</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Status</th>
                                            <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Proof</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modArrestsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                </table>
                            </div>
                        </div>
                     </div>
                </div>

                <div id="view-admin" class="page-view hidden">
                    <div class="max-w-7xl mx-auto space-y-8 pb-12">
                        <!-- Header -->
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-3">
                                <button onclick="router('home')" class="p-2 text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">
                                    <i class="ph-bold ph-arrow-left text-xl"></i>
                                </button>
                                <h2 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">Administration</h2>
                            </div>
                            <button onclick="renderAdminView()" class="p-3 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 transition-all shadow-sm">
                                <i class="ph-duotone ph-arrows-clockwise text-xl"></i>
                            </button>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-broadcast text-rose-500"></i> Citizen Alerts
                                </h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="alertEnabled" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 text-sm font-medium text-slate-900 dark:text-gray-300">Active</span>
                                </label>
                            </div>
                            
                            <div class="p-6">
                                <form onsubmit="submitSystemAlert(event)" class="flex flex-col md:flex-row gap-6 items-end">
                                    <div class="form-field-group !mt-0 w-full md:w-1/4">
                                        <select id="alertType" class="modern-input cursor-pointer">
                                            <option value="info">Info (Blue)</option>
                                            <option value="warning">Warning (Yellow)</option>
                                            <option value="alert">Alert (Red)</option>
                                        </select>
                                        <label for="alertType" class="floating-label">Type</label>
                                    </div>

                                    <div class="form-field-group !mt-0 w-full md:flex-1">
                                        <input type="text" 
                                               id="alertContent" 
                                               class="modern-input placeholder-transparent focus:placeholder-slate-400 dark:focus:placeholder-slate-600" 
                                               placeholder="e.g. Server restart in 10 minutes..." 
                                               required 
                                               onfocus="this.classList.add('filled')" 
                                               onblur="if(this.value === '') this.classList.remove('filled')">
                                        <label for="alertContent" class="floating-label">Message Content</label>
                                    </div>

                                    <button type="submit" id="alertSubmitBtn" class="w-full md:w-auto px-6 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold hover:opacity-90 transition-opacity shadow-lg flex items-center justify-center gap-2">
                                        <i class="ph-bold ph-paper-plane-right"></i> Send
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- 1. USER MANAGEMENT -->
                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-users text-blue-500"></i> Users 
                                    <span id="count-users" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                </h3>
                                <input type="text" id="search-users" onkeyup="filterAdminTable('users')" placeholder="Search users..." class="modern-input w-full md:w-64 !py-1 !text-sm">
                            </div>
                            <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold w-16">ID</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Username</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Badge</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Shifts</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Role</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminUsersBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 2. SHIFT LOGS (NEW) -->
                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-clock text-emerald-500"></i> Shift Logs
                                    <span id="count-shifts" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                </h3>
                                <div class="flex items-center gap-2 w-full md:w-auto">
                                     <button onclick="adminBulkShiftAction('accept')" class="px-4 py-2 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-900/50 text-emerald-600 dark:text-emerald-400 rounded-lg text-sm font-semibold hover:bg-emerald-100 transition-all flex items-center gap-2">
                                        <i class="ph-bold ph-check"></i> Accept
                                     </button>
                                     <button onclick="adminBulkShiftAction('deny')" class="px-4 py-2 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-900/50 text-rose-600 dark:text-rose-400 rounded-lg text-sm font-semibold hover:bg-rose-100 transition-all flex items-center gap-2">
                                         <i class="ph-bold ph-x"></i> Deny
                                     </button>
                                    <input type="text" id="search-shifts" onkeyup="filterAdminTable('shifts')" placeholder="Search shifts..." class="modern-input w-full md:w-64 !py-1 !text-sm">
                                </div>
                            </div>
                            <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <thead>
                                        <tr>
                                            <th class="py-3 px-4 text-center w-10">
                                                <label class="relative flex items-center justify-center cursor-pointer group">
                                                    <input type="checkbox" onchange="toggleSelectAll(this, 'adminShiftsBody')" class="peer sr-only">
                                                    <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                                                    <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                                                </label>
                                            </th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Date</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Officer</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Duration</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Activity</th>
                                            <th class="py-3 px-6 text-center text-slate-500 dark:text-slate-400 font-semibold">Proof</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    </thead>
                                    <tbody id="adminShiftsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 3. CITATIONS & ARRESTS (GRID) -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- CITATIONS -->
                            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                                <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                                    <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <i class="ph-duotone ph-ticket text-blue-500"></i> Citations
                                        <span id="admin-count-citations" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                    </h3>
                                    <div class="flex items-center gap-2 w-full md:w-auto">
                                        <button onclick="performBulkDelete('/admin/citations', 'adminCitationsBody', 'Citation')" class="px-4 py-2 bg-white dark:bg-slate-800 border border-rose-200 dark:border-rose-900/50 text-rose-600 dark:text-rose-400 rounded-lg text-sm font-semibold hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all flex items-center gap-2 whitespace-nowrap">
                                            <i class="ph-bold ph-trash"></i> Delete Selected
                                        </button>
                                        <input type="text" id="search-citations" onkeyup="filterAdminTable('citations')" placeholder="Search..." class="modern-input w-full !py-1 !text-sm">
                                    </div>
                                </div>
                                <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead>
                                            <tr>
                                                <th class="py-3 px-4 text-center w-10">
                                                    <label class="relative flex items-center justify-center cursor-pointer group">
                                                        <input type="checkbox" onchange="toggleSelectAll(this, 'adminCitationsBody')" class="peer sr-only">
                                                        <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                                                        <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                                                    </label>
                                                </th>
                                                <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Violator</th>
                                                <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Issued By</th>
                                                <th class="py-3 px-4 text-right text-slate-500 dark:text-slate-400 font-semibold">Amount</th>
                                                <th class="py-3 px-4 text-right text-slate-500 dark:text-slate-400 font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminCitationsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- ARRESTS -->
                            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                                <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                                    <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <i class="ph-duotone ph-handcuffs text-rose-500"></i> Arrests
                                        <span id="admin-count-arrests" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                    </h3>
                                    <div class="flex items-center gap-2 w-full md:w-auto">
                                        <button onclick="performBulkDelete('/admin/arrests', 'adminArrestsBody', 'Arrest')" class="px-4 py-2 bg-white dark:bg-slate-800 border border-rose-200 dark:border-rose-900/50 text-rose-600 dark:text-rose-400 rounded-lg text-sm font-semibold hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all flex items-center gap-2 whitespace-nowrap">
                                            <i class="ph-bold ph-trash"></i> Delete Selected
                                        </button>
                                        <input type="text" id="search-arrests" onkeyup="filterAdminTable('arrests')" placeholder="Search..." class="modern-input w-full !py-1 !text-sm">
                                    </div>
                                </div>
                                <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead>
                                            <tr>
                                                <th class="py-3 px-4 text-center w-10">
                                                    <label class="relative flex items-center justify-center cursor-pointer group">
                                                        <input type="checkbox" onchange="toggleSelectAll(this, 'adminArrestsBody')" class="peer sr-only">
                                                        <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                                                        <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                                                    </label>
                                                </th>
                                                <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Suspect</th>
                                                <th class="py-3 px-4 text-slate-500 dark:text-slate-400 font-semibold">Officer</th>
                                                <th class="py-3 px-4 text-right text-slate-500 dark:text-slate-400 font-semibold">Sentence</th>
                                                <th class="py-3 px-4 text-right text-slate-500 dark:text-slate-400 font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminArrestsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- 4. WARRANT LOGS (NEW) -->
                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-file-warning text-amber-500"></i> Warrants
                                    <span id="count-warrants" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                </h3>
                                <div class="flex items-center gap-2 w-full md:w-auto">
                                    <button onclick="performBulkDelete('/admin/warrant_logs', 'adminWarrantsBody', 'Warrant')" class="px-4 py-2 bg-white dark:bg-slate-800 border border-rose-200 dark:border-rose-900/50 text-rose-600 dark:text-rose-400 rounded-lg text-sm font-semibold hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="ph-bold ph-trash"></i> Delete Selected
                                    </button>
                                    <input type="text" id="search-warrants" onkeyup="filterAdminTable('warrants')" placeholder="Search warrants..." class="modern-input w-full md:w-64 !py-1 !text-sm">
                                </div>
                            </div>
                            <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-4 text-center w-10">
                                                <label class="relative flex items-center justify-center cursor-pointer group">
                                                    <input type="checkbox" onchange="toggleSelectAll(this, 'adminWarrantsBody')" class="peer sr-only">
                                                    <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                                                    <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                                                </label>
                                            </th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Target</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Issued By</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Date</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Notes</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminWarrantsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                    </table>
                            </div>
                        </div>

                        <!-- 5. PENAL CODES & REGISTRATIONS -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                                <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-900 dark:text-white">Penal Codes</h3>
                                    <span id="count-pc" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                </div>
                                <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-left">Code</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-left">Desc</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-left">Fine</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-right w-24">Actions</th> </tr>
                                        </thead>
                                        <tbody id="adminPCBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                                <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-900 dark:text-white">Registrations</h3>
                                    <span id="count-reg" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                </div>
                                <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                            <tr>
                                                <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Plate</th>
                                                <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Owner</th>
                                                <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Vehicle</th>
                                                <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Ban</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminRegBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden mb-8">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center gap-4">
                                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i class="ph-duotone ph-arrows-left-right text-purple-500"></i> Transfer Requests
                                    <span id="count-transfers" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-0.5 rounded-full">0</span>
                                </h3>
                                <button onclick="loadAdminTransfers()" class="text-sm text-blue-500 hover:underline">Refresh</button>
                            </div>
                            <div class="overflow-x-auto max-h-[300px] overflow-y-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">User</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Current</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Requested</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold">Reason</th>
                                            <th class="py-3 px-6 text-slate-500 dark:text-slate-400 font-semibold text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminTransfersBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                </div> 
        </main>
    </div>
                <div id="historyModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-5xl w-full border border-slate-200 dark:border-slate-800 flex flex-col max-h-[90vh] overflow-hidden modal-content">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-white dark:border-slate-600 shadow-sm">
                        <img id="historyAvatar" src="" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h3 id="historyName" class="text-xl font-extrabold text-slate-900 dark:text-white tracking-tight">Loading...</h3>
                        <p id="historyId" class="text-xs font-mono text-slate-500 dark:text-slate-400">ID: ---</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-xs text-slate-500 uppercase font-bold tracking-wider">Outstanding Fines</span>
                    <span id="historyFines" class="text-2xl font-black text-rose-600 dark:text-rose-400">$0.00</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8 bg-[#f8fafc] dark:bg-[#020617]">
                <div id="historyWarrantsSection" class="hidden">
                    <h4 class="text-sm font-bold text-rose-600 dark:text-rose-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-warning-circle"></i> Active Warrants
                    </h4>
                    <div id="historyWarrantsList" class="grid grid-cols-1 gap-3"></div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-handcuffs"></i> Arrest Record
                    </h4>
                    <div id="historyArrestsList" class="space-y-2"></div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-ticket"></i> Citations
                    </h4>
                    <div id="historyCitationsList" class="space-y-2"></div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-car"></i> Registered Vehicles
                    </h4>
                    <div id="historyVehiclesList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 flex justify-end">
                <button onclick="toggleModal('historyModalOverlay', false)" class="px-6 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    Close Record
                </button>
            </div>
        </div>
    </div>
    <div id="detailsModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-2xl w-full border border-slate-200 dark:border-slate-800 flex flex-col max-h-[90vh] modal-content">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 id="detailsModalTitle" class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    </h3>
                <button onclick="toggleModal('detailsModalOverlay', false)" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div id="detailsModalContent" class="p-6 overflow-y-auto space-y-6">
                </div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-800 flex justify-end">
                <button onclick="toggleModal('detailsModalOverlay', false)" class="px-6 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700">Close</button>
            </div>
        </div>
    </div>

    <div id="pcEditorModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-md w-full border border-slate-200 dark:border-slate-800 modal-content">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                <h3 id="pcEditorTitle" class="text-xl font-bold text-slate-900 dark:text-white">Edit Penal Code</h3>
            </div>
            <form onsubmit="submitPenalCodeForm(event)" class="p-6 space-y-5">
                <input type="hidden" id="pcEditId" value="">
                
                <div class="form-field-group !mt-0">
                    <input type="text" id="pcEditCode" class="modern-input" required placeholder=" " onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                    <label for="pcEditCode" class="floating-label">Code (e.g. PC 187)</label>
                </div>

                <div class="form-field-group">
                    <input type="text" id="pcEditTitle" class="modern-input" required placeholder=" " onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                    <label for="pcEditTitle" class="floating-label">Description / Title</label>
                </div>

                <div class="form-field-group">
                    <select id="pcEditType" class="modern-input cursor-pointer">
                        <option value="Infraction">Infraction</option>
                        <option value="Misdemeanor">Misdemeanor</option>
                        <option value="Felony">Felony</option>
                    </select>
                    <label for="pcEditType" class="floating-label">Classification</label>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-field-group !mt-0">
                        <input type="number" id="pcEditFine" step="0.01" class="modern-input" required placeholder=" " onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                        <label for="pcEditFine" class="floating-label">Fine ($)</label>
                    </div>
                    <div class="form-field-group !mt-0">
                        <input type="number" id="pcEditJail" class="modern-input" required placeholder=" " onfocus="this.classList.add('filled')" onblur="if(this.value === '') this.classList.remove('filled')">
                        <label for="pcEditJail" class="floating-label">Jail (Sec)</label>
                    </div>
                </div>

                <div class="pt-2 flex justify-end gap-3">
                    <button type="button" onclick="toggleModal('pcEditorModalOverlay', false)" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30">Save Code</button>
                </div>
            </form>
        </div>
    </div>

    <div id="createUserModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-lg w-full border border-slate-200 dark:border-slate-800 modal-content">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <i class="ph-duotone ph-user-plus text-blue-500"></i> Create User
                </h3>
            </div>
            <form onsubmit="submitCreateUserForm(event)" class="p-6">
                <div class="form-field-group mb-6">
                    <input type="text" id="newUsername" class="modern-input" required placeholder=" " autocomplete="off">
                    <label for="newUsername" class="floating-label">Username</label>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Assign Roles</label>
                    <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="officer" checked class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                            <span class="text-sm font-medium">Officer</span>
                        </label>
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="junior_moderator" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                            <span class="text-sm font-medium">Jr. Moderator</span>
                        </label>
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="moderator" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                            <span class="text-sm font-medium">Moderator</span>
                        </label>
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="senior_moderator" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                            <span class="text-sm font-medium">Sr. Moderator</span>
                        </label>
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="admin" class="w-4 h-4 text-rose-600 rounded focus:ring-rose-500 border-gray-300">
                            <span class="text-sm font-medium">Admin</span>
                        </label>
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="manager" class="w-4 h-4 text-amber-600 rounded focus:ring-amber-500 border-gray-300">
                            <span class="text-sm font-medium">Manager</span>
                        </label>
                        <label class="role-checkbox-label">
                            <input type="checkbox" name="newRoles" value="developer" class="w-4 h-4 text-cyan-600 rounded focus:ring-cyan-500 border-gray-300">
                            <span class="text-sm font-medium">Developer</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="form-field-group !mt-0">
                        <input type="text" id="newBadge" class="modern-input" placeholder=" " autocomplete="off">
                        <label for="newBadge" class="floating-label">Badge Number</label>
                    </div>
                    
                    <div class="form-field-group !mt-0">
                        <select id="newDept" class="modern-input cursor-pointer">
                            <option value="" disabled selected></option>
                            <option value="Wisconsin State Patrol">Wisconsin State Patrol</option>
                            <option value="Outagamie County Sheriff's Office">Outagamie County Sheriff's Office</option>
                            <option value="Fox Valley Metro Police Department">Fox Valley Metro Police Department</option>
                            <option value="N/A" disabled id="deptOptionNA">N/A (Staff Only)</option>
                        </select>
                        <label for="newDept" class="floating-label">Department</label>
                    </div>
                </div>

                <div class="pt-2 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-800">
                    <button type="button" onclick="toggleModal('createUserModalOverlay', false)" class="mt-4 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold transition-colors">Cancel</button>
                    <button type="submit" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editRoleModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-200 dark:border-slate-800 modal-content">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Edit User Roles</h3>
            </div>
            <form onsubmit="submitEditRoleForm(event)" class="p-6">
                <input type="hidden" id="editRoleUserId">
                
                <p class="text-sm text-slate-500 mb-4">Select all roles that apply to this user.</p>

                <div class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                    <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="officer" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Officer</span>
                    </label>
                    <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="junior_moderator" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Junior Moderator</span>
                    </label>
                    <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="moderator" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Moderator</span>
                    </label>
                    <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="senior_moderator" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Senior Moderator</span>
                    </label>
                    <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="admin" class="w-5 h-5 text-rose-600 rounded focus:ring-rose-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Admin</span>
                    </label>
                     <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="manager" class="w-5 h-5 text-amber-600 rounded focus:ring-amber-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Manager</span>
                    </label>
                     <label class="role-checkbox-label">
                        <input type="checkbox" name="editRoles" value="developer" class="w-5 h-5 text-cyan-600 rounded focus:ring-cyan-500 border-gray-300">
                        <span class="font-medium text-slate-700 dark:text-slate-200">Developer</span>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="toggleModal('editRoleModalOverlay', false)" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all">Save Roles</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customConfirmOverlay" class="hidden fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 max-w-sm w-full border border-slate-200 dark:border-slate-800 modal-content">
            <h3 id="confTitle" class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Confirm</h3>
            <p id="confMessage" class="text-slate-600 dark:text-slate-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confCancelBtn" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold transition-colors">Cancel</button>
                <button id="confOkBtn" class="px-4 py-2 bg-rose-600 text-white rounded-xl font-bold hover:bg-rose-700 transition-colors shadow-lg shadow-rose-500/30">Confirm</button>
            </div>
        </div>
    </div>

    <div id="customPromptOverlay" class="hidden fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 max-w-sm w-full border border-slate-200 dark:border-slate-800 modal-content">
            <h3 id="promptTitle" class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Input</h3>
            <p id="promptMessage" class="text-slate-600 dark:text-slate-300 mb-4 text-sm"></p>
            <input type="text" id="promptInput" class="modern-input mb-6" placeholder=" " autocomplete="off">
            <div class="flex justify-end gap-3">
                <button id="promptCancelBtn" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold transition-colors">Cancel</button>
                <button id="promptOkBtn" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30">OK</button>
            </div>
        </div>
    </div>

    <div id="customSelectOverlay" class="hidden fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 max-w-sm w-full border border-slate-200 dark:border-slate-800 modal-content">
            <h3 id="selectTitle" class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Select</h3>
            <p id="selectMessage" class="text-slate-600 dark:text-slate-300 mb-4 text-sm"></p>
            <div class="form-field-group mb-6">
                <select id="selectInput" class="modern-input cursor-pointer"></select>
            </div>
            <div class="flex justify-end gap-3">
                <button id="selectCancelBtn" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold transition-colors">Cancel</button>
                <button id="selectOkBtn" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30">OK</button>
            </div>
        </div>
    </div>
    <div id="proofModalOverlay" class="hidden fixed inset-0 z-[120] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay" onclick="toggleModal('proofModalOverlay', false)">
        <div class="relative max-w-5xl w-full max-h-[90vh] flex flex-col items-center justify-center">
            <button onclick="toggleModal('proofModalOverlay', false)" class="absolute -top-12 right-0 text-white/70 hover:text-white transition-colors p-2">
                <i class="ph-bold ph-x text-3xl"></i>
            </button>
            
            <img id="proofModalImage" src="" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain bg-black border border-white/10" onclick="event.stopPropagation()">
            
            <a id="proofModalLink" href="#" target="_blank" class="mt-4 text-white/50 hover:text-white text-xs flex items-center gap-2 transition-colors" onclick="event.stopPropagation()">
                <i class="ph-bold ph-arrow-square-out"></i> Open Original
            </a>
        </div>
    </div>
    <div id="quotaModalOverlay" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-md w-full border border-slate-200 dark:border-slate-800 modal-content">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <i class="ph-duotone ph-chart-pie-slice text-indigo-500"></i> Monthly Officer Quota
                </h3>
            </div>
            <div class="p-6 space-y-6">
                <div class="custom-dropdown-container form-field-group !mt-0 relative">
                    <input type="text" id="quotaSearchInput" class="modern-input" autocomplete="off" placeholder=" " />
                    <label for="quotaSearchInput" class="floating-label">Search Officer (Name or Badge)</label>
                    <div id="quotaSearchResults" class="dropdown-results"></div>
                </div>

                <div id="quotaStatsContainer" class="hidden space-y-4 animate-fade-in-up">
                    <div class="flex items-center gap-4 mb-4 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div class="w-12 h-12 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-white dark:border-slate-600 shadow-sm">
                            <img id="quotaAvatar" src="" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h4 id="quotaName" class="font-bold text-slate-900 dark:text-white text-lg">Officer Name</h4>
                            <p id="quotaBadge" class="text-xs text-slate-500 font-mono">Badge: ---</p>
                            <p class="text-[10px] text-indigo-500 font-bold uppercase tracking-wider mt-0.5">Current Month Stats</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-900/30 text-center">
                            <div class="text-xs text-blue-500 uppercase font-bold tracking-wider mb-1">Citations</div>
                            <div id="quotaCitations" class="text-3xl font-black text-blue-600 dark:text-blue-400">0</div>
                        </div>
                        <div class="p-4 bg-rose-50 dark:bg-rose-900/20 rounded-xl border border-rose-100 dark:border-rose-900/30 text-center">
                            <div class="text-xs text-rose-500 uppercase font-bold tracking-wider mb-1">Arrests</div>
                            <div id="quotaArrests" class="text-3xl font-black text-rose-600 dark:text-rose-400">0</div>
                        </div>
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-100 dark:border-amber-900/30 text-center">
                            <div class="text-xs text-amber-500 uppercase font-bold tracking-wider mb-1">Warrants</div>
                            <div id="quotaWarrants" class="text-3xl font-black text-amber-600 dark:text-amber-400">0</div>
                        </div>
                        <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-900/30 text-center relative overflow-hidden">
                            <div class="text-xs text-emerald-500 uppercase font-bold tracking-wider mb-1">Valid Shifts</div>
                            <div id="quotaShifts" class="text-3xl font-black text-emerald-600 dark:text-emerald-400">0</div>
                            <div class="absolute bottom-1 w-full text-[9px] text-emerald-600/50 dark:text-emerald-400/50 font-bold uppercase text-center left-0">Over 30 Mins</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-800 flex justify-end">
                <button onclick="toggleModal('quotaModalOverlay', false)" class="px-6 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Close</button>
            </div>
        </div>
    </div>
    

<div id="endShiftModalOverlay" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 modal-overlay">
    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-md w-full border border-slate-200 dark:border-slate-800 modal-content">
        <div class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                <i class="ph-duotone ph-file-arrow-up text-rose-500"></i> End Shift Report
            </h3>
        </div>
        <form onsubmit="submitEndShift(event)" class="p-6 space-y-5">
            
            <div class="grid grid-cols-3 gap-4">
                <div class="form-field-group !mt-0">
                    <input type="number" id="endShiftStops" class="modern-input text-center font-bold" value="0" min="0" onfocus="this.classList.add('filled')" onblur="if(this.value !== '') this.classList.add('filled')">
                    <label for="endShiftStops" class="floating-label text-xs">Traffic Stops</label>
                </div>
                <div class="form-field-group !mt-0">
                    <input type="number" id="endShiftCitations" class="modern-input text-center font-bold" value="0" min="0" onfocus="this.classList.add('filled')" onblur="if(this.value !== '') this.classList.add('filled')">
                    <label for="endShiftCitations" class="floating-label text-xs">Citations</label>
                </div>
                <div class="form-field-group !mt-0">
                    <input type="number" id="endShiftArrests" class="modern-input text-center font-bold" value="0" min="0" onfocus="this.classList.add('filled')" onblur="if(this.value !== '') this.classList.add('filled')">
                    <label for="endShiftArrests" class="floating-label text-xs">Arrests</label>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Shift Notes</label>
                <textarea id="endShiftNotes" class="modern-input min-h-[80px]" placeholder="Summary of patrol, major incidents, etc..."></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Proof Screenshot (Required)</label>
                <div class="relative group cursor-pointer">
                    <input type="file" id="endShiftImage" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewEndShiftImage(this)">
                    <div id="endShiftDropZone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center transition-all group-hover:border-blue-500 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20">
                        <div id="endShiftPreviewContent">
                            <i class="ph-duotone ph-image text-4xl text-slate-400 mb-2"></i>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Click to upload or <span class="text-blue-500 font-bold">Paste (Ctrl+V)</span></p>
                        </div>
                        <img id="endShiftPreviewImg" class="hidden max-h-40 mx-auto rounded-lg shadow-md object-cover" />
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-800">
                <button type="button" onclick="toggleModal('endShiftModalOverlay', false)" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-rose-600 text-white rounded-xl font-bold hover:bg-rose-700 shadow-lg shadow-rose-500/30">Submit Log</button>
            </div>
        </form>
    </div>
</div>
    <script>
        // API CONFIGURATION
        const API_BASE_URL = 'https://api.shadowle.com'; 

        // STATE MANAGEMENT
        let appState = {
            penalCodes: [],
            citations: [],
            arrests: [],
            shiftLogs: [],
            users: [],
            registrations: [],
            stats: {}
        };
        
        // Cache to store Roblox Avatars to avoid repeated API calls
        const robloxAvatarCache = new Map();
        
        let activeReviewItem = null;
        let activeLeaderboardTab = 'citation';
        let mugshotDataURL = null; 
        let shiftScreenshotDataURL = null; 

        // --- NEW: Floating Label Event Binding ---
        function bindFloatingLabels() {
            document.querySelectorAll('.modern-input').forEach(input => {
                const hasValue = input.value !== '' && input.value !== '0';
                
                if (input.hasAttribute('readonly') || input.hasAttribute('disabled')) {
                    input.classList.add('filled');
                } else if (hasValue) {
                    input.classList.add('filled');
                } else {
                    input.classList.remove('filled');
                }

                input.addEventListener('input', (e) => {
                    const value = e.target.type === 'number' ? e.target.value.toString() : e.target.value;
                    if (value !== '' && value !== '0') {
                        e.target.classList.add('filled');
                    } else {
                        e.target.classList.remove('filled');
                    }
                });

                input.addEventListener('change', (e) => {
                    if (e.target.value !== '' && e.target.value !== '0') {
                        e.target.classList.add('filled');
                    } else {
                        e.target.classList.remove('filled');
                    }
                });
            });
        }

        // --- CUSTOM ALERT/CONFIRM HANDLER ---
        function customAlert(message, title = 'Alert') {
            return new Promise(resolve => {
                const modalId = 'customModalOverlay';
                document.getElementById('customModalTitle').innerText = title;
                document.getElementById('customModalMessage').innerText = message;
                document.getElementById('customModalCancelBtn').classList.add('hidden');
                const okBtn = document.getElementById('customModalOkBtn');
                
                const handler = () => {
                    toggleModal(modalId, false); // Fix: Smooth close
                    okBtn.removeEventListener('click', handler);
                    resolve(true);
                };

                okBtn.onclick = handler;
                toggleModal(modalId, true); // Fix: Smooth open
            });
        }

        // --- IMAGE TO BASE64 UTILITY ---
        function handleImage(file, previewDiv, dataUrlStore) {
            if (!file || !file.type.startsWith('image/')) {
                previewDiv.innerHTML = '<p class="text-slate-400 text-sm">No image selected</p>';
                if (previewDiv.id === 'mugshotPreview') mugshotDataURL = null;
                else if (previewDiv.id === 'imagePreview') shiftScreenshotDataURL = null;
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                previewDiv.innerHTML = `<img src="${e.target.result}" class="max-h-48 rounded mx-auto" />`;
                if (previewDiv.id === 'mugshotPreview') mugshotDataURL = e.target.result;
                else if (previewDiv.id === 'imagePreview') shiftScreenshotDataURL = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // --- HELPER: GET BAN LEVEL BADGE ---
        function getBanBadgeHTML(level) {
            const lvl = parseInt(level || 0);
            let text = "";
            let classes = "";

            switch (lvl) {
                case 0:
                    text = "0 (None)";
                    classes = "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400";
                    break;
                case 1:
                    text = "1 (Basic+)";
                    classes = "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400";
                    break;
                case 2:
                    text = "2 (Standard+)";
                    classes = "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400";
                    break;
                case 3:
                    text = "3 (Premium+)";
                    classes = "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
                    break;
                case 4:
                    text = "4 (Prestige+)";
                    classes = "bg-rose-900 text-rose-100 dark:bg-rose-950 dark:text-rose-300 border border-rose-500/30";
                    break;
                default:
                    text = `Lvl ${lvl}`;
                    classes = "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-400";
            }

            return `<span class="${classes} px-3 py-1 rounded-full text-xs font-bold uppercase whitespace-nowrap min-w-[80px] text-center inline-block">${text}</span>`;
        }

        // --- API HELPER (Updated to handle 409 Conflict) ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const token = sessionStorage.getItem('authToken');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const config = {
                method,
                headers
            };

            if (body) config.body = JSON.stringify(body);

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : await response.text();

                // 1. Handle Token Expiry (401)
                if (response.status === 401 && endpoint !== '/login') {
                    customAlert('Your session has expired. Please log in again.', 'Session Expired');
                    logout();
                    return null;
                }

                // 2. Handle Permission Denied (403)
                if (response.status === 403) {
                    await customAlert('Access Denied: You do not have permission to perform this action.', 'Forbidden');
                    router('home'); 
                    return null;
                }

                // 3. --- NEW: Handle Duplicate Request (409) ---
                if (response.status === 409) {
                    await customAlert('You already have a pending request. Please wait for it to be reviewed.', 'Request Pending');
                    return null;
                }
                
                if (!response.ok) {
                    const message = isJson && data.message ? data.message : 'API Error';
                    // Optional: Don't show alert for 404s if you handle them elsewhere
                    if (response.status !== 404) customAlert(message, 'Request Failed');
                    throw new Error(message);
                }
                return data;
            } catch (error) {
                console.error('API Request Failed:', error);
                return null;
            }
        }
        
        // --- ROBLOX AVATAR HELPER ---        
        async function fetchRobloxAvatar(username) {
            if (!username) return null;
            
            // Check cache first
            if (typeof robloxAvatarCache !== 'undefined' && robloxAvatarCache.has(username)) {
                return robloxAvatarCache.get(username);
            }

            try {
                // Call YOUR backend worker (which now talks to Roblox for you)
                // We use 'apiRequest' because it handles the Authentication Token automatically
                const data = await apiRequest(`/roblox-avatar?username=${encodeURIComponent(username)}`);
                
                if (data && data.url) {
                    // Save to cache
                    if (typeof robloxAvatarCache !== 'undefined') {
                        robloxAvatarCache.set(username, data.url);
                    }
                    return data.url;
                }
            } catch (e) {
                console.warn(`Failed to fetch Roblox avatar for ${username}:`, e);
            }
            
            // Return null to fall back to the default avatar if something goes wrong
            return null; 
        }
        // --- AUTHENTICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Theme Init
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            
            if (initialTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeButtons(initialTheme); 

            // --- AUTO-LOGIN CHECK ---
            const { token, user } = getActiveSession();
            
            const loginView = document.getElementById('login-view');
            const dashboardView = document.getElementById('dashboard-view');
            const themeToggleHeader = document.getElementById('theme-toggle');
            if(themeToggleHeader) themeToggleHeader.remove();

            if (token && user) {
                // User is remembered! Skip login.
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                dashboardView.classList.add('fade-in');
                
                // --- FIX: HYDRATE SESSION STORAGE ---
                // We must copy the token from LocalStorage to SessionStorage so apiRequest() can find it
                sessionStorage.setItem('authToken', token); 
                sessionStorage.setItem('user', JSON.stringify(user)); 
                // ------------------------------------
                
                initApp();
                
                // Redirect based on role/dept immediately
                const dept = user.dept || "N/A";
                if (user.mustChange) {
                    router('settings');
                } else if (dept === 'N/A' || dept === 'Staff Only') {
                    if (user.role === 'admin') router('admin');
                    else if (user.role === 'moderator') router('moderation');
                    else router('settings');
                } else {
                    router('home');
                }
            }
            // --- CUSTOM TOOLTIP INITIALIZATION ---
        // Create the tooltip element once
        const customTooltip = document.createElement('div');
        customTooltip.id = 'custom-code-tooltip';
        customTooltip.className = 'fixed z-[9999] hidden bg-slate-900/95 backdrop-blur text-white text-xs rounded-lg py-2 px-3 shadow-xl border border-slate-700 pointer-events-none max-w-xs whitespace-normal transition-opacity duration-150';
        document.body.appendChild(customTooltip);

        // Handle Hover Events
        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[data-tooltip-content]');
            if (target) {
                customTooltip.innerHTML = target.getAttribute('data-tooltip-content');
                customTooltip.classList.remove('hidden');
                customTooltip.classList.remove('opacity-0');
            }
        });

        // Handle Movement
        document.addEventListener('mousemove', (e) => {
            if (!customTooltip.classList.contains('hidden')) {
                // Keep tooltip near mouse but onscreen
                let top = e.clientY + 15;
                let left = e.clientX + 15;
                
                // Prevent going off right edge
                if (left + 220 > window.innerWidth) left = e.clientX - 230;
                // Prevent going off bottom edge
                if (top + 100 > window.innerHeight) top = e.clientY - 110;

                customTooltip.style.top = `${top}px`;
                customTooltip.style.left = `${left}px`;
            }
        });

        // Handle Mouse Out
        document.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-tooltip-content]');
            if (target) {
                customTooltip.classList.add('hidden');
                customTooltip.classList.add('opacity-0');
            }
        });

            // --- LOGIN FORM HANDLER ---
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const usernameInput = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;
                const rememberMe = document.getElementById('login-remember').checked;
                const errorDisplay = document.getElementById('login-error');
                errorDisplay.classList.add('hidden');

                const loginBtn = document.getElementById('login-submit-btn');
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="ph-duotone ph-circle-notch animate-spin"></i> <span>Signing In...</span>';

                try {
                    // 1. Authenticate
                    const loginPayload = { username: usernameInput, password: password };
                    const loginData = await apiRequest('/v1/auth/login', 'POST', loginPayload);

                    if (!loginData || !loginData.token) throw new Error(loginData?.message || "Invalid credentials.");

                    // 2. Fetch User Profile
                    const meResponse = await fetch(`${API_BASE_URL}/v1/me`, {
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${loginData.token}` }
                    });

                    if (!meResponse.ok) throw new Error("Failed to load user profile.");
                    const meData = await meResponse.json();
                    const officer = meData.officer;

                    // 3. Process Roles (Handles String or Array)
                    let finalRole = 'civilian';
                    const rawRole = officer.roles || officer.role; 

                    if (typeof rawRole === 'string') {
                        // If it looks like JSON array '["admin"]', parse it. Otherwise use string directly.
                        if (rawRole.startsWith('[') || rawRole.startsWith('{')) {
                             try {
                                const parsed = JSON.parse(rawRole);
                                finalRole = Array.isArray(parsed) ? parsed[0] : parsed;
                             } catch(e) {
                                finalRole = rawRole; 
                             }
                        } else {
                             finalRole = rawRole;
                        }
                    } else if (Array.isArray(rawRole)) {
                        // If it's an array, pick highest rank
                        const hierarchy = ['manager', 'admin', 'developer', 'senior_moderator', 'moderator', 'junior_moderator', 'officer'];
                        for (const hRole of hierarchy) {
                            if (rawRole.includes(hRole)) {
                                finalRole = hRole;
                                break;
                            }
                        }
                        if (finalRole === 'civilian' && rawRole.length > 0) finalRole = rawRole[0];
                    }

                    // 4. Save Session
                    const userData = {
                        username: officer.username || 'Unknown',
                        badge: officer.badge_number || '0',
                        role: finalRole,
                        dept: officer.department || 'Unassigned',
                        id: officer.id || officer.rowid,
                        mustChange: loginData.needs_initial_setup || false
                    };

                    if (rememberMe) {
                        localStorage.setItem('authToken', loginData.token);
                        localStorage.setItem('user', JSON.stringify(userData));
                    }
                    sessionStorage.setItem('authToken', loginData.token);
                    sessionStorage.setItem('user', JSON.stringify(userData));

                    // 5. Redirect
                    loginView.style.transition = 'opacity 0.5s ease';
                    loginView.style.opacity = '0';
                    
                    setTimeout(() => {
                        loginView.classList.add('hidden');
                        dashboardView.classList.remove('hidden');
                        dashboardView.classList.add('fade-in');
                        initApp();

                        if (userData.mustChange) {
                            router('settings');
                            customAlert("Please change your default password.", "Security Notice");
                        } else if (['manager', 'admin', 'developer'].includes(userData.role)) {
                            router('admin');
                        } else {
                            router('home');
                        }
                    }, 500);

                } catch (error) {
                    console.error("Login Error:", error);
                    errorDisplay.innerText = error.message || "Login failed.";
                    errorDisplay.classList.remove('hidden');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<span>Sign In</span> <i class="ph-bold ph-arrow-right"></i>';
                }
            });

            document.getElementById('logout-btn').addEventListener('click', logout);
            bindFloatingLabels(); 
        });
        
        function updateThemeButtons(mode) {
            const lightBtn = document.getElementById('theme-btn-light');
            const darkBtn = document.getElementById('theme-btn-dark');

            if (lightBtn && darkBtn) {
                [lightBtn, darkBtn].forEach(btn => {
                    btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-900', 'dark:text-white', 'font-bold', 'shadow-sm');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400', 'font-medium');
                });

                const activeBtn = mode === 'dark' ? darkBtn : lightBtn;
                activeBtn.classList.remove('text-slate-500', 'dark:text-slate-400', 'font-medium');
                activeBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-900', 'dark:text-white', 'font-bold', 'shadow-sm');
            }
        }

        function logout() {
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('user');
            localStorage.removeItem('authToken'); // Clear Remember Me
            localStorage.removeItem('user');      // Clear Remember Me
            location.reload();
        }

        async function initApp() {
            const user = JSON.parse(sessionStorage.getItem('user'));
            if(user) {
                // 1. Setup UI Text & Avatar
                if(document.getElementById('display-username')) document.getElementById('display-username').innerText = user.username;
                if(document.getElementById('display-badge')) document.getElementById('display-badge').innerText = `Badge: ${user.badge}`;
                
                const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`;
                if(document.getElementById('profile-avatar')) document.getElementById('profile-avatar').src = defaultAvatar;
                
                // Pre-fill inputs
                const safeVal = (val) => (val && val !== 'null' && val !== 'undefined') ? val : '';
                const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = safeVal(val); };
                
                setVal('officerBadge', user.badge);
                setVal('usernameBadge', user.badge);
                setVal('officerName', user.username);
                setVal('yourUsername', user.username);
                setVal('departmentDisplay', user.dept);
                setVal('officerDepartmentDisplayCitation', user.dept);
                setVal('officerDepartmentDisplayArrest', user.dept);

                // --- PERMISSION DEFINITIONS ---
                const role = user.role || 'civilian';
                
                const adminRoles = ['manager', 'admin', 'developer'];
                const modRoles = ['manager', 'admin', 'developer', 'senior_moderator', 'moderator', 'junior_moderator'];
                
                const isAdmin = adminRoles.includes(role);
                const isStaff = modRoles.includes(role);
                const isLEO = role !== 'civilian'; 

                // --- SHOW/HIDE SIDEBAR BUTTONS ---
                const leoTargets = ['home', 'leaderboard', 'citation', 'arrest', 'registry', 'shift'];
                leoTargets.forEach(target => {
                    const btn = document.querySelector(`.nav-item[data-target="${target}"]`);
                    if(btn && isLEO) btn.classList.remove('hidden');
                });

                const modBtn = document.querySelector('.nav-item[data-target="moderation"]');
                if(modBtn && isStaff) modBtn.classList.remove('hidden');

                const adminBtnFallback = document.getElementById('admin-nav-btn');
                if(adminBtnFallback && isAdmin) adminBtnFallback.classList.remove('hidden');

                const homeModBtn = document.getElementById('home-mod-btn');
                if(homeModBtn && isStaff) homeModBtn.classList.remove('hidden');
            }

            // Load Penal Codes
            const codes = await apiRequest('/penal-codes');
            if (codes) {
                appState.penalCodes = codes.map(c => ({
                    code: c.code,
                    desc: c.description || 'N/A',
                    fine: c.amount_due || 0,
                    jail: c.jail_time_seconds || 0,
                    type: c.type || 'N/A'
                }));
            }

            // Init forms
            if(typeof initArrestForm === 'function') initArrestForm();
            if(typeof initCitationForm === 'function') initCitationForm();
            if(typeof bindFloatingLabels === 'function') bindFloatingLabels(); 
            if(typeof initStateSelector === 'function') initStateSelector();
            if(typeof initDepartmentSelector === 'function') initDepartmentSelector();
            if(typeof initShiftPanel === 'function') initShiftPanel();
        }

        // --- ROUTER FUNCTION ---
        function router(target) {
            try {
                // --- GATEKEEPER: SECURITY CHECK ---
                const { token, user } = getActiveSession();

                if (!token || !user) {
                    logout();
                    return;
                }

                if (user.mustChange && target !== 'settings') {
                    customAlert('Password Change Required.', 'Security');
                    return;
                }

                // --- PERMISSION CHECKS ---
                const role = user.role || 'civilian';
                
                // 1. Admin Panel Access
                const adminRoles = ['manager', 'admin', 'developer'];
                
                // 2. Mod Panel Access
                const modRoles = ['manager', 'admin', 'developer', 'senior_moderator', 'moderator', 'junior_moderator'];

                const isAdmin = adminRoles.includes(role);
                const isStaff = modRoles.includes(role);
                const isLEO = role !== 'civilian'; 

                // BLOCK: Admin Page
                if (target === 'admin' && !isAdmin) {
                    return customAlert("Access Denied: You do not have Admin permissions.", "Unauthorized");
                }

                // BLOCK: Moderation Page
                if (target === 'moderation' && !isStaff) {
                    return customAlert("Access Denied: You do not have Moderator permissions.", "Unauthorized");
                }

                // BLOCK: LEO Pages (for Civilians)
                const leoPages = ['home', 'citation', 'arrest', 'shift', 'registry', 'leaderboard'];
                if (leoPages.includes(target) && !isLEO) {
                    if(isAdmin) return router('admin');
                    if(isStaff) return router('moderation');
                    return router('settings'); // Fallback
                }
                // -------------------------

                // Hide all views
                document.querySelectorAll('.page-view').forEach(view => {
                    view.classList.add('hidden');
                    view.classList.remove('fade-in');
                });

                // Update Sidebar Highlighting
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'text-blue-600', 'dark:bg-slate-800', 'dark:text-white');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400');
                    if(btn.dataset.target === target) {
                        btn.classList.remove('text-slate-500', 'dark:text-slate-400');
                        btn.classList.add('bg-blue-50', 'text-blue-600', 'dark:bg-slate-800', 'dark:text-white');
                    }
                });

                // Show Target View
                const viewId = `view-${target}`;
                const targetView = document.getElementById(viewId);
                const pageTitle = document.getElementById('page-title');
                if (target === 'shift' && typeof loadRecentShifts === 'function') {
                    loadRecentShifts();
                }

                if (targetView) {
                    targetView.classList.remove('hidden');
                    void targetView.offsetWidth; // Force Reflow
                    targetView.classList.add('fade-in');
                    
                    if(pageTitle) pageTitle.innerText = target.charAt(0).toUpperCase() + target.slice(1);

                    // Load Data specific to the view
                    if(target === 'leaderboard' && typeof initLeaderboard === 'function') initLeaderboard(); 
                    if(target === 'moderation' && typeof renderModerationView === 'function') renderModerationView(); 
                    if(target === 'admin' && typeof renderAdminView === 'function') renderAdminView();
                }
            } catch(e) {
                console.error("Router Error:", e);
            }
        }

        // --- DYNAMIC FORM LOGIC: ARREST ---

        function updateArrestTotals() {
            let jail = 0;
            let fines = 0;
            const warrantJailInput = document.getElementById('warrantJailTime');
            
            document.querySelectorAll('#chargeInputsContainer .charge-group').forEach(group => {
                const jailInput = group.querySelector('.jail-time-input');
                const codeInput = group.querySelector('.charge-code-input');
                
                if (codeInput && codeInput.value) {
                     const code = appState.penalCodes.find(pc => pc.code === codeInput.value);
                    if(code) {
                        jailInput.value = code.jail;
                        jail += code.jail;
                        fines += code.fine;
                    } else {
                         jailInput.value = '0';
                    }
                } else if (jailInput) {
                    jailInput.value = '0';
                }
            });
            
            if (warrantJailInput && document.getElementById('servingWarrantYes').checked) {
                 jail += parseInt(warrantJailInput.value || 0);
            }

            document.getElementById('totalJailTimeSum').value = jail;
            document.getElementById('totalFinesSum').value = `$${fines.toFixed(2)}`;
            
            document.querySelectorAll('#chargeInputsContainer .charge-group').forEach((group, index) => {
                const removeBtn = group.querySelector('.remove-charge-btn');
                if (removeBtn) {
                    removeBtn.classList.toggle('hidden', index === 0);
                }
            });
        }

        function initArrestForm() {
            const container = document.getElementById('chargeInputsContainer');
            const addBtn = document.getElementById('addChargeBtn');
            const form = document.getElementById('arrestForm');
            const clearBtn = document.getElementById('clearArrestFormBtn');
            const mugshotUpload = document.getElementById('mugshotUpload');
            const pasteMugshotTarget = document.getElementById('pasteMugshotTarget');
            const mugshotPreview = document.getElementById('mugshotPreview');
            let groupIdCounter = 1;

            const resetFormState = () => {
                form.reset();
                const user = JSON.parse(sessionStorage.getItem('user'));
                document.getElementById('arrestingOfficerBadge').value = user.badge;
                document.getElementById('yourUsername').value = user.username;
                document.getElementById('officerDepartmentDisplayArrest').value = user.dept;
                
                container.innerHTML = ''; 
                container.appendChild(createChargeGroup(0)); 
                updateArrestTotals();
                mugshotDataURL = null; 
                mugshotPreview.innerHTML = '<p class="text-slate-400 text-sm">No image selected</p>';
                document.getElementById('warrantJailTimeContainer').classList.add('hidden');
                document.getElementById('warrantJailTime').value = 0;
                bindFloatingLabels(); 
            }

            // --- NO PHOTO BUTTON LOGIC ---
            const NO_PHOTO_URL = "https://images.shadowle.com/no_image_id.png";
            const noMugshotBtn = document.getElementById('noMugshotBtn');
            
            if (noMugshotBtn) {
                noMugshotBtn.addEventListener('click', () => {
                    // Set global variable
                    mugshotDataURL = NO_PHOTO_URL;
                    
                    // Update Preview
                    const preview = document.getElementById('mugshotPreview');
                    preview.innerHTML = `<img src="${NO_PHOTO_URL}" class="max-h-48 rounded mx-auto border-2 border-slate-300 dark:border-slate-600 opacity-75" />`;
                    
                    // Clear file input
                    const fileInput = document.getElementById('mugshotUpload');
                    if(fileInput) fileInput.value = '';
                });
            }
            
            // --- DROPDOWN CREATOR LOGIC ---
            // --- INSIDE initArrestForm() ---
            
            const createChargeGroup = (id) => {
                const div = document.createElement('div');
                div.className = 'charge-group relative grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] gap-4 mb-6 items-end';
                div.dataset.groupId = id;
                
                div.innerHTML = `
                    <div class="custom-dropdown-container form-field-group !mt-0 relative">
                        <input type="text" id="chargeCode_${id}" class="modern-input charge-code-input" autocomplete="off" placeholder=" " value="" />
                        <label for="chargeCode_${id}" class="floating-label">Search Charge (Name or Code)</label>
                        <div id="chargeResults_${id}" class="dropdown-results"></div>
                    </div>
                    
                    <div class="relative">
                        <input type="number" id="jailTime_${id}" readonly 
                               class="w-full pt-6 pb-2 px-4 bg-rose-100 dark:bg-rose-900/30 text-rose-700 dark:text-rose-400 font-black text-xl rounded-xl border-none outline-none text-right jail-time-input shadow-inner transition-colors" 
                               value="0">
                        <label for="jailTime_${id}" class="absolute left-4 top-2 text-rose-600/70 dark:text-rose-400/70 text-xs font-bold uppercase tracking-wider pointer-events-none">
                            Jail (Sec)
                        </label>
                    </div>
                    
                    <button type="button" class="self-end p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg remove-charge-btn ${id === 0 ? 'hidden' : ''}" onclick="this.closest('.charge-group').remove(); updateArrestTotals();">
                        <i class="ph-duotone ph-trash text-xl"></i>
                    </button>
                `;

                // --- ATTACH EVENT LISTENERS (Same as before) ---
                const input = div.querySelector('.charge-code-input');
                const results = div.querySelector('.dropdown-results');
                const jailInput = div.querySelector('.jail-time-input');

                const renderList = (filter = "") => {
                    results.innerHTML = '';
                    const term = filter.toLowerCase();
                    
                    const matches = appState.penalCodes.filter(pc => 
                        (pc.jail > 0) && 
                        (pc.code.toLowerCase().includes(term) || pc.desc.toLowerCase().includes(term))
                    );

                    if (matches.length === 0) {
                        results.innerHTML = `<div class="p-3 text-sm text-slate-400 text-center">No charges found.</div>`;
                        return;
                    }

                    matches.forEach(pc => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.innerHTML = `
                            <span class="dropdown-code">${pc.code}</span>
                            <span class="dropdown-desc">${pc.desc}</span>
                            <span class="dropdown-meta">${pc.jail}s Jail</span>
                        `;
                        item.onmousedown = (e) => e.preventDefault();
                        item.onclick = () => {
                            input.value = pc.code; 
                            jailInput.value = pc.jail;
                            input.classList.add('filled');
                            // Removed jailInput.classList.add('filled') as it's custom styled now
                            results.classList.remove('show');
                            updateArrestTotals();
                        };
                        results.appendChild(item);
                    });
                };

                input.addEventListener('focus', () => {
                    renderList(input.value);
                    results.classList.add('show');
                });
                
                input.addEventListener('input', () => {
                    renderList(input.value);
                    results.classList.add('show');
                    if(input.value === '') updateArrestTotals();
                });

                input.addEventListener('blur', () => {
                    setTimeout(() => results.classList.remove('show'), 200);
                });

                return div;
            };

            // Setup Listeners
            if(addBtn) {
                const newBtn = addBtn.cloneNode(true);
                addBtn.parentNode.replaceChild(newBtn, addBtn);
                newBtn.addEventListener('click', () => {
                    container.appendChild(createChargeGroup(groupIdCounter++));
                    updateArrestTotals(); 
                    bindFloatingLabels(); 
                });
            }
            
            if(clearBtn) clearBtn.onclick = resetFormState;

            const warrantJailInput = document.getElementById('warrantJailTime');
            if(warrantJailInput) warrantJailInput.addEventListener('input', updateArrestTotals);
            
            document.querySelectorAll('input[name="servingWarrant"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('warrantJailTimeContainer').classList.toggle('hidden', e.target.value === 'NO');
                    updateArrestTotals();
                });
            });
            document.getElementById('warrantJailTimeContainer').addEventListener('input', updateArrestTotals);
            
            if(mugshotUpload) mugshotUpload.addEventListener('change', (e) => handleImage(e.target.files[0], mugshotPreview, { url: mugshotDataURL }));
            
            if(pasteMugshotTarget) {
                pasteMugshotTarget.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.type.startsWith('image/')) {
                            handleImage(item.getAsFile(), mugshotPreview, { url: mugshotDataURL });
                            break;
                        }
                    }
                });
            }

            if(form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    const appliedCharges = [];
                    document.querySelectorAll('#chargeInputsContainer .charge-group').forEach(group => {
                        const input = group.querySelector('.charge-code-input');
                        if (input && input.value) {
                            const code = appState.penalCodes.find(pc => pc.code === input.value);
                            if(code) {
                                appliedCharges.push({ 
                                    code: code.code, 
                                    description: code.desc, 
                                    amount_due: code.fine || 0, 
                                    jail_time_seconds: code.jail || 0
                                });
                            }
                        }
                    });

                    if (appliedCharges.length === 0) return customAlert('Please add at least one valid charge code.', 'Validation Error');

                    const totalFines = parseFloat(document.getElementById('totalFinesSum').value.replace('$','')) || 0;
                    const totalJail = parseInt(document.getElementById('totalJailTimeSum').value) || 0;
                    
                    const violations = appliedCharges.map(c => `${c.code} - ${c.description}`);

                    const payload = {
                        arrestingOfficerBadge: document.getElementById('arrestingOfficerBadge').value,
                        yourUsername: document.getElementById('yourUsername').value,
                        leoUsernames: document.getElementById('leoUsernames').value,
                        ranks: document.getElementById('ranks').value,
                        suspectName: document.getElementById('suspectName').value,
                        department: document.getElementById('officerDepartmentDisplayArrest').value,
                        violations: violations,
                        charges: appliedCharges.map(c => c.code).join(', '), 
                        appliedCharges: appliedCharges, 
                        totalFines: totalFines.toFixed(2),
                        totalJailTime: totalJail, 
                        warrantNeeded: document.querySelector('input[name="warrantNeeded"]:checked').value === 'YES',
                        servingWarrant: document.querySelector('input[name="servingWarrant"]:checked').value === 'YES',
                        incidentDetails: document.getElementById('incidentDetails').value,
                        mugshot: mugshotDataURL 
                    };

                    if (await apiRequest('/submit-arrest', 'POST', payload)) {
                        customAlert('Arrest Report Submitted Successfully!', 'Success');
                        
                        if (payload.warrantNeeded) {
                            await apiRequest('/warrant-log', 'POST', {
                                userReceivingWarrant: payload.suspectName,
                                submittedByUsername: payload.yourUsername,
                                submittedByBadge: payload.arrestingOfficerBadge,
                                jailTime: payload.totalJailTime,
                                dateOfIssue: new Date().toISOString().split('T')[0],
                                notes: `Warrant for Arrest: ${payload.charges}`,
                                department: payload.department
                            }).catch(e => console.error("Warrant Log Failed:", e));
                        }
                        resetFormState();
                    }
                };
            }

            // Initialize first group
            container.innerHTML = '';
            container.appendChild(createChargeGroup(0));
            updateArrestTotals();
        }

       // --- DYNAMIC FORM LOGIC: CITATION (BACKEND COMPATIBLE FIX) ---
        
        function updateCitationTotals() {
            let amount = 0;
            let types = new Set();
            
            document.querySelectorAll('#penalCodeInputsContainer .penal-code-group').forEach(group => {
                const amountInput = group.querySelector('.amount-due-input');
                const codeInput = group.querySelector('.penal-code-input');
                
                if (codeInput && codeInput.value) {
                     const code = appState.penalCodes.find(pc => pc.code === codeInput.value);
                    if(code) {
                        const fine = parseFloat(code.fine || 0);
                        amountInput.value = fine.toFixed(2);
                        amount += fine;
                        if(code.type) types.add(code.type);
                    } else {
                        amountInput.value = '0.00';
                    }
                } else if (amountInput) {
                    amountInput.value = '0.00';
                }
            });

            document.getElementById('totalAmountDueSum').value = `$${amount.toFixed(2)}`;
            document.getElementById('violationType').value = Array.from(types).join(', ');

            document.querySelectorAll('#penalCodeInputsContainer .penal-code-group').forEach((group, index) => {
                const removeBtn = group.querySelector('.remove-code-btn');
                if (removeBtn) {
                    removeBtn.classList.toggle('hidden', index === 0);
                }
            });
        }

        function initCitationForm() {
            const container = document.getElementById('penalCodeInputsContainer');
            const addBtn = document.getElementById('addPenalCodeBtn');
            const form = document.getElementById('citationForm');
            const clearBtn = document.getElementById('clearCitationFormBtn');
            const notSignedReasonContainer = document.getElementById('notSignedReasonContainer');
            const notSignedReason = document.getElementById('notSignedReason');

            let groupIdCounter = 1;
            
            const resetFormState = () => {
                form.reset();
                const user = JSON.parse(sessionStorage.getItem('user'));
                if(document.getElementById('officerBadge')) document.getElementById('officerBadge').value = user.badge;
                if(document.getElementById('officerName')) document.getElementById('officerName').value = user.username;
                if(document.getElementById('officerDepartmentDisplayCitation')) document.getElementById('officerDepartmentDisplayCitation').value = user.dept;

                container.innerHTML = '';
                container.appendChild(createGroup(0)); 
                updateCitationTotals();
                if(document.getElementById('signedYes')) document.getElementById('signedYes').checked = true;
                if(notSignedReasonContainer) notSignedReasonContainer.classList.add('hidden');
                if(typeof bindFloatingLabels === 'function') bindFloatingLabels(); 
            }

            const createGroup = (id) => {
                const div = document.createElement('div');
                div.className = 'penal-code-group relative grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] gap-4 mb-6 items-end';
                div.dataset.groupId = id;
                
                div.innerHTML = `
                    <div class="custom-dropdown-container form-field-group !mt-0 relative">
                        <input type="text" id="penalCode_${id}" class="modern-input penal-code-input" autocomplete="off" placeholder=" " value="" />
                        <label for="penalCode_${id}" class="floating-label">Search Violation</label>
                        <div id="penalCodeResults_${id}" class="dropdown-results"></div>
                    </div>
                    
                    <div class="relative">
                        <input type="number" id="amountDue_${id}" step="0.01" min="0" value="0.00" readonly
                               class="w-full pt-6 pb-2 px-4 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-black text-xl rounded-xl border-none outline-none text-right amount-due-input shadow-inner transition-colors">
                        <label for="amountDue_${id}" class="absolute left-4 top-2 text-emerald-600/70 dark:text-emerald-400/70 text-xs font-bold uppercase tracking-wider pointer-events-none">
                            Amount Due
                        </label>
                    </div>
                    
                    <button type="button" class="self-end p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg remove-code-btn ${id === 0 ? 'hidden' : ''}" onclick="this.closest('.penal-code-group').remove(); updateCitationTotals();">
                        <i class="ph-duotone ph-trash text-xl"></i>
                    </button>
                `;

                const input = div.querySelector('.penal-code-input');
                const results = div.querySelector('.dropdown-results');
                const amountInput = div.querySelector('.amount-due-input');

                const renderList = (filter = "") => {
                    results.innerHTML = '';
                    const term = filter.toLowerCase();
                    
                    const matches = appState.penalCodes.filter(pc => 
                        (pc.fine > 0) && 
                        (pc.type.toLowerCase() !== 'felony') && 
                        (pc.code.toLowerCase().includes(term) || pc.desc.toLowerCase().includes(term))
                    );

                    if (matches.length === 0) {
                        results.innerHTML = `<div class="p-3 text-sm text-slate-400 text-center">No infractions found.</div>`;
                        return;
                    }

                    matches.forEach(pc => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.innerHTML = `
                            <span class="dropdown-code">${pc.code}</span>
                            <span class="dropdown-desc">${pc.desc}</span>
                            <span class="dropdown-meta">$${pc.fine}</span>
                        `;
                        item.onmousedown = (e) => e.preventDefault(); 
                        item.onclick = () => {
                            input.value = pc.code;
                            amountInput.value = pc.fine.toFixed(2);
                            input.classList.add('filled');
                            results.classList.remove('show');
                            updateCitationTotals();
                        };
                        results.appendChild(item);
                    });
                };

                input.addEventListener('focus', () => {
                    renderList(input.value);
                    results.classList.add('show');
                });
                
                input.addEventListener('input', () => {
                    renderList(input.value);
                    results.classList.add('show');
                    if(input.value === '') updateCitationTotals();
                });

                input.addEventListener('blur', () => {
                    setTimeout(() => results.classList.remove('show'), 200);
                });

                return div;
            };

            if(addBtn) {
                const newBtn = addBtn.cloneNode(true);
                addBtn.parentNode.replaceChild(newBtn, addBtn);
                newBtn.addEventListener('click', () => {
                    container.appendChild(createGroup(groupIdCounter++));
                    updateCitationTotals();
                    bindFloatingLabels(); 
                });
            }
            
            if(clearBtn) clearBtn.onclick = resetFormState;

            document.querySelectorAll('input[name="signedStatus"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if(notSignedReasonContainer) notSignedReasonContainer.classList.toggle('hidden', e.target.value === 'YES');
                    if (e.target.value === 'YES' && notSignedReason) notSignedReason.value = '';
                });
            });

            if(form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    // --- BACKEND FIX: Construct 'appliedPenalCodes' array ---
                    const appliedPenalCodes = [];
                    
                    document.querySelectorAll('#penalCodeInputsContainer .penal-code-group').forEach(group => {
                        const codeInput = group.querySelector('.penal-code-input');
                        if (codeInput && codeInput.value) {
                            const code = appState.penalCodes.find(pc => pc.code === codeInput.value);
                            if (code) {
                                appliedPenalCodes.push({
                                    code: code.code,
                                    description: code.desc,
                                    amount_due: code.fine,
                                    type: code.type
                                });
                            }
                        }
                    });

                    if (appliedPenalCodes.length === 0) {
                        return customAlert('Please add at least one valid penal code.', 'Validation Error');
                    }

                    const totalAmount = parseFloat(document.getElementById('totalAmountDueSum').value.replace('$','')) || 0;

                    const payload = {
                        officerBadge: document.getElementById('officerBadge').value,
                        officerName: document.getElementById('officerName').value,
                        officerRank: document.getElementById('citationOfficerRank').value,
                        officerSignature: document.getElementById('citationOfficerSignature').value,
                        violatorName: document.getElementById('violatorName').value,
                        department: document.getElementById('officerDepartmentDisplayCitation').value,
                        violationType: document.getElementById('violationType').value,
                        
                        // FIX: Send the Array of Objects, not a string
                        appliedPenalCodes: appliedPenalCodes,
                        
                        totalAmountDue: totalAmount.toFixed(2),
                        violationDetails: document.getElementById('violationDetails').value,
                        signedStatus: document.querySelector('input[name="signedStatus"]:checked').value,
                        notSignedReason: document.getElementById('notSignedReason').value
                    };

                    if (await apiRequest('/submit-citation', 'POST', payload)) {
                        customAlert('Citation Submitted Successfully!', 'Success');
                        resetFormState();
                    }
                };
            }

            container.innerHTML = '';
            container.appendChild(createGroup(0));
            updateCitationTotals();
            if(typeof bindFloatingLabels === 'function') bindFloatingLabels(); 
        }

        // --- NEW LEADERBOARD LOGIC ---

        function initLeaderboard() {
            switchLeaderboardTab(activeLeaderboardTab);
        }

        function switchLeaderboardTab(tab) {
            activeLeaderboardTab = tab;
            const tabCitation = document.getElementById('tab-citation');
            const tabShift = document.getElementById('tab-shift');
            const activeClasses = ['bg-white', 'dark:bg-slate-600', 'shadow-sm', 'text-slate-900', 'dark:text-white', 'font-bold'];
            const inactiveClasses = ['text-slate-500', 'dark:text-slate-400', 'hover:text-slate-900', 'dark:hover:text-white', 'font-medium'];

            if(tab === 'citation') {
                tabCitation.classList.add(...activeClasses);
                tabCitation.classList.remove(...inactiveClasses);
                tabShift.classList.remove(...activeClasses);
                tabShift.classList.add(...inactiveClasses);
            } else {
                tabShift.classList.add(...activeClasses);
                tabShift.classList.remove(...inactiveClasses);
                tabCitation.classList.remove(...activeClasses);
                tabCitation.classList.add(...inactiveClasses);
            }
            loadLeaderboardData(tab);
        }

        async function loadLeaderboardData(type) {
            const podiumArea = document.getElementById('podium-area');
            const listArea = document.getElementById('leaderboard-list-area');
            podiumArea.innerHTML = '<div class="text-center text-slate-400 py-12 animate-pulse">Calculating Ranks...</div>';
            listArea.innerHTML = '';

            let data = [];
            let label = '';
            
            if (type === 'citation') {
                data = await apiRequest('/citations') || []; 
                label = 'Citations';
            } else {
                data = await apiRequest('/shift-logs') || [];
                label = 'Shifts';
            }

            const counts = {};
            data.forEach(item => {
                const key = item.submittedBy || item.submittedByUsername || 'Unknown';
                counts[key] = (counts[key] || 0) + 1;
            });

            const sorted = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .map(([name, score], index) => ({ name, score, rank: index + 1 }));
            
            renderPodiumAndList(sorted, label);
        }
        
        async function updateLeaderboardAvatars(sortedData) {
            for (const user of sortedData) {
                // Fetch avatar (will use cache if available)
                const avatarUrl = await fetchRobloxAvatar(user.name);
                if (avatarUrl) {
                    // Update podium image if exists
                    const podiumImg = document.getElementById(`podium-avatar-${user.name}`);
                    if (podiumImg) {
                        podiumImg.src = avatarUrl;
                        podiumImg.onload = () => podiumImg.classList.remove('opacity-0');
                    }
                    
                    // Update list image if exists
                    const listImg = document.getElementById(`list-avatar-${user.name}`);
                    if (listImg) listImg.src = avatarUrl;
                }
            }
        }

        function renderPodiumAndList(sortedData, label) {
            const podiumArea = document.getElementById('podium-area');
            const listArea = document.getElementById('leaderboard-list-area');
            podiumArea.innerHTML = '';
            listArea.innerHTML = '';

            if (sortedData.length === 0) {
                podiumArea.innerHTML = '<div class="text-center text-slate-500 py-8">No data available.</div>';
                return;
            }

            const top3 = sortedData.slice(0, 3);
            const podiumHTML = document.createElement('div');
            podiumHTML.className = 'podium-container';

            top3.forEach(user => {
                const step = document.createElement('div');
                step.className = `podium-step rank-${user.rank}-step`;
                // Default to DiceBear initially
                const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.name}`;
                
                step.innerHTML = `
                    <div class="podium-avatar-container">
                        <img src="${defaultAvatar}" class="podium-avatar" alt="${user.name}" id="podium-avatar-${user.name}">
                        <div class="podium-rank-badge">${user.rank}</div>
                    </div>
                    <div class="podium-bar">
                        <div class="podium-score">${user.score}</div>
                        <div class="podium-label">${label}</div>
                        <div class="podium-name">${user.name}</div>
                    </div>
                `;
                podiumHTML.appendChild(step);
            });
            podiumArea.appendChild(podiumHTML);

            const rest = sortedData.slice(3);
            if(rest.length === 0) {
                listArea.innerHTML = '<div class="text-center text-slate-400 text-sm py-4">No other contenders yet.</div>';
            } else {
                rest.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 rounded-xl leaderboard-list-item cursor-default';
                    // Default to DiceBear initially
                    const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.name}`;
                    
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-slate-400 w-6 text-center text-sm">#${user.rank}</span>
                            <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
                                <img src="${defaultAvatar}" class="w-full h-full object-cover" id="list-avatar-${user.name}">
                            </div>
                            <span class="font-medium text-slate-700 dark:text-slate-300 text-sm">${user.name}</span>
                        </div>
                        <span class="font-bold text-slate-900 dark:text-white text-sm">${user.score}</span>
                    `;
                    listArea.appendChild(item);
                });
            }
            
            // Trigger background fetch for Roblox avatars
            updateLeaderboardAvatars(sortedData);
        }

        // --- SHIFT LOG LOGIC ---


        // ... (remaining helper functions like renderModerationView, renderAdminView, etc. remain the same) ...
        async function saveProfileSettings(e) {
            e.preventDefault();
            const oldPass = document.getElementById('settings-old-pass').value;
            const newPass = document.getElementById('settings-new-pass').value;
            const msgDisplay = document.getElementById('password-change-message');
            msgDisplay.classList.add('hidden');
            
            if(!oldPass || !newPass) {
                msgDisplay.innerText = 'Fill all password fields.';
                msgDisplay.classList.remove('hidden', 'text-green-500');
                msgDisplay.classList.add('text-red-500');
                return;
            }
            if (newPass.length < 6) {
                msgDisplay.innerText = 'New password must be at least 6 characters long.';
                msgDisplay.classList.remove('hidden', 'text-green-500');
                msgDisplay.classList.add('text-red-500');
                return;
            }
            
            const result = await apiRequest('/v1/auth/change-password', 'PUT', {
                oldPassword: oldPass,
                newPassword: newPass
            }).catch(() => null);
            
            if (result) {
                document.getElementById('settings-old-pass').value = '';
                document.getElementById('settings-new-pass').value = '';
                
                const user = JSON.parse(sessionStorage.getItem('user'));
                user.mustChange = false;
                sessionStorage.setItem('user', JSON.stringify(user));
                
                msgDisplay.innerText = 'Password updated successfully. Returning home...';
                msgDisplay.classList.remove('hidden', 'text-red-500');
                msgDisplay.classList.add('text-green-500');
                
                setTimeout(() => router('home'), 1500);
            } else {
                 msgDisplay.innerText = 'Password change failed. Check your current password.';
                 msgDisplay.classList.remove('hidden', 'text-green-500');
                 msgDisplay.classList.add('text-red-500');
            }
            bindFloatingLabels();
        }

        function setTheme(mode) {
            if(mode === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark'); 
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light'); 
            }
            updateThemeButtons(mode); 
        }

        // --- MODERATION PANEL & QUEUE LOGIC ---
        
        let cachedModCitations = [];
        let cachedModArrests = [];
        let queueItems = [];
        let currentQueueIndex = 0;


        // 2. MAIN MODERATION VIEW
        async function renderModerationView() {
            // Setup Queue Button
            const queueBtn = document.getElementById('launchQueueBtn');
            if (queueBtn) {
                queueBtn.onclick = startReviewQueue;
            }
            refreshModeration();
        }

        // 3. START QUEUE
        function startReviewQueue() {
            // Filter for items that are UNPAID and HAVE PROOF (Optional: remove proof check if you want to review all)
            const citations = cachedModCitations.filter(c => !c.paidStatus).map(c => ({...c, type: 'citation'}));
            const arrests = cachedModArrests.filter(a => !a.paidStatus).map(a => ({...a, type: 'arrest'}));
            
            queueItems = [...citations, ...arrests];
            
            if (queueItems.length === 0) {
                return customAlert("No pending items found in the queue.", "Queue Empty");
            }

            currentQueueIndex = 0;
            renderQueueItem();
            
            // Show Modal
            toggleModal('queueModalOverlay', true);
        }

        function closeQueueModal() {
            toggleModal('queueModalOverlay', false);
            toggleDenyMode(false); // Reset UI
            refreshModeration(); // Refresh the table behind the modal
        }

        // 4. RENDER SINGLE ITEM
        function renderQueueItem() {
            if (currentQueueIndex >= queueItems.length) {
                closeQueueModal();
                customAlert("Queue review completed!", "All Done");
                return;
            }

            const item = queueItems[currentQueueIndex];
            
            // Update Text Info
            document.getElementById('queueCounter').innerText = `Item ${currentQueueIndex + 1} of ${queueItems.length}`;
            document.getElementById('queueTypeBadge').innerText = item.type === 'citation' ? 'CITATION' : 'ARREST RECORD';
            document.getElementById('queueAmount').innerText = `$${(item.totalAmountDue || item.totalFines)}`;
            document.getElementById('queueViolator').innerText = item.violatorDisplayName || item.suspectDisplayName || item.violatorName || item.suspectName;
            document.getElementById('queueOfficer').innerText = item.submittedBy;
            document.getElementById('queueDate').innerText = new Date(item.timestamp).toLocaleDateString();

            // Update Image
            const imgEl = document.getElementById('queueProofImage');
            const loader = document.getElementById('queueImageLoader');
            const noProof = document.getElementById('noProofMessage');
            const link = document.getElementById('queueOpenLink');

            loader.classList.remove('hidden');
            noProof.classList.add('hidden');
            imgEl.classList.add('opacity-0'); // Hide until loaded
            
            if (item.paymentScreenshotUrl) {
                const correctUrl = getCorrectImageUrl(item.paymentScreenshotUrl); // FIX APPLIED

                imgEl.src = correctUrl;
                link.href = correctUrl;
                link.classList.remove('hidden');
                
                imgEl.onload = () => {
                    loader.classList.add('hidden');
                    imgEl.classList.remove('opacity-0');
                };
                imgEl.onerror = () => {
                    loader.classList.add('hidden');
                    noProof.classList.remove('hidden');
                    noProof.querySelector('span').innerText = "Failed to load image";
                };
            } else {
                loader.classList.add('hidden');
                imgEl.src = "";
                noProof.classList.remove('hidden');
                link.classList.add('hidden');
                noProof.querySelector('span').innerText = "No Proof Submitted";
            }

            // Reset Deny Mode
            toggleDenyMode(false);
        }

        // 5. ACCEPT LOGIC
        async function acceptQueueItem() {
            const item = queueItems[currentQueueIndex];
            const endpoint = item.type === 'citation' ? '/admin/citations/status' : '/admin/arrests/status';
            
            // Show loading on button
            const btn = event.currentTarget; // The clicked button
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Processing...`;

            try {
                const result = await apiRequest(endpoint, 'PUT', {
                    ids: [item.id],
                    paidStatus: true,
                    declineReason: null
                });

                if (result) {
                    currentQueueIndex++;
                    renderQueueItem();
                }
            } catch (e) {
                customAlert("Failed to accept item.", "Error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // 6. DENY LOGIC UI
        function toggleDenyMode(show) {
            const footer = document.getElementById('queueActionsFooter');
            const denyContainer = document.getElementById('denyInputContainer');
            
            if (show) {
                footer.classList.add('hidden');
                denyContainer.classList.remove('hidden');
                document.getElementById('queueDenyReason').value = ""; // Clear
            } else {
                footer.classList.remove('hidden');
                denyContainer.classList.add('hidden');
            }
        }

        async function confirmDenyItem() {
            const reason = document.getElementById('queueDenyReason').value.trim();
            if (!reason) {
                alert("Please provide a reason for denial.");
                return;
            }

            const item = queueItems[currentQueueIndex];
            const endpoint = item.type === 'citation' ? '/admin/citations/status' : '/admin/arrests/status';

            try {
                const result = await apiRequest(endpoint, 'PUT', {
                    ids: [item.id],
                    paidStatus: false,
                    declineReason: reason
                });

                if (result) {
                    currentQueueIndex++;
                    renderQueueItem();
                }
            } catch (e) {
                customAlert("Failed to deny item.", "Error");
            }
        }

        // --- EXISTING REFRESH LOGIC (For the table view) ---
       async function refreshModeration() {
            const queueBadge = document.getElementById('queueBadge');
            if(queueBadge) queueBadge.innerText = '...';

            const loadingHTML = `<tr><td colspan="6" class="text-center py-12"><div class="flex flex-col items-center justify-center text-slate-400"><i class="ph-duotone ph-spinner animate-spin text-3xl mb-3"></i><span class="text-sm font-medium">Fetching Records...</span></div></td></tr>`;
            
            if(document.getElementById('modStatsBody')) document.getElementById('modStatsBody').innerHTML = loadingHTML;
            if(document.getElementById('modCitationsBody')) document.getElementById('modCitationsBody').innerHTML = loadingHTML;
            if(document.getElementById('modArrestsBody')) document.getElementById('modArrestsBody').innerHTML = loadingHTML;

            try {
                const [citationsRes, arrestsRes, statsRes] = await Promise.allSettled([
                    apiRequest('/citations'),
                    apiRequest('/arrests'),
                    apiRequest('/admin/stats/moderators')
                ]);

                const citations = (citationsRes.status === 'fulfilled' && Array.isArray(citationsRes.value)) ? citationsRes.value : [];
                const arrests = (arrestsRes.status === 'fulfilled' && Array.isArray(arrestsRes.value)) ? arrestsRes.value : [];
                const stats = (statsRes.status === 'fulfilled' && Array.isArray(statsRes.value)) ? statsRes.value : [];

                cachedModCitations = citations;
                cachedModArrests = arrests;

                const statsBody = document.getElementById('modStatsBody');
                if(statsBody) {
                    statsBody.innerHTML = '';
                    if (stats.length > 0) {
                        
                        // Sort by Total Unpaid (Descending)
                        stats.sort((a, b) => {
                            const unpaidA = (a.unpaidCitations || 0) + (a.unpaidArrests || 0);
                            const unpaidB = (b.unpaidCitations || 0) + (b.unpaidArrests || 0);
                            return unpaidB - unpaidA;
                        });

                        stats.forEach(user => {
                            const row = document.createElement('tr');
                            row.className = 'border-b border-slate-100 dark:border-slate-800';
                            
                            const unpaidCites = user.unpaidCitations || 0;
                            const unpaidArrests = user.unpaidArrests || 0;
                            const unpaidTotal = unpaidCites + unpaidArrests;
                            const totalActivity = unpaidTotal + (user.paidCitations || 0) + (user.paidArrests || 0);

                            // --- WARNING ICON LOGIC ---
                            let warningBadge = '';
                            if (unpaidTotal >= 4) {
                                warningBadge = `<i class="ph-fill ph-siren text-rose-500 animate-pulse text-lg mr-2" title="High Risk: ${unpaidTotal} Unpaid Records"></i>`;
                            } else if (unpaidTotal === 3) {
                                warningBadge = `<i class="ph-fill ph-warning text-yellow-500 text-lg mr-2" title="Warning: 3 Unpaid Records"></i>`;
                            }

                            // --- CONDITIONAL CELL BACKGROUNDS ---
                            // Default: Neutral
                            let citeBg = 'text-slate-500 dark:text-slate-400 font-medium';
                            let arrestBg = 'text-slate-500 dark:text-slate-400 font-medium';

                            const flashClass = 'bg-rose-100 dark:bg-rose-900/40 text-rose-700 dark:text-rose-300 font-black animate-pulse';
                            const warnClass = 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 font-bold';

                            // Logic: If Total >= 4, BOTH flash red.
                            if (unpaidTotal >= 4) {
                                citeBg = flashClass;
                                arrestBg = flashClass;
                            } 
                            // Else: Check individual counts for the yellow warning (3)
                            else {
                                if (unpaidCites === 3) citeBg = warnClass;
                                if (unpaidArrests === 3) arrestBg = warnClass;
                            }

                            row.innerHTML = `
                                <td class="py-3 px-6 font-medium dark:text-white flex items-center">
                                    ${warningBadge}
                                    ${user.violatorDisplayName || user.violatorID || 'Unknown'}
                                </td>
                                <td class="py-3 px-6 text-center ${citeBg}">${unpaidCites}</td>
                                <td class="py-3 px-6 text-center ${arrestBg}">${unpaidArrests}</td>
                                <td class="py-3 px-6 text-center text-emerald-500 font-bold">${user.paidCitations || 0}</td>
                                <td class="py-3 px-6 text-center text-emerald-500 font-bold">${user.paidArrests || 0}</td>
                                <td class="py-3 px-6 text-center text-slate-500 font-bold">${totalActivity}</td>
                            `;
                            statsBody.appendChild(row);
                        });
                    } else { 
                        statsBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-slate-400">No stats available.</td></tr>`; 
                    }
                }

                const unpaidCount = cachedModCitations.filter(c => !c.paidStatus).length + cachedModArrests.filter(a => !a.paidStatus).length;
                if(queueBadge) queueBadge.innerText = unpaidCount;

                if(typeof applyModFilters === 'function') applyModFilters();

            } catch (error) {
                console.error("Moderation Error:", error);
            }
        }

        function applyModFilters() {
            const userFilter = document.getElementById('modFilterUser').value.toLowerCase();
            const targetFilter = document.getElementById('modFilterTarget').value.toLowerCase();
            const dateFilter = document.getElementById('modFilterStart').value;

            const filteredCitations = cachedModCitations.filter(c => {
                return (!userFilter || (c.submittedBy && c.submittedBy.toLowerCase().includes(userFilter))) &&
                       (!targetFilter || (c.violatorName && c.violatorName.toLowerCase().includes(targetFilter)) || (c.violatorDisplayName && c.violatorDisplayName.toLowerCase().includes(targetFilter))) &&
                       (!dateFilter || c.timestamp.startsWith(dateFilter));
            });
            renderModCitationsTable(filteredCitations);

            const filteredArrests = cachedModArrests.filter(a => {
                return (!userFilter || (a.submittedBy && a.submittedBy.toLowerCase().includes(userFilter))) &&
                       (!targetFilter || (a.suspectName && a.suspectName.toLowerCase().includes(targetFilter)) || (a.suspectDisplayName && a.suspectDisplayName.toLowerCase().includes(targetFilter))) &&
                       (!dateFilter || a.timestamp.startsWith(dateFilter));
            });
            renderModArrestsTable(filteredArrests);
        }

        function clearModFilters() {
            document.getElementById('modFilterUser').value = '';
            document.getElementById('modFilterTarget').value = '';
            document.getElementById('modFilterStart').value = '';
            applyModFilters();
        }

        function renderModCitationsTable(data) {
            const tbody = document.getElementById('modCitationsBody');
            const counter = document.getElementById('mod-count-citations');
            if(counter) counter.innerText = data.length;
            
            tbody.innerHTML = '';
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-slate-400">No citations found matching filters.</td></tr>`;
                return;
            }
            data.forEach(c => {
                const row = document.createElement('tr');
                const isPaid = c.paidStatus === true;
                const statusBadge = isPaid 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Paid</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">Unpaid</span>`;
                
                // FIX: Use button with onclick instead of href
                const proofLink = c.paymentScreenshotUrl 
                    ? `<button onclick="openProofModal('${c.paymentScreenshotUrl}')" class="text-blue-500 hover:text-blue-600 dark:hover:text-blue-400 hover:underline text-xs flex items-center gap-1 font-bold transition-colors"><i class="ph-bold ph-eye"></i> View</button>`
                    : `<span class="text-slate-400 text-xs">No Proof</span>`;

                row.innerHTML = `
                    <td class="py-3 px-4 font-mono text-xs text-slate-500">${c.id.substring(0, 8)}...</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${new Date(c.timestamp).toLocaleDateString()}</td>
                    <td class="py-3 px-4 font-medium text-slate-900 dark:text-white">
                        ${c.violatorDisplayName || c.violatorName}
                        <div class="text-xs text-slate-400 font-normal">By: ${c.submittedBy}</div>
                    </td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">$${c.totalAmountDue}</td>
                    <td class="py-3 px-4">${statusBadge}</td>
                    <td class="py-3 px-4">${proofLink}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderModArrestsTable(data) {
            const tbody = document.getElementById('modArrestsBody');
            const counter = document.getElementById('mod-count-arrests');
            if(counter) counter.innerText = data.length;
            
            tbody.innerHTML = '';
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-slate-400">No arrests found matching filters.</td></tr>`;
                return;
            }
            
            data.forEach(a => {
                const row = document.createElement('tr');
                const isPaid = a.paidStatus === true;
                const statusBadge = isPaid 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">Paid</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">Unpaid</span>`;
                
                // FIX: Use button with onclick instead of href
                const proofLink = a.paymentScreenshotUrl 
                    ? `<button onclick="openProofModal('${a.paymentScreenshotUrl}')" class="text-blue-500 hover:text-blue-600 dark:hover:text-blue-400 hover:underline text-xs flex items-center gap-1 font-bold transition-colors"><i class="ph-bold ph-eye"></i> View</button>`
                    : `<span class="text-slate-400 text-xs">No Proof</span>`;

                const jailTimeVal = parseFloat(a.totalJailTime || a.jailTime || a.jail_time || 0).toFixed(0);
                const fineVal = parseFloat(a.totalFines || 0).toFixed(2);
                
                let suspectDisplay = a.suspectDisplayName || a.suspectName || a.suspect;
                if (!suspectDisplay && a.details && a.details.suspectName) suspectDisplay = a.details.suspectName;
                if (!suspectDisplay) suspectDisplay = 'Unknown Suspect';

                row.innerHTML = `
                    <td class="py-3 px-4 font-mono text-xs text-slate-500">${(a.id || '???').substring(0, 8)}...</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${new Date(a.timestamp).toLocaleDateString()}</td>
                    <td class="py-3 px-4 font-medium text-slate-900 dark:text-white">
                        ${suspectDisplay}
                        <div class="text-xs text-slate-400 font-normal">By: ${a.submittedBy}</div>
                    </td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">$${fineVal} / ${jailTimeVal}s</td>
                    <td class="py-3 px-4">${statusBadge}</td>
                    <td class="py-3 px-4">${proofLink}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function toggleAllChecks(source, className) { document.querySelectorAll('.' + className).forEach(cb => cb.checked = source.checked); }
        async function markSelectedCitations(isPaid) {
             const checked = Array.from(document.querySelectorAll('.citation-check:checked')).map(cb => cb.value);
             if (checked.length === 0) return customAlert("No citations selected.", "Empty");
             if (!confirm(`Confirm ${isPaid?"MARK PAID":"MARK UNPAID"} for ${checked.length} items?`)) return;
             await apiRequest('/admin/citations/status', 'PUT', { ids: checked, paidStatus: isPaid, declineReason: isPaid?null:"Batch update" });
             refreshModeration();
        }
        async function markSelectedArrests(isPaid) {
             const checked = Array.from(document.querySelectorAll('.arrest-check:checked')).map(cb => cb.value);
             if (checked.length === 0) return customAlert("No arrests selected.", "Empty");
             if (!confirm(`Confirm ${isPaid?"MARK PAID":"MARK UNPAID"} for ${checked.length} items?`)) return;
             await apiRequest('/admin/arrests/status', 'PUT', { ids: checked, paidStatus: isPaid, declineReason: isPaid?null:"Batch update" });
             refreshModeration();
        }

// --- ADMIN PANEL LOGIC & CUSTOM MODALS ---

        // 1. STATE MANAGEMENT FOR FILTERING
        let adminData = {
            users: [],
            shifts: [],
            citations: [],
            arrests: [],
            warrants: []
        };

        // 3. HELPER FUNCTIONS
        function customConfirm(msg, title="Confirm", btnText="Confirm", isDestructive=true) {
            return new Promise((resolve) => {
                const modalId = 'customConfirmOverlay';
                document.getElementById('confTitle').innerText = title;
                document.getElementById('confMessage').innerText = msg;
                const okBtn = document.getElementById('confOkBtn');
                const cancelBtn = document.getElementById('confCancelBtn');
                
                okBtn.innerText = btnText;
                okBtn.className = isDestructive ? "px-4 py-2 bg-rose-600 text-white rounded-xl font-bold hover:bg-rose-700 transition-colors shadow-lg shadow-rose-500/30" : "px-4 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30";
                
                const close = (val) => { 
                    toggleModal(modalId, false); // Fix: Smooth close
                    okBtn.onclick = null; 
                    cancelBtn.onclick = null;
                    resolve(val); 
                };
                
                okBtn.onclick = () => close(true);
                cancelBtn.onclick = () => close(false); // Fix: JS handles the close now
                
                toggleModal(modalId, true); // Fix: Smooth open
            });
        }
        function customPrompt(msg, title="Input", def="", ph="") {
            return new Promise((resolve) => {
                const modalId = 'customPromptOverlay';
                document.getElementById('promptTitle').innerText = title;
                document.getElementById('promptMessage').innerText = msg;
                const input = document.getElementById('promptInput');
                input.value = def; input.placeholder = ph;
                
                const close = (val) => { 
                    toggleModal(modalId, false); 
                    resolve(val); 
                };
                
                document.getElementById('promptOkBtn').onclick = () => close(input.value);
                document.getElementById('promptCancelBtn').onclick = () => close(null);
                
                input.onkeydown = (e) => { if(e.key === 'Enter') document.getElementById('promptOkBtn').click(); };
                
                toggleModal(modalId, true);
                setTimeout(() => input.focus(), 100); // Focus after animation starts
            });
        }
        function customSelect(msg, title="Select", opts=[], def="") {
            return new Promise((resolve) => {
                const modalId = 'customSelectOverlay';
                document.getElementById('selectTitle').innerText = title;
                document.getElementById('selectMessage').innerText = msg;
                const select = document.getElementById('selectInput');
                select.innerHTML = '';
                opts.forEach(opt => { const o = document.createElement('option'); o.value = opt.value; o.innerText = opt.label; if(opt.value===def) o.selected=true; select.appendChild(o); });
                
                const close = (val) => { 
                    toggleModal(modalId, false); 
                    resolve(val); 
                };
                
                document.getElementById('selectOkBtn').onclick = () => close(select.value);
                document.getElementById('selectCancelBtn').onclick = () => close(null);
                
                toggleModal(modalId, true);
                setTimeout(() => select.focus(), 100);
            });
        }

        // 4. MAIN ADMIN RENDER
        async function renderAdminView() {
            // Load everything independently so one error doesn't stop the others
            loadAdminUsers().catch(e => console.error("Users Load Failed:", e));
            loadAdminLogs().catch(e => console.error("Logs Load Failed:", e));
            loadAdminPenalCodes().catch(e => console.error("Penal Codes Load Failed:", e));
            loadAdminRegistrations().catch(e => console.error("Registrations Load Failed:", e));
        }

        // --- FILTER FUNCTION ---
        function filterAdminTable(type) {
            const term = document.getElementById(`search-${type}`).value.toLowerCase();
            let data = [];
            let renderFn = null;

            if (type === 'users') { data = adminData.users; renderFn = renderUsersTable; }
            else if (type === 'shifts') { data = adminData.shifts; renderFn = renderShiftsTable; }
            else if (type === 'citations') { data = adminData.citations; renderFn = renderCitationsTable; }
            else if (type === 'arrests') { data = adminData.arrests; renderFn = renderArrestsTable; }
            else if (type === 'warrants') { data = adminData.warrants; renderFn = renderWarrantsTable; }

            const filtered = data.filter(item => JSON.stringify(item).toLowerCase().includes(term));
            renderFn(filtered);
        }

        // --- 1. USERS ---
    async function loadAdminUsers() {
        const tbody = document.getElementById('adminUsersBody');
        
        // Access the header container (the div containing the title and search bar)
        const headerContainer = tbody.closest('div').previousElementSibling; 
        
        // Check if our custom action container exists; if not, create it
        if (!headerContainer.querySelector('.admin-user-actions')) {
            const searchInput = headerContainer.querySelector('input');
            
            // 1. Create a container to hold both buttons side-by-side
            const actionContainer = document.createElement('div');
            actionContainer.className = 'admin-user-actions flex items-center mr-2 gap-2'; 
            
            // 2. Create the "Monthly Quota" Button
            const quotaBtn = document.createElement('button');
            quotaBtn.className = 'px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold transition-colors shadow-sm flex items-center gap-1';
            quotaBtn.innerHTML = '<i class="ph-bold ph-chart-pie-slice"></i> Quota';
            quotaBtn.onclick = openQuotaModal; 
            
            // 3. Create the "Add User" Button
            // 3. Create the "Add User" Button
            const addBtn = document.createElement('button');
            addBtn.id = 'addUserBtn';
            addBtn.className = 'px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold transition-colors shadow-sm flex items-center gap-1';
            addBtn.innerHTML = '<i class="ph-bold ph-plus"></i> Add';
            addBtn.onclick = () => {
                // Open Modal
                toggleModal('createUserModalOverlay', true);

                // Clear Text Inputs
                if(document.getElementById('newUsername')) document.getElementById('newUsername').value = '';
                if(document.getElementById('newBadge')) document.getElementById('newBadge').value = '';
                if(document.getElementById('newDept')) document.getElementById('newDept').value = '';

                // FIX: Reset Checkboxes (instead of trying to set value on a missing dropdown)
                const roleCheckboxes = document.querySelectorAll('input[name="newRoles"]');
                roleCheckboxes.forEach(cb => {
                    // Default 'officer' to checked, others unchecked
                    cb.checked = (cb.value === 'officer');
                });
            };

            // 4. Append buttons to the container, then insert container before the search bar
            actionContainer.appendChild(quotaBtn);
            actionContainer.appendChild(addBtn);
            headerContainer.insertBefore(actionContainer, searchInput);
        }

        // Standard loading logic...
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400"><i class="ph-duotone ph-spinner animate-spin"></i></td></tr>';
        const users = await apiRequest('/admin/users');
        
        adminData.users = (users || []).sort((a, b) => a.id - b.id);
        renderUsersTable(adminData.users);
    }

    function renderUsersTable(users) {
        const tbody = document.getElementById('adminUsersBody');
        document.getElementById('count-users').innerText = users.length;
        tbody.innerHTML = '';
        if (users.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400">No users found.</td></tr>'; 
            return; 
        }

        users.forEach(user => {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50';
            
            // Handle Role Display (Array or String)
            let rolesDisplay = '';
            let rolesArray = [];
            
            if (Array.isArray(user.role)) rolesArray = user.role;
            else if (typeof user.role === 'string') {
                 // Try parsing if it looks like an array string, otherwise just use it
                 if(user.role.startsWith('[')) {
                     try { rolesArray = JSON.parse(user.role); } catch(e) { rolesArray = [user.role]; }
                 } else {
                     rolesArray = [user.role];
                 }
            }
            
            // Map roles to badges
            rolesDisplay = rolesArray.map(r => {
                let color = 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300';
                if(r === 'admin') color = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400';
                if(r === 'moderator') color = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
                if(r === 'manager') color = 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400';
                return `<span class="px-2 py-1 rounded-md text-xs font-bold uppercase ${color} mr-1">${r}</span>`;
            }).join('');

            const pwdResetBadge = user.mustChangePassword ? `<span class="ml-2 text-[10px] bg-amber-100 text-amber-800 px-1.5 py-0.5 rounded border border-amber-200">Pwd Reset</span>` : '';

            // Safe encode for HTML attribute
            const safeRoles = JSON.stringify(rolesArray).replace(/"/g, '&quot;');

            row.innerHTML = `
                <td class="py-3 px-6 text-sm text-slate-500 font-mono">${user.id}</td>
                <td class="py-3 px-6 text-sm font-medium text-slate-900 dark:text-white flex items-center">${user.username} ${pwdResetBadge}</td>
                <td class="py-3 px-6 text-sm text-slate-500">${user.badge_number || 'N/A'}</td>
                <td class="py-3 px-6 text-sm font-bold text-emerald-600 dark:text-emerald-400">0</td> 
                <td class="py-3 px-6 text-sm">${rolesDisplay}</td>
                <td class="py-3 px-6 text-right flex justify-end gap-2">
                    <button onclick="adminResetPassword(${user.id})" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg transition-colors" title="Reset Password"><i class="ph-bold ph-key"></i></button>
                    <button onclick="adminPromoteUser(${user.id}, ${safeRoles})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit Roles"><i class="ph-bold ph-user-gear"></i></button>
                    <button onclick="adminDeleteUser(${user.id})" class="p-2 text-rose-600 hover:bg-rose-50 rounded-lg transition-colors" title="Delete"><i class="ph-bold ph-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

        // --- 2. LOGS (SHIFTS, CITATIONS, ARRESTS, WARRANTS) ---
        async function loadAdminLogs() {
    const loadingRow = '<tr><td colspan="100%" class="text-center py-4 text-slate-400"><i class="ph-duotone ph-spinner animate-spin"></i></td></tr>';
    
    // Set loading
    ['adminShiftsBody', 'adminCitationsBody', 'adminArrestsBody', 'adminWarrantsBody'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = loadingRow;
    });

    const [shiftsRes, citationsRes, arrestsRes, warrantsRes] = await Promise.allSettled([
        // UPDATED: Use new pagination endpoint with limit 100
        apiRequest('/v1/shifts?limit=100'), 
        apiRequest('/citations'),
        apiRequest('/arrests'),
        apiRequest('/warrant-logs')
    ]);

    // Handle Shifts Response structure (likely { data: [], nextCursor: ... })
    let shiftData = [];
    if (shiftsRes.status === 'fulfilled' && shiftsRes.value) {
        // Check if response is array or object with data property
        shiftData = Array.isArray(shiftsRes.value) ? shiftsRes.value : (shiftsRes.value.data || []);
    }

    adminData.shifts = shiftData;
    adminData.citations = (citationsRes.status === 'fulfilled' && Array.isArray(citationsRes.value)) ? citationsRes.value : [];
    adminData.arrests = (arrestsRes.status === 'fulfilled' && Array.isArray(arrestsRes.value)) ? arrestsRes.value : [];
    adminData.warrants = (warrantsRes.status === 'fulfilled' && Array.isArray(warrantsRes.value)) ? warrantsRes.value : [];

    renderShiftsTable(adminData.shifts);
    renderCitationsTable(adminData.citations);
    renderArrestsTable(adminData.arrests);
    renderWarrantsTable(adminData.warrants);
}
        // --- BULK DELETE HELPERS ---
        function toggleSelectAll(source, bodyId) {
            const checkboxes = document.querySelectorAll(`#${bodyId} input.row-checkbox`);
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function performBulkDelete(endpoint, bodyId, typeLabel) {
            const checkboxes = document.querySelectorAll(`#${bodyId} input.row-checkbox:checked`);
            if (checkboxes.length === 0) return customAlert("Please select items to delete.", "Selection Empty");

            if (!await customConfirm(`Permanently delete ${checkboxes.length} selected ${typeLabel}(s)?`, "Confirm Bulk Delete", "Delete Selected", true)) return;

            // 1. Gather all IDs into an array
            const ids = Array.from(checkboxes).map(cb => cb.value);

            // 2. Send a SINGLE batch request with the IDs in the body
            const result = await apiRequest(endpoint, 'DELETE', { ids: ids });
            
            if (result) {
                 customAlert(`Successfully deleted ${ids.length} items.`, "Batch Complete");
                 loadAdminLogs(); // Refresh all tables to remove deleted items
                 
                 // Uncheck the "Select All" header checkbox
                 const headerCheck = document.querySelector(`input[onchange*="${bodyId}"]`);
                 if(headerCheck) headerCheck.checked = false;
            }
        }

        // --- GENERIC DELETE HELPER ---
        async function deleteRecord(endpoint, typeLabel) {
            if (!await customConfirm(`Are you sure you want to permanently delete this ${typeLabel}?`, "Confirm Deletion", "Delete", true)) return;

            try {
                // Calls the API with DELETE method
                const result = await apiRequest(endpoint, 'DELETE');
                if (result) {
                    customAlert(`${typeLabel} deleted successfully.`, "Success");
                    // Refresh the tables to show it's gone
                    loadAdminLogs(); 
                }
            } catch (e) {
                console.error(e);
                customAlert(`Failed to delete ${typeLabel}.`, "Error");
            }
        }

        function renderShiftsTable(data) {
    const tbody = document.getElementById('adminShiftsBody');
    document.getElementById('count-shifts').innerText = data.length;
    tbody.innerHTML = '';
    
    if (data.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400 text-sm">No logs found.</td></tr>'; 
        return; 
    }

    // Update bulk action header button to be a dropdown or split buttons if needed, 
    // or simply add two buttons in the HTML above the table. 
    // For now, ensure the HTML header has:
    // <button onclick="adminBulkShiftAction('accept')">Accept Selected</button>
    // <button onclick="adminBulkShiftAction('deny')">Deny Selected</button>

    data.forEach(log => {
        const duration = log.duration || "Active/Unknown";
        const officerName = log.username || "Unknown";
        const proofUrl = log.screenshot;
        const status = log.status || 'pending'; // Assuming API returns status

        let statusBadge = `<span class="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600">Pending</span>`;
        if (status === 'accepted') statusBadge = `<span class="px-2 py-1 rounded text-xs font-bold bg-emerald-100 text-emerald-600">Accepted</span>`;
        if (status === 'denied') statusBadge = `<span class="px-2 py-1 rounded text-xs font-bold bg-rose-100 text-rose-600">Denied</span>`;

        const proof = proofUrl
            ? `<div class="flex justify-center"><button onclick="openProofModal('${proofUrl}')" class="inline-flex items-center gap-1 text-blue-500 hover:text-blue-600 text-xs font-bold"><i class="ph-bold ph-eye"></i> View</button></div>` 
            : `<div class="flex justify-center"><span class="text-xs text-slate-400">None</span></div>`;

        tbody.innerHTML += `
        <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">
            <td class="py-3 px-4 text-center w-10">
                <label class="relative flex items-center justify-center cursor-pointer group">
                    <input type="checkbox" class="row-checkbox peer sr-only" value="${log.id}">
                    <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-blue-600"></div>
                </label>
            </td>
            <td class="py-3 px-6 text-sm text-slate-500 whitespace-nowrap">
                ${new Date(log.created_at || log.timestamp).toLocaleDateString()}
            </td>
            <td class="py-3 px-6 text-sm font-medium text-slate-900 dark:text-white">
                ${officerName}
            </td>
            <td class="py-3 px-6 text-sm font-mono">${duration}</td>
            <td class="py-3 px-6 text-center">${statusBadge}</td>
            <td class="py-3 px-6 text-center">${proof}</td>
            <td class="py-3 px-6 text-right">
                <div class="flex items-center justify-end gap-2">
                    <button onclick="adminShiftAction('${log.id}', 'accept')" class="p-2 bg-emerald-100 text-emerald-600 rounded-lg hover:bg-emerald-200" title="Accept">
                        <i class="ph-bold ph-check"></i>
                    </button>
                    <button onclick="adminShiftAction('${log.id}', 'deny')" class="p-2 bg-rose-100 text-rose-600 rounded-lg hover:bg-rose-200" title="Deny">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>
            </td>
        </tr>`;
    });
}

        function renderCitationsTable(data) {
            const tbody = document.getElementById('adminCitationsBody');
            if (!tbody) return; 
            const counter = document.getElementById('admin-count-citations') || document.getElementById('count-citations');
            if (counter) counter.innerText = Array.isArray(data) ? data.length : 0;
            tbody.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400 text-sm">No citations found.</td></tr>'; 
                return; 
            }
            
            data.forEach(c => {
                tbody.innerHTML += `<tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                    <td class="py-3 px-4 text-center w-10">
                        <label class="relative flex items-center justify-center cursor-pointer group">
                            <input type="checkbox" class="row-checkbox peer sr-only" value="${c.id}">
                            <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                            <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                        </label>
                    </td>
                    <td class="py-3 px-4 text-sm font-medium text-slate-900 dark:text-white">${c.violatorDisplayName || c.violatorName || 'Unknown'}</td>
                    <td class="py-3 px-4 text-sm text-slate-500">${c.submittedBy || 'Unknown'}</td>
                    <td class="py-3 px-4 text-sm text-right font-mono text-emerald-600 dark:text-emerald-400">$${c.totalAmountDue || '0.00'}</td>
                    <td class="py-3 px-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="showTransactionDetails('citation', '${c.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-xs font-bold text-slate-600 dark:text-slate-200 transition-colors">
                                <i class="ph-bold ph-eye"></i>
                            </button>
                            <button onclick="adminDeleteCitation('${c.id}')" class="p-2 bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-lg hover:bg-rose-200 dark:hover:bg-rose-800 transition-colors" title="Delete Citation">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
        }

        function renderArrestsTable(data) {
            const tbody = document.getElementById('adminArrestsBody');
            if (!tbody) return;
            const counter = document.getElementById('admin-count-arrests') || document.getElementById('count-arrests');
            if (counter) counter.innerText = Array.isArray(data) ? data.length : 0;
            tbody.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400 text-sm">No arrests found.</td></tr>'; 
                return; 
            }
            
            data.forEach(a => {
                const jailTimeVal = parseFloat(a.totalJailTime || a.jailTime || a.jail_time || 0).toFixed(0);
                const fineVal = parseFloat(a.totalFines || a.fine || a.amount || 0).toFixed(2);
                let suspectDisplay = a.suspectDisplayName || a.suspectName || a.suspect;
                if (!suspectDisplay && a.details && a.details.suspectName) suspectDisplay = a.details.suspectName;
                if (!suspectDisplay) suspectDisplay = 'Unknown Suspect';
                const officerDisplay = a.submittedBy || a.officerName || 'Unknown Officer';

                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                        <td class="py-3 px-4 text-center w-10">
                            <label class="relative flex items-center justify-center cursor-pointer group">
                                <input type="checkbox" class="row-checkbox peer sr-only" value="${a.id}">
                                <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                                <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                            </label>
                        </td>
                        <td class="py-3 px-4 text-sm font-medium text-slate-900 dark:text-white">
                            ${suspectDisplay}
                        </td>
                        <td class="py-3 px-4 text-sm text-slate-500">
                            ${officerDisplay}
                        </td>
                        <td class="py-3 px-4 text-sm text-right text-slate-600 dark:text-slate-300 text-xs">
                            ${jailTimeVal}s / $${fineVal}
                        </td>
                        <td class="py-3 px-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="showTransactionDetails('arrest', '${a.id}')" class="p-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-xs font-bold text-slate-600 dark:text-slate-200 transition-colors">
                                    <i class="ph-bold ph-eye"></i>
                                </button>
                                <button onclick="adminDeleteArrest('${a.id}')" class="p-2 bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-lg hover:bg-rose-200 dark:hover:bg-rose-800 transition-colors" title="Delete Arrest">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function renderWarrantsTable(data) {
            const tbody = document.getElementById('adminWarrantsBody');
            document.getElementById('count-warrants').innerText = data.length;
            tbody.innerHTML = '';
            
            if (data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400 text-sm">No warrants.</td></tr>'; 
                return; 
            }
            
            data.forEach(w => {
                tbody.innerHTML += `<tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                    <td class="py-3 px-4 text-center w-10">
                        <label class="relative flex items-center justify-center cursor-pointer group">
                            <input type="checkbox" class="row-checkbox peer sr-only" value="${w.id}">
                            <div class="w-5 h-5 bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-focus:ring-2 peer-focus:ring-rose-500/30 transition-all duration-200 shadow-sm group-hover:border-rose-400 dark:group-hover:border-rose-500"></div>
                            <i class="ph-bold ph-check absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-xs opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all duration-200"></i>
                        </label>
                    </td>
                    <td class="py-3 px-6 text-sm font-medium text-slate-900 dark:text-white">${w.userReceivingWarrant}</td>
                    <td class="py-3 px-6 text-sm text-slate-500">${w.submittedByUsername}</td>
                    <td class="py-3 px-6 text-sm text-slate-500 text-xs">${w.dateOfIssue}</td>
                    <td class="py-3 px-6 text-sm text-slate-500 text-xs italic truncate max-w-xs" title="${w.notes}">${w.notes}</td>
                    <td class="py-3 px-6 text-right">
                        <button onclick="adminDeleteWarrant('${w.id}')" class="p-2 bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-lg hover:bg-rose-200 dark:hover:bg-rose-800 transition-colors" title="Delete Warrant">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
        }

        // --- 3. PENAL CODES & REGISTRATIONS ---
        async function loadAdminPenalCodes() {
            const tbody = document.getElementById('adminPCBody');
            
            const headerContainer = tbody.closest('div').previousElementSibling; 
            if (!headerContainer.querySelector('#addCodeBtn')) {
                const btn = document.createElement('button');
                btn.id = 'addCodeBtn';
                btn.className = 'px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold transition-colors shadow-sm ml-auto';
                btn.innerHTML = '<i class="ph-bold ph-plus"></i> Add';
                // FIX: Use toggleModal
                btn.onclick = () => openPenalCodeModal('add');
                headerContainer.appendChild(btn);
            }

            const codes = await apiRequest('/penal-codes');
            document.getElementById('count-pc').innerText = codes ? codes.length : 0;
            tbody.innerHTML = '';
            
            if (!codes || codes.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400">No penal codes.</td></tr>'; 
                return; 
            }

            codes.sort((a,b) => a.code.localeCompare(b.code, undefined, {numeric: true, sensitivity: 'base'}));

            codes.forEach((pc, index) => { // Added index for animation delay
                const safeData = JSON.stringify({
                    id: pc.id, code: pc.code, desc: pc.description, fine: pc.amount_due, jail: pc.jail_time_seconds, type: pc.type
                }).replace(/"/g, '&quot;');

                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 dark:border-slate-800 group hover:bg-slate-50 dark:hover:bg-slate-800/50 table-row-animate" style="animation-delay: ${index * 30}ms">
                        <td class="py-2 px-6 text-sm font-bold text-slate-700 dark:text-slate-300 font-mono">${pc.code}</td>
                        <td class="py-2 px-6 text-sm text-slate-600 dark:text-slate-400">${pc.description}</td>
                        <td class="py-2 px-6 text-sm font-mono text-emerald-600 dark:text-emerald-400">$${pc.amount_due}</td>
                        <td class="py-2 px-6 text-right opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openPenalCodeModal('edit', ${safeData})" class="p-1.5 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button onclick="deletePenalCode(${pc.id})" class="p-1.5 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 rounded"><i class="ph-bold ph-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        async function loadAdminRegistrations() {
            const tbody = document.getElementById('adminRegBody');
            if (!tbody) return;

            // Loading Spinner
            tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400"><i class="ph-duotone ph-spinner animate-spin"></i></td></tr>';
            
            const data = await apiRequest('/admin/all-registrations');
            tbody.innerHTML = '';
            
            if (!data || !data.registrations || data.registrations.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400">No registrations found.</td></tr>'; 
                return; 
            }
            
            document.getElementById('count-reg').innerText = data.registrations.length;
            
            data.registrations.forEach(reg => {
                // --- FIX: USE THE SHARED HELPER FOR CONSISTENT COLORS ---
                const banBadge = getBanBadgeHTML(reg.ban_lvl);
                // --------------------------------------------------------
                
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <td class="py-2 px-6 text-sm font-bold text-slate-900 dark:text-white font-mono">
                            ${reg.plate} <span class="text-xs font-normal text-slate-400 font-sans ml-1">(${reg.state})</span>
                        </td>
                        <td class="py-2 px-6 text-sm text-slate-600 dark:text-slate-400">
                            ${reg.owner_username}
                        </td>
                        <td class="py-2 px-6 text-sm text-slate-600 dark:text-slate-400">
                            ${reg.brand || 'Trailer'} ${reg.model}
                        </td>
                        <td class="py-2 px-6 text-sm">
                            ${banBadge}
                        </td>
                    </tr>`;
            });
        }

        // --- 4. ADMIN ACTIONS ---
    function adminPromoteUser(id, currentRoles) {
        // Ensure currentRoles is an array
        const roles = Array.isArray(currentRoles) ? currentRoles : [currentRoles];
        
        // Set User ID
        document.getElementById('editRoleUserId').value = id;
        
        // Reset and check appropriate boxes
        document.querySelectorAll('input[name="editRoles"]').forEach(cb => {
            cb.checked = roles.includes(cb.value);
        });
        
        toggleModal('editRoleModalOverlay', true);
    }

    // --- ADD THIS FUNCTION ---
    async function adminDeleteUser(id) {
        if (!await customConfirm("Are you sure you want to delete this user? This action cannot be undone.", "Delete User", "Delete Forever", true)) {
            return;
        }

        // Show loading state if possible, or just call API
        try {
            const result = await apiRequest(`/admin/users/${id}`, 'DELETE');
            
            if (result) {
                await customAlert("User has been permanently deleted.", "User Deleted");
                loadAdminUsers(); // Refresh the table
            }
        } catch (error) {
            console.error("Delete failed:", error);
            customAlert("Failed to delete user.", "Error");
        }
    }
    async function submitEditRoleForm(e) {
        e.preventDefault();
        
        const id = document.getElementById('editRoleUserId').value;
        const selectedRoles = Array.from(document.querySelectorAll('input[name="editRoles"]:checked')).map(cb => cb.value);
        
        if (selectedRoles.length === 0) {
            return customAlert("User must have at least one role.", "Error");
        }

        // Send payload. NOTE: We send { role: [...] } because your backend likely looks for 'role' property.
        // If your backend specifically updated 'roles', ensure the backend code maps it.
        // Based on standard practices, we send the array.
        const payload = { role: selectedRoles };

        const btn = e.submitter;
        btn.disabled = true;
        
        try {
            // Using existing endpoint
            const result = await apiRequest(`/admin/users/${id}`, 'PUT', payload);
            if(result) {
                toggleModal('editRoleModalOverlay', false);
                customAlert(`Roles updated to: ${selectedRoles.join(', ')}`, "Success");
                loadAdminUsers();
            }
        } catch(err) {
            console.error(err);
            customAlert("Failed to update roles.", "Error");
        } finally {
            btn.disabled = false;
        }
    }
        // --- DEPARTMENT TRANSFER LOGIC ---

        async function submitDeptTransfer(e) {
            e.preventDefault();
            const newDept = document.getElementById('transfer-new').value;
            const reason = document.getElementById('transfer-reason').value;
            
            if(!newDept || !reason) return customAlert("Please select a department and provide a reason.", "Missing Info");
            
            const confirmed = await customConfirm(`Request transfer to ${newDept}?`, "Confirm Transfer", "Yes, Request", false);
            if(!confirmed) return;

            // If this returns 409, apiRequest handles the alert and returns null
            const result = await apiRequest('/api/user/request-department', 'POST', {
                newDepartment: newDept,
                reason: reason
            });

            // Only runs if successful (200 OK)
            if(result) {
                const successMsg = (result && result.message) ? result.message : "Your transfer request has been submitted successfully.";
                customAlert(successMsg, "Request Sent");
                document.getElementById('transfer-reason').value = ""; 
            }
        }

        // 2. Admin Loads Requests
        async function loadAdminTransfers() {
            const tbody = document.getElementById('adminTransfersBody');
            const counter = document.getElementById('count-transfers');
            tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400"><i class="ph-duotone ph-spinner animate-spin"></i></td></tr>';
            
            const requests = await apiRequest('/admin/department-requests');
            tbody.innerHTML = '';
            
            if(!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-slate-400">No pending requests.</td></tr>';
                if(counter) counter.innerText = "0";
                return;
            }
            
            if(counter) counter.innerText = requests.length;

            requests.forEach(req => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50';
                row.innerHTML = `
                    <td class="py-3 px-6 font-medium text-slate-900 dark:text-white">${req.username}</td>
                    <td class="py-3 px-6 text-slate-500">${req.current_dept}</td>
                    <td class="py-3 px-6 font-bold text-emerald-600 dark:text-emerald-400">${req.requested_dept}</td>
                    <td class="py-3 px-6 text-slate-500 text-xs italic max-w-xs truncate" title="${req.reason}">${req.reason}</td>
                    <td class="py-3 px-6 text-right flex justify-end gap-2">
                        <button onclick="processTransfer(${req.id}, 'approve', '${req.username}')" class="p-1.5 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 transition-colors" title="Approve"><i class="ph-bold ph-check"></i></button>
                        <button onclick="processTransfer(${req.id}, 'deny', '${req.username}')" class="p-1.5 bg-rose-100 text-rose-700 rounded hover:bg-rose-200 transition-colors" title="Deny"><i class="ph-bold ph-x"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 3. Admin Processes Request
        async function processTransfer(id, action, username) {
            const isApprove = action === 'approve';
            const confirmed = await customConfirm(
                `Are you sure you want to ${isApprove ? 'APPROVE' : 'DENY'} the transfer for ${username}?`, 
                isApprove ? "Approve Transfer" : "Deny Transfer",
                isApprove ? "Approve" : "Deny",
                !isApprove // Red button if denying
            );
            
            if(!confirmed) return;

            const result = await apiRequest('/admin/department-requests/process', 'POST', {
                requestId: id,
                action: action
            });

            if(result) {
                customAlert(result.message, "Processed");
                loadAdminTransfers(); // Reload table
                // If we changed our own department (unlikely but possible), update session
                if(isApprove && username === JSON.parse(sessionStorage.getItem('user')).username) {
                    location.reload(); // Force reload to update UI with new dept
                } else {
                    loadAdminUsers(); // Refresh main user list too
                }
            }
        }

        // --- STATE AUTOCOMPLETE LOGIC ---
        const US_STATES = [
            { code: "OT", name: "Other / Canada" },
            { code: "AL", name: "Alabama" }, { code: "AK", name: "Alaska" }, { code: "AZ", name: "Arizona" }, { code: "AR", name: "Arkansas" },
            { code: "CA", name: "California" }, { code: "CO", name: "Colorado" }, { code: "CT", name: "Connecticut" }, { code: "DC", name: "District Of Columbia" }, { code: "DE", name: "Delaware" },
            { code: "FL", name: "Florida" }, { code: "GA", name: "Georgia" }, { code: "HI", name: "Hawaii" }, { code: "ID", name: "Idaho" },
            { code: "IL", name: "Illinois" }, { code: "IN", name: "Indiana" }, { code: "IA", name: "Iowa" }, { code: "KS", name: "Kansas" },
            { code: "KY", name: "Kentucky" }, { code: "LA", name: "Louisiana" }, { code: "ME", name: "Maine" }, { code: "MD", name: "Maryland" },
            { code: "MA", name: "Massachusetts" }, { code: "MI", name: "Michigan" }, { code: "MN", name: "Minnesota" }, { code: "MS", name: "Mississippi" },
            { code: "MO", name: "Missouri" }, { code: "MT", name: "Montana" }, { code: "NE", name: "Nebraska" }, { code: "NV", name: "Nevada" },
            { code: "NH", name: "New Hampshire" }, { code: "NJ", name: "New Jersey" }, { code: "NM", name: "New Mexico" }, { code: "NY", name: "New York" },
            { code: "NC", name: "North Carolina" }, { code: "ND", name: "North Dakota" }, { code: "OH", name: "Ohio" }, { code: "OK", name: "Oklahoma" },
            { code: "OR", name: "Oregon" }, { code: "PA", name: "Pennsylvania" }, { code: "RI", name: "Rhode Island" }, { code: "SC", name: "South Carolina" },
            { code: "SD", name: "South Dakota" }, { code: "TN", name: "Tennessee" }, { code: "TX", name: "Texas" }, { code: "UT", name: "Utah" },
            { code: "VT", name: "Vermont" }, { code: "VA", name: "Virginia" }, { code: "WA", name: "Washington" }, { code: "WV", name: "West Virginia" },
            { code: "WI", name: "Wisconsin" }, { code: "WY", name: "Wyoming" }
        ];

        function initStateSelector() {
            const input = document.getElementById('reg-search-state');
            const results = document.getElementById('reg-state-results');
            if(!input || !results) return;

            const renderStates = (filter = "") => {
                results.innerHTML = '';
                const term = filter.toUpperCase();
                // Filter logic
                const matches = US_STATES.filter(s => 
                    s.code.includes(term) || s.name.toUpperCase().includes(term)
                );

                if (matches.length === 0) {
                    results.innerHTML = `<div class="p-3 text-sm text-slate-400 text-center">No matching states.</div>`;
                    return;
                }

                matches.forEach(state => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <span class="dropdown-code">${state.code}</span>
                        <span class="dropdown-desc">${state.name}</span>
                    `;
                    // Prevent blur event from firing before click
                    item.onmousedown = (e) => e.preventDefault();
                    
                    item.onclick = () => {
                        input.value = state.code; // Set the 2-letter code
                        input.classList.add('filled');
                        results.classList.remove('show');
                    };
                    results.appendChild(item);
                });
            };

            // Event Listeners
            input.addEventListener('focus', () => {
                renderStates(input.value);
                results.classList.add('show');
            });

            input.addEventListener('input', () => {
                renderStates(input.value);
                results.classList.add('show');
            });

            input.addEventListener('blur', () => {
                setTimeout(() => results.classList.remove('show'), 200);
            });
        }

        // --- REGISTRY LOOKUP LOGIC ---
        // --- REGISTRY LOOKUP LOGIC (UPDATED) ---
        async function lookupPlate() {
            const plateInput = document.getElementById('reg-search-plate');
            const stateInput = document.getElementById('reg-search-state');
            const resultDiv = document.getElementById('registry-result');

            const plate = plateInput.value.trim().toUpperCase();
            const state = stateInput.value;

            if (!plate || !state) {
                return customAlert("Please enter a license plate and select a state.", "Missing Information");
            }

            // Show Loading
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="ph-duotone ph-spinner animate-spin text-4xl mb-3 text-blue-500"></i>
                    <span class="font-medium">Searching Registry Database...</span>
                </div>
            `;

            try {
                // Call API
                const data = await apiRequest(`/api/registry/lookup/${encodeURIComponent(plate)}/${encodeURIComponent(state)}`);

                if (data && data.type) {
                    // Success - Build Result Card
                    
                    // --- USE HELPER FOR BAN BADGE ---
                    const banBadge = getBanBadgeHTML(data.ban_lvl);
                    // --------------------------------

                    const icon = data.type === 'Trailer' ? 'ph-truck-trailer' : 'ph-car';

                    let historyButton = '';
                    if (data.owner_discord_id) {
                        historyButton = `
                            <button onclick="lookupCitizenHistory('${data.owner_discord_id}')" class="ml-2 inline-flex items-center gap-1 px-2 py-1 bg-slate-200 dark:bg-slate-700 hover:bg-blue-100 dark:hover:bg-blue-900/50 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 rounded text-xs font-bold transition-colors" title="View Criminal Record">
                                <i class="ph-bold ph-folder-user"></i> History
                            </button>
                        `;
                    }
                    
                    const dateOpts = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                    const regDate = data.registered_at ? new Date(data.registered_at).toLocaleString(undefined, dateOpts) : "Unknown";
                    const editDate = data.updated_at ? new Date(data.updated_at).toLocaleString(undefined, dateOpts) : "Never Edited";

                    resultDiv.innerHTML = `
                        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 flex flex-col md:flex-row gap-6 relative overflow-hidden">
                            <i class="ph-duotone ${icon} absolute -right-6 -bottom-6 text-9xl text-slate-200 dark:text-slate-800 opacity-50 pointer-events-none"></i>
                            
                            <div class="flex-1 space-y-4 relative z-10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                            ${data.plate}
                                            <span class="text-sm font-normal text-slate-500 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-2 rounded-md shadow-sm">${data.state}</span>
                                        </h3>
                                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mt-1">${data.year || ''} ${data.make || ''} ${data.model}</p>
                                    </div>
                                    ${banBadge}
                                </div>

                                <div class="grid grid-cols-2 gap-4 mt-4 bg-white dark:bg-slate-900 rounded-xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                                    <div>
                                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Owner</p>
                                        <div class="flex items-center flex-wrap">
                                            <p class="text-slate-900 dark:text-white font-medium truncate mr-1">${data.owner_username}</p>
                                            ${historyButton}
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Color</p>
                                        <p class="text-slate-900 dark:text-white font-medium flex items-center gap-2">
                                            <span class="w-3 h-3 rounded-full border border-slate-300 shadow-sm" style="background-color: ${data.color}"></span>
                                            ${data.color}
                                        </p>
                                    </div>
                                    
                                    <div class="border-t border-slate-100 dark:border-slate-800 pt-2 mt-2">
                                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Registered</p>
                                        <p class="text-slate-900 dark:text-white font-medium text-sm font-mono">${regDate}</p>
                                    </div>
                                    <div class="border-t border-slate-100 dark:border-slate-800 pt-2 mt-2">
                                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Last Update</p>
                                        <p class="text-slate-900 dark:text-white font-medium text-sm font-mono">${editDate}</p>
                                    </div>
                                    
                                    <div class="col-span-2 border-t border-slate-100 dark:border-slate-800 pt-2 mt-1">
                                         <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Vehicle Type</p>
                                         <p class="text-slate-900 dark:text-white font-medium">${data.type}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-rose-50 dark:bg-rose-900/10 border border-rose-100 dark:border-rose-900/30 rounded-2xl p-8 text-center">
                            <div class="w-16 h-16 bg-rose-100 dark:bg-rose-900/30 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ph-duotone ph-magnifying-glass-minus text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-bold text-rose-700 dark:text-rose-400">No Registration Found</h3>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">No vehicle found with plate <strong>${plate}</strong> in <strong>${state}</strong>.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = `<div class="text-center text-rose-500 py-4">Error connecting to registry database.</div>`;
            }
        }

        // --- CITIZEN HISTORY LOGIC (UPDATED) ---

        async function lookupCitizenHistory(manualId = null) {
            // Determine which ID to use (Manual button click OR Search Bar input)
            const searchInput = document.getElementById('history-search-id');
            const discordId = manualId || (searchInput ? searchInput.value.trim() : null);

            if (!discordId) return customAlert("No User ID found.", "Error");

            // Handle Loading UI
            // If triggered by the search bar button, we animate that specific button.
            // If triggered by the Registry card, we just run.
            let btn = null;
            if (!manualId && event && event.currentTarget) {
                btn = event.currentTarget;
                btn.disabled = true;
                btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Searching...`;
            }

            try {
                const data = await apiRequest(`/api/user/history/${discordId}`);
                
                if (data) {
                    renderHistoryModal(data);
                } else {
                    customAlert("No records found for this ID.", "Not Found");
                }
            } catch (e) {
                console.error(e);
                customAlert("Failed to fetch user history.", "Error");
            } finally {
                // Reset search bar button if it was used
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="ph-bold ph-file-search"></i> Get Details`;
                }
            }
        }

        // --- CITIZEN HISTORY LOGIC (Frontend) ---

        // 1. LOOKUP FUNCTION (Fetches data)
        async function lookupCitizenHistory(manualId = null) {
            // Determine which ID to use (Manual button click OR Search Bar input)
            const searchInput = document.getElementById('history-search-id');
            // If manualId is passed (from registry), use it. Otherwise check search bar.
            const discordId = (typeof manualId === 'string' ? manualId : null) || (searchInput ? searchInput.value.trim() : null);

            if (!discordId) return customAlert("No User ID found.", "Error");

            // Handle Loading UI
            let btn = null;
            // If triggered by a click event (not manual call), show loading on that button
            if (!manualId && event && event.currentTarget) {
                btn = event.currentTarget;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Searching...`;
                
                // Store reset callback
                btn._reset = () => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                };
            }

            try {
                const data = await apiRequest(`/api/user/history/${discordId}`);
                
                if (data) {
                    renderHistoryModal(data); // <--- This is the function you were missing
                } else {
                    customAlert("No records found for this ID.", "Not Found");
                }
            } catch (e) {
                console.error(e);
                customAlert("Failed to fetch user history.", "Error");
            } finally {
                if (btn && btn._reset) btn._reset();
            }
        }

        // 2. RENDER FUNCTION (Shows the popup) - THIS WAS MISSING
        function renderHistoryModal(data) {
            const modal = document.getElementById('historyModalOverlay');
            const modalContent = modal.firstElementChild;
            
            // 1. Header Info
            document.getElementById('historyName').innerText = data.displayName || "Unknown Citizen";
            document.getElementById('historyId').innerText = `ID: ${data.discordId}`;
            document.getElementById('historyFines').innerText = `$${data.outstandingFines || '0.00'}`;
            
            // 2. Avatar
            const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${data.displayName}`;
            document.getElementById('historyAvatar').src = defaultAvatar;
            if(typeof fetchRobloxAvatar === 'function') {
                fetchRobloxAvatar(data.displayName).then(url => {
                    if(url) document.getElementById('historyAvatar').src = url;
                });
            }

            // 3. Warrants
            const warrantList = document.getElementById('historyWarrantsList');
            const warrantSection = document.getElementById('historyWarrantsSection');
            warrantList.innerHTML = '';
            
            if (data.warrants && data.warrants.length > 0) {
                warrantSection.classList.remove('hidden');
                data.warrants.forEach(w => {
                    warrantList.innerHTML += `
                        <div class="bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 p-4 rounded-xl flex items-start gap-4">
                            <div class="bg-rose-100 dark:bg-rose-900/50 text-rose-600 p-2 rounded-lg shrink-0"><i class="ph-bold ph-warning text-xl"></i></div>
                            <div>
                                <h5 class="font-bold text-rose-700 dark:text-rose-400">WARRANT ISSUED</h5>
                                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">${w.notes || 'No details.'}</p>
                                <p class="text-xs text-slate-400 mt-2 font-mono">Issued: ${w.dateOfIssue || 'Unknown'} by ${w.submittedByUsername || 'Unknown'}</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                warrantSection.classList.add('hidden');
            }

            // 4. Arrests (FIXED)
            const arrestList = document.getElementById('historyArrestsList');
            arrestList.innerHTML = '';
            if (data.arrests && data.arrests.length > 0) {
                data.arrests.forEach(a => {
                    const isPaid = a.paidStatus;
                    const statusClass = isPaid ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400" : "bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400";
                    const statusText = isPaid ? "PAID" : "UNPAID";
                    const jailTimeVal = parseFloat(a.totalJailTime || a.jailTime || a.jail_time || 0).toFixed(0);
                    const fineVal = parseFloat(a.totalFines || 0).toFixed(2);
                    const timeString = a.timestamp ? new Date(a.timestamp).toLocaleString() : 'Unknown Date';
                    
                    arrestList.innerHTML += `
                        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-xl flex justify-between items-center shadow-sm">
                            <div>
                                <p class="text-sm font-bold text-slate-800 dark:text-white">Arrest Record #${(a.id || '???').substring(0,6)}</p>
                                <p class="text-xs text-slate-500">${timeString}  Officer ${a.submittedBy || 'Unknown'}</p>
                                <p class="text-xs text-slate-500 mt-1">Fines: $${fineVal} | Jail: ${jailTimeVal}s</p>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${statusClass}">${statusText}</span>
                        </div>
                    `;
                });
            } else {
                arrestList.innerHTML = `<div class="text-center py-4 text-slate-400 text-sm italic">No prior arrests found.</div>`;
            }

            // 5. Citations
            const citeList = document.getElementById('historyCitationsList');
            citeList.innerHTML = '';
            if (data.citations && data.citations.length > 0) {
                data.citations.forEach(c => {
                    const isPaid = c.paidStatus;
                    const statusClass = isPaid ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400" : "bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400";
                    const statusText = isPaid ? "PAID" : "UNPAID";
                    const timeString = c.timestamp ? new Date(c.timestamp).toLocaleString() : 'Unknown Date';

                    citeList.innerHTML += `
                        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-xl flex justify-between items-center shadow-sm">
                            <div>
                                <p class="text-sm font-bold text-slate-800 dark:text-white">Citation #${(c.id || '???').substring(0,6)}</p>
                                <p class="text-xs text-slate-500">${timeString}  Officer ${c.submittedBy || 'Unknown'}</p>
                                <p class="text-xs text-slate-500 mt-1">Amount: $${c.totalAmountDue || '0.00'}</p>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${statusClass}">${statusText}</span>
                        </div>
                    `;
                });
            } else {
                citeList.innerHTML = `<div class="text-center py-4 text-slate-400 text-sm italic">No citations found.</div>`;
            }

            // 6. Vehicles
            const vehList = document.getElementById('historyVehiclesList');
            vehList.innerHTML = '';
            const allVehicles = [...(data.vehicles || []), ...(data.trailers || [])];
            
            if (allVehicles.length > 0) {
                allVehicles.forEach(v => {
                    const plate = v.plate || "Unknown";
                    const desc = v.brand ? `${v.color || ''} ${v.brand} ${v.model || ''}` : `Trailer ${v.model || ''}`;
                    vehList.innerHTML += `
                        <div class="bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 p-3 rounded-xl flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-slate-700 flex items-center justify-center text-slate-400 shadow-sm">
                                <i class="ph-duotone ph-car text-xl"></i>
                            </div>
                            <div>
                                <p class="font-mono font-bold text-slate-900 dark:text-white">${plate}</p>
                                <p class="text-xs text-slate-500">${desc}</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                vehList.innerHTML = `<div class="col-span-full text-center py-4 text-slate-400 text-sm italic">No vehicles registered.</div>`;
            }

            // 7. Show Modal
            toggleModal('historyModalOverlay', true);
            modalContent.classList.remove('animate-modal-pop');
            void modalContent.offsetWidth; // Trigger reflow
            modalContent.classList.add('animate-modal-pop');
        }
        // --- PENAL CODE MODAL LOGIC ---
        // --- PENAL CODE MODAL LOGIC (With Search) ---
        function showPenalCodeModal() {
            const modal = document.getElementById('penalCodeListModalOverlay');
            const content = document.getElementById('penalCodeListModalContent');
            const searchInput = document.getElementById('penalCodeSearchInput');
            
            // Helper function to render specific list of codes
            const renderList = (list) => {
                content.innerHTML = '';

                if (!list || list.length === 0) {
                    content.innerHTML = '<div class="text-center text-slate-500 py-8">No matching codes found.</div>';
                    return;
                }

                list.forEach(pc => {
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 flex flex-col md:flex-row md:items-center justify-between gap-2';
                    
                    let typeClass = 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300';
                    if (pc.type.toLowerCase().includes('felony')) typeClass = 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400';
                    else if (pc.type.toLowerCase().includes('misdemeanor')) typeClass = 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400';
                    else if (pc.type.toLowerCase().includes('infraction')) typeClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';

                    item.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-mono font-bold text-blue-600 dark:text-blue-400 text-sm bg-blue-50 dark:bg-blue-900/20 px-1.5 py-0.5 rounded">${pc.code}</span>
                                <h4 class="font-bold text-slate-900 dark:text-white text-sm">${pc.desc}</h4>
                            </div>
                            <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${typeClass}">${pc.type}</span>
                        </div>
                        <div class="flex items-center gap-4 text-xs font-mono shrink-0">
                            <div class="text-right">
                                <span class="block text-slate-400 uppercase tracking-wider text-[10px]">Fine</span>
                                <span class="font-bold text-emerald-600 dark:text-emerald-400">$${parseFloat(pc.fine).toFixed(2)}</span>
                            </div>
                            <div class="text-right border-l border-slate-200 dark:border-slate-700 pl-4">
                                <span class="block text-slate-400 uppercase tracking-wider text-[10px]">Jail</span>
                                <span class="font-bold text-rose-600 dark:text-rose-400">${pc.jail}s</span>
                            </div>
                        </div>
                    `;
                    content.appendChild(item);
                });
            };

            // Initial Render (All Codes)
            const allCodes = [...(appState.penalCodes || [])].sort((a, b) => a.code.localeCompare(b.code));
            renderList(allCodes);

            // Setup Search Listener
            if (searchInput) {
                searchInput.value = ''; // Reset search on open
                searchInput.oninput = (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = allCodes.filter(pc => 
                        pc.code.toLowerCase().includes(term) || 
                        pc.desc.toLowerCase().includes(term) ||
                        pc.type.toLowerCase().includes(term)
                    );
                    renderList(filtered);
                };
                // Auto-focus the search bar
                setTimeout(() => searchInput.focus(), 100);
            }

            toggleModal('penalCodeListModalOverlay', true);
        }

        // Close Button Listener
        document.getElementById('penalCodeListModalCloseBtn').addEventListener('click', () => {
            document.getElementById('penalCodeListModalOverlay').classList.add('hidden');
        });

        // Close on Background Click
        document.getElementById('penalCodeListModalOverlay').addEventListener('click', (e) => {
            const modal = document.getElementById('penalCodeListModalOverlay');
            if (e.target === modal) modal.classList.add('hidden');
        });
        
        // --- ADMIN ALERT SYSTEM ---
        async function submitSystemAlert(e) {
            e.preventDefault();
            
            const btn = document.getElementById('alertSubmitBtn');
            const originalText = btn.innerHTML;
            const enabled = document.getElementById('alertEnabled').checked;
            const type = document.getElementById('alertType').value;
            const content = document.getElementById('alertContent').value;

            // UI Loading
            btn.disabled = true;
            btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Sending...`;

            const payload = {
                type: type,
                content: content,
                enabled: enabled
            };

            try {
                // apiRequest appends the base URL automatically
                const result = await apiRequest('/api/alerts', 'POST', payload);
                
                if (result) {
                    customAlert(`Alert ${enabled ? 'broadcasted' : 'disabled'} successfully.`, "System Alert");
                }
            } catch (error) {
                console.error(error);
                customAlert("Failed to send alert.", "Error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function showTransactionDetails(type, id) {
            // Determine which collection to search
            let collection = [];
            if (type === 'citation') collection = adminData.citations;
            else if (type === 'arrest') collection = adminData.arrests;
            else if (type === 'shift') collection = adminData.shifts;

            // Ensure ID comparison works (string vs number)
            const item = collection.find(i => String(i.id) === String(id));

            if (!item) return customAlert("Record details not found in cache. Try refreshing the page.", "Error");

            const modal = document.getElementById('detailsModalOverlay');
            const titleEl = document.getElementById('detailsModalTitle');
            const contentEl = document.getElementById('detailsModalContent');
            
            // --- HEADER SETUP ---
            let icon, color, label;
            if (type === 'shift') {
                icon = 'ph-clock'; color = 'text-purple-500'; label = 'Shift Log';
            } else if (type === 'citation') {
                icon = 'ph-ticket'; color = 'text-blue-500'; label = 'Citation Details';
            } else {
                icon = 'ph-siren'; color = 'text-rose-500'; label = 'Arrest Report';
            }
            
            titleEl.innerHTML = `<i class="ph-duotone ${icon} ${color}"></i> ${label} <span class="text-sm font-mono text-slate-400 ml-2">#${item.id.substring(0, 10)}...</span>`;

            // --- CONTENT GENERATION ---
            let html = '';

            if (type === 'shift') {
                // *** SHIFT LOG LAYOUT ***
                const duration = item.shiftDuration || item.duration || "N/A";
                const officer = item.submittedByUsername || item.submittedBy || "Unknown";
                const dept = item.submittedByDepartment || item.department || "Unknown";
                const badge = item.submittedByBadge || item.badgeNumber || "N/A";
                const rank = item.submittedByRank || item.rank || "N/A";
                const date = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'Unknown';
                const notes = item.additionalNotes || "No notes.";

                html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                        <h4 class="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wider">Officer Information</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-slate-500">Name:</span> <span class="font-medium text-slate-900 dark:text-white">${officer}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Badge:</span> <span class="font-mono text-slate-700 dark:text-slate-300">${badge}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Rank:</span> <span class="text-slate-700 dark:text-slate-300">${rank}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Dept:</span> <span class="text-slate-700 dark:text-slate-300">${dept}</span></div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                        <h4 class="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wider">Session Details</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-slate-500">Date:</span> <span class="text-slate-900 dark:text-white">${date}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Duration:</span> <span class="font-bold text-purple-600 dark:text-purple-400">${duration}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Host:</span> <span class="text-slate-700 dark:text-slate-300">${item.hostOfTheSession || item.host || "N/A"}</span></div>
                            <div class="flex justify-between"><span class="text-slate-500">Callsign:</span> <span class="font-mono text-slate-700 dark:text-slate-300">${item.callsign || "N/A"}</span></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-900/30">
                        <div class="text-xs text-blue-500 uppercase font-bold">Stops</div>
                        <div class="text-xl font-black text-blue-700 dark:text-blue-400">${item.trafficStops || 0}</div>
                    </div>
                    <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-900/30">
                        <div class="text-xs text-emerald-500 uppercase font-bold">Citations</div>
                        <div class="text-xl font-black text-emerald-700 dark:text-emerald-400">${item.citations || 0}</div>
                    </div>
                    <div class="p-3 bg-rose-50 dark:bg-rose-900/20 rounded-xl border border-rose-100 dark:border-rose-900/30">
                        <div class="text-xs text-rose-500 uppercase font-bold">Arrests</div>
                        <div class="text-xl font-black text-rose-700 dark:text-rose-400">${item.arrests || 0}</div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Additional Notes</h4>
                    <p class="p-4 bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-xl text-sm text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap font-sans">${notes}</p>
                </div>
                `;

                if (item.screenshotUrl || item.screenshot) {
                    const sUrl = getCorrectImageUrl(item.screenshotUrl || item.screenshot); // FIX APPLIED
                    html += `
                    <div>
                         <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Shift Proof</h4>
                         <img src="${sUrl}" class="max-h-64 rounded-lg border border-slate-200 dark:border-slate-700 object-contain bg-black/5 dark:bg-white/5">
                    </div>`;
                }

            } else {
                // *** CITATION / ARREST LAYOUT ***
                const officer = item.submittedByUsername || item.submittedBy || item.officerName || 'Unknown';
                const badge = item.officerBadge || item.submittedByBadge || item.arrestingOfficerBadge || 'N/A';
                const subject = item.violatorName || item.violatorDisplayName || item.suspectName || item.suspectDisplayName || 'Unknown';
                const date = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'Unknown';
                const amount = parseFloat(item.totalAmountDue || item.totalFines || 0).toFixed(2);
                
                // Get List of Codes
                let rawCodes = item.appliedPenalCodes || item.appliedCharges || item.penalCodes || item.penal_codes || item.charges || item.offenses || item.violationCodes || "";
                let formattedCodes = '<span class="text-slate-400 italic">No specific codes listed.</span>';
                
                if (rawCodes) {
                    let list = [];
                    if (Array.isArray(rawCodes)) list = rawCodes;
                    else if (typeof rawCodes === 'string') list = rawCodes.split(',');

                    if (list.length > 0) {
                        formattedCodes = list.map(c => {
                            let code = "Unknown";
                            let desc = "No description";
                            let fine = 0;
                            let jail = 0;
                            
                            // 1. Resolve Code Details
                            if (typeof c === 'object' && c !== null) {
                                // Data embedded in the record
                                code = c.code || "Unknown";
                                desc = c.description || c.desc || "No description";
                                fine = c.amount_due || c.fine || 0;
                                jail = c.jail_time_seconds || c.jail_time || c.jail || 0;
                            } else {
                                // String only - Lookup in App State
                                code = String(c).trim();
                                if(typeof appState !== 'undefined' && appState.penalCodes) {
                                    const found = appState.penalCodes.find(pc => pc.code === code);
                                    if(found) {
                                        desc = found.desc;
                                        fine = found.fine;
                                        jail = found.jail;
                                    }
                                }
                            }

                            // 2. Build Tooltip HTML
                            // Note: We use single quotes for attributes inside the HTML string to avoid conflicts
                            const tooltipHtml = `
                                <div class='font-bold text-amber-400 mb-1 text-sm'>${code}</div>
                                <div class='mb-2 text-slate-200 leading-snug'>${desc}</div>
                                <div class='flex gap-3 border-t border-slate-700 pt-2 text-xs'>
                                    <span class='text-slate-400'>Fine: <span class='text-emerald-400 font-bold'>$${parseFloat(fine).toFixed(2)}</span></span>
                                    <span class='text-slate-400'>Jail: <span class='text-rose-400 font-bold'>${jail}s</span></span>
                                </div>
                            `.replace(/"/g, "&quot;"); // Escape double quotes for the data attribute

                            return `<span class="cursor-help inline-block px-2 py-1 mb-1 mr-1 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs font-mono font-bold text-slate-700 dark:text-slate-300 transition-colors hover:bg-white dark:hover:bg-slate-600 hover:border-blue-400 dark:hover:border-blue-500" data-tooltip-content="${tooltipHtml}">${code}</span>`;
                        }).join('');
                    }
                }

                const narrative = item.incidentDetails || item.violationDetails || item.notes || item.narrative || "No narrative provided.";

                html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wider">Involved Parties</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-slate-500">Officer:</span> <span class="font-medium text-slate-900 dark:text-white">${officer}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Badge:</span> <span class="font-mono text-slate-700 dark:text-slate-300">${badge}</span></div>
                                <hr class="border-slate-200 dark:border-slate-700 my-2">
                                <div class="flex justify-between"><span class="text-slate-500">Subject:</span> <span class="font-medium text-slate-900 dark:text-white">${subject}</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Date:</span> <span class="text-slate-700 dark:text-slate-300">${date}</span></div>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wider">Outcome</h4>
                            <div class="space-y-2 text-sm">
                                 <div class="flex justify-between items-center">
                                    <span class="text-slate-500">Total Fine:</span> 
                                    <span class="text-lg font-bold text-emerald-600 dark:text-emerald-400">$${amount}</span>
                                </div>
                                ${item.jailTime || item.totalJailTime ? `
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500">Jail Sentence:</span> 
                                    <span class="text-lg font-bold text-rose-600 dark:text-rose-400">${item.jailTime || item.totalJailTime} seconds</span>
                                </div>` : ''}
                                <hr class="border-slate-200 dark:border-slate-700 my-2">
                                <div class="flex justify-between"><span class="text-slate-500">Status:</span> 
                                    ${item.paidStatus 
                                        ? '<span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 rounded text-xs font-bold">PAID</span>' 
                                        : '<span class="px-2 py-0.5 bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400 rounded text-xs font-bold">UNPAID</span>'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Charges / Codes</h4>
                        <div class="p-3 bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-xl">
                            ${formattedCodes}
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Narrative / Notes</h4>
                        <p class="p-4 bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-xl text-sm text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap font-sans">${narrative}</p>
                    </div>
                `;
                
                if (item.mugshotUrl || item.mugshot) {
                    const mUrl = getCorrectImageUrl(item.mugshotUrl || item.mugshot); // FIX APPLIED
                    html += `
                    <div>
                         <h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Mugshot</h4>
                         <img src="${mUrl}" class="max-h-64 rounded-lg border border-slate-200 dark:border-slate-700 object-contain bg-black/5 dark:bg-white/5">
                    </div>`;
                }
            }

            contentEl.innerHTML = html;
            toggleModal('detailsModalOverlay', true);
        }

        // --- PENAL CODE EDITOR LOGIC ---

        function openPenalCodeModal(mode, data = null) {
            const modal = document.getElementById('pcEditorModalOverlay');
            const title = document.getElementById('pcEditorTitle');
            const idInput = document.getElementById('pcEditId');
            
            // Inputs
            const codeIn = document.getElementById('pcEditCode');
            const titleIn = document.getElementById('pcEditTitle');
            const typeIn = document.getElementById('pcEditType');
            const fineIn = document.getElementById('pcEditFine');
            const jailIn = document.getElementById('pcEditJail');

            if (mode === 'edit' && data) {
                title.innerText = 'Edit Penal Code';
                idInput.value = data.id; // Ensure your API returns 'id' for penal codes
                codeIn.value = data.code;
                titleIn.value = data.desc;
                typeIn.value = data.type || 'Misdemeanor';
                fineIn.value = data.fine;
                jailIn.value = data.jail;
            } else {
                title.innerText = 'Add New Penal Code';
                idInput.value = '';
                codeIn.value = '';
                titleIn.value = '';
                typeIn.value = 'Infraction';
                fineIn.value = '';
                jailIn.value = '';
            }
            
            // Trigger floating labels visual update
            [codeIn, titleIn, fineIn, jailIn].forEach(i => {
                if(i.value) i.classList.add('filled');
                else i.classList.remove('filled');
            });

            toggleModal('pcEditorModalOverlay', true);
        }

        async function submitPenalCodeForm(e) {
            e.preventDefault();
            const id = document.getElementById('pcEditId').value;
            const isEdit = !!id;
            
            const payload = {
                code: document.getElementById('pcEditCode').value,
                description: document.getElementById('pcEditTitle').value,
                type: document.getElementById('pcEditType').value,
                amount_due: parseFloat(document.getElementById('pcEditFine').value),
                jail_time_seconds: parseInt(document.getElementById('pcEditJail').value)
            };

            const endpoint = isEdit ? `/admin/penal-codes/${id}` : `/admin/penal-codes`;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const result = await apiRequest(endpoint, method, payload);
                if (result) {
                    customAlert(`Penal Code ${isEdit ? 'updated' : 'created'} successfully!`, "Success");
                    toggleModal('pcEditorModalOverlay', false);
                    loadAdminPenalCodes(); // Refresh table
                    
                    // Refresh appState codes if needed so dropdowns update immediately
                    const codes = await apiRequest('/penal-codes');
                    if(codes) appState.penalCodes = codes.map(c => ({
                        code: c.code, desc: c.description, fine: c.amount_due, jail: c.jail_time_seconds, type: c.type
                    }));
                }
            } catch (err) {
                console.error(err);
                customAlert("Failed to save Penal Code.", "Error");
            }
        }

        async function deletePenalCode(id) {
            if (!await customConfirm("Are you sure you want to delete this penal code?", "Delete Code", "Delete", true)) return;
            
            try {
                const result = await apiRequest(`/admin/penal-codes/${id}`, 'DELETE');
                if (result) {
                    customAlert("Penal Code deleted.", "Success");
                    loadAdminPenalCodes();
                }
            } catch (err) {
                customAlert("Failed to delete code.", "Error");
            }
        }

        async function submitCreateUserForm(e) {
            e.preventDefault();
            
            // 1. Get raw values from checkboxes (e.g., "officer", "junior_moderator")
            const checkboxes = document.querySelectorAll('input[name="newRoles"]:checked');
            const rawRoles = Array.from(checkboxes).map(cb => cb.value);
            
            if(rawRoles.length === 0) {
                return customAlert("Please select at least one role.", "Validation Error");
            }

            // 2. CORRECT ROLE MAPPING
            // Maps the lowercase checkbox values to the Capitalized strings the API expects.
            const roleMap = {
                'officer': 'Officer',
                'junior_moderator': 'Junior Moderator',
                'moderator': 'Moderator',
                'senior_moderator': 'Senior Moderator',
                'admin': 'Admin',
                'manager': 'Manager',
                'developer': 'Developer'
            };

            // Convert ["officer", "admin"] -> ["Officer", "Admin"]
            const finalRoles = rawRoles.map(r => {
                // If it's in the map, use the mapped value. 
                // Fallback: Capitalize first letter just in case.
                return roleMap[r] || r.charAt(0).toUpperCase() + r.slice(1);
            });

            const tempPassword = Math.random().toString(36).slice(-8) + Math.random().toString(36).slice(-2);

            const payload = {
                username: document.getElementById('newUsername').value,
                badgeNumber: document.getElementById('newBadge').value,
                role: finalRoles, // Sends correct format: ["Officer", "Admin"]
                department: document.getElementById('newDept').value,
                password: tempPassword 
            };

            const btn = e.submitter;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Creating...`;

            try {
                const result = await apiRequest('/v1/auth/register', 'POST', payload);
                
                if (result) {
                    toggleModal('createUserModalOverlay', false);
                    loadAdminUsers(); // Refresh the list
                    
                    await customAlert(
                        `User created successfully.\n\nTEMPORARY PASSWORD: ${tempPassword}\n\nRoles: ${finalRoles.join(', ')}`, 
                        "Account Created"
                    );
                }
            } catch (error) {
                console.error("Register Error:", error);
                customAlert(error.message || "Failed to create user.", "Error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- HANDLE ROLE CHANGE (Auto-fill Badge/Dept) ---
        function handleCreateUserRoleChange() {
            const role = document.getElementById('newRole').value;
            const badgeInput = document.getElementById('newBadge');
            const deptSelect = document.getElementById('newDept');
            const naOption = document.getElementById('deptOptionNA');
            
            if (role === 'admin' || role === 'moderator') {
                // 1. Force Badge to 0.0 and Lock it
                badgeInput.value = '0.0';
                badgeInput.readOnly = true;
                badgeInput.classList.add('filled', 'opacity-50', 'cursor-not-allowed');
                
                // 2. Force Dept to N/A and Lock it
                naOption.disabled = false; // Temporarily enable to select it
                deptSelect.value = 'N/A';
                deptSelect.classList.add('filled', 'opacity-50', 'cursor-not-allowed');
                deptSelect.style.pointerEvents = 'none'; // Prevent user from clicking
            } else {
                // 1. Reset Badge
                badgeInput.value = '';
                badgeInput.readOnly = false;
                badgeInput.classList.remove('filled', 'opacity-50', 'cursor-not-allowed');
                
                // 2. Reset Dept
                naOption.disabled = true;
                deptSelect.value = '';
                deptSelect.classList.remove('filled', 'opacity-50', 'cursor-not-allowed');
                deptSelect.style.pointerEvents = 'auto';
            }
        }

        // --- SMOOTH ANIMATION ENGINE ---
        
        // --- SMOOTH ANIMATION ENGINE ---
        function toggleModal(modalId, show) {
            const overlay = document.getElementById(modalId);
            if (!overlay) return;

            if (show) {
                // 1. Remove hidden immediately
                overlay.classList.remove('hidden');
                // 2. Add 'open' class for opacity transition
                requestAnimationFrame(() => {
                    overlay.classList.add('open');
                });
            } else {
                // 1. Start fade out
                overlay.classList.remove('open');
                // 2. Wait for transition, then hide
                setTimeout(() => {
                    if (!overlay.classList.contains('open')) {
                        overlay.classList.add('hidden');
                    }
                }, 300);
            }
        }

        async function debugAdminData() {
            console.log("--- DEBUGGING DATA ---");
            const data = await apiRequest('/citations');
            console.log("Type of data:", typeof data);
            console.log("Is Array?", Array.isArray(data));
            console.log("Raw Data:", data);
            alert("Check your F12 Console for data details");
        }
        // --- HELPER: GET ACTIVE SESSION ---
        function getActiveSession() {
            // 1. Check Session Storage (Current Tab)
            let token = sessionStorage.getItem('authToken');
            let userStr = sessionStorage.getItem('user');

            // 2. Check Local Storage (Remembered)
            if (!token) {
                token = localStorage.getItem('authToken');
                userStr = localStorage.getItem('user');
            }

            // 3. Parse User Data
            let user = null;
            if (userStr) {
                try { user = JSON.parse(userStr); } catch (e) { console.error("Corrupt user data"); }
            }

            return { token, user };
        }

        function escapeHTML(str) {
            if (!str) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        function openProofModal(url) {
            // FIX: Convert URL to new domain before showing
            const correctUrl = getCorrectImageUrl(url);
            
            const img = document.getElementById('proofModalImage');
            const link = document.getElementById('proofModalLink');
            
            if (img) img.src = correctUrl;
            if (link) link.href = correctUrl;
            
            toggleModal('proofModalOverlay', true);
        }
        function initDepartmentSelector() {
            const input = document.getElementById('transfer-new');
            const results = document.getElementById('transfer-dept-results');
            const arrow = document.getElementById('transfer-dept-arrow'); // Get the arrow
            
            if(!input || !results) return;

            const departments = [
                "Wisconsin State Patrol",
                "Outagamie County Sheriff's Office",
                "Fox Valley Metro Police Department"
            ];

            const renderList = () => {
                results.innerHTML = '';
                departments.forEach(dept => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `<span class="dropdown-desc font-medium">${dept}</span>`;
                    
                    item.onmousedown = (e) => e.preventDefault(); 
                    item.onclick = () => {
                        input.value = dept;
                        input.classList.add('filled');
                        results.classList.remove('show');
                        if(arrow) arrow.classList.remove('rotate-180'); // Reset arrow on select
                    };
                    results.appendChild(item);
                });
            };

            renderList();

            // Toggle visibility & Animation
            input.addEventListener('click', (e) => {
                e.stopPropagation(); 
                
                // Close others
                document.querySelectorAll('.dropdown-results.show').forEach(el => {
                    if(el !== results) el.classList.remove('show');
                });

                const isOpen = results.classList.contains('show');
                
                if (isOpen) {
                    results.classList.remove('show');
                    if(arrow) arrow.classList.remove('rotate-180');
                } else {
                    results.classList.add('show');
                    if(arrow) arrow.classList.add('rotate-180');
                }
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.classList.remove('show');
                    if(arrow) arrow.classList.remove('rotate-180'); // Reset arrow
                }
            });
        }
        // --- QUOTA SYSTEM LOGIC ---

        // Global variable to store the selected start date
        let appQuotaStartDate = null;

        function openQuotaModal() {
            // 1. Reset Date
            const now = new Date();
            const defaultDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            appQuotaStartDate = defaultDate;

            // 2. Target Modal Body
            const modalBody = document.querySelector('#quotaModalOverlay .modal-content .p-6.space-y-6');
            if (!modalBody) return;

            // 3. Inject Step 1 (Start Invisible)
            modalBody.innerHTML = `
                <div id="quotaStep1" class="flex flex-col items-center justify-center py-6 transition-all duration-500 ease-out opacity-0 translate-y-4">
                    <div class="mb-6 p-5 bg-blue-50 dark:bg-blue-900/20 rounded-full text-blue-600 dark:text-blue-400 shadow-sm ring-1 ring-blue-100 dark:ring-blue-800">
                        <i class="ph-duotone ph-calendar-check text-4xl"></i>
                    </div>
                    
                    <h4 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Select Promotion Date</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 text-center max-w-[260px] mb-8 leading-relaxed">
                        Select the date of your last promotions. Stats will be calculated from this date forward.
                    </p>
                    
                    <div class="w-full max-w-xs mb-8">
                        <label class="block text-center text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-2">Start Date</label>
                        <input type="date" id="introQuotaDate" class="modern-input text-center font-bold text-lg w-full focus:ring-0" value="${defaultDate}">
                    </div>
                    
                    <button onclick="transitionToQuotaSearch()" class="w-full max-w-xs px-8 py-3.5 bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2">
                        Continue to Search <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>
            `;

            // 4. Open Modal
            toggleModal('quotaModalOverlay', true);
            
            // 5. Trigger Fade In
            setTimeout(() => {
                const step1 = document.getElementById('quotaStep1');
                if(step1) {
                    step1.classList.remove('opacity-0', 'translate-y-4');
                    step1.classList.add('opacity-100', 'translate-y-0');
                }
            }, 100);
        }

        function transitionToQuotaSearch() {
            const step1 = document.getElementById('quotaStep1');
            const dateInput = document.getElementById('introQuotaDate');
            
            // Save Date
            if (dateInput) appQuotaStartDate = dateInput.value;

            // 1. Trigger Fade Out
            if(step1) {
                step1.classList.remove('opacity-100', 'translate-y-0');
                step1.classList.add('opacity-0', '-translate-y-4'); // Move UP and Fade Out
            }

            // 2. Wait 300ms for animation to finish, then swap content
            setTimeout(() => {
                const modalBody = document.querySelector('#quotaModalOverlay .modal-content .p-6.space-y-6');
                
                // Inject Step 2 (Start Invisible)
                modalBody.innerHTML = `
                    <div id="quotaStep2" class="transition-all duration-500 ease-out opacity-0 translate-y-4">
                        <div class="custom-dropdown-container form-field-group !mt-0 relative mb-6">
                            <input type="text" id="quotaSearchInput" class="modern-input" autocomplete="off" placeholder=" " />
                            <label for="quotaSearchInput" class="floating-label">Search Officer (Name or Badge)</label>
                            <div id="quotaSearchResults" class="dropdown-results"></div>
                        </div>

                        <div id="quotaStatsContainer" class="hidden space-y-4"></div>
                    </div>
                `;

                // 3. Trigger Fade In for Step 2
                setTimeout(() => {
                    const step2 = document.getElementById('quotaStep2');
                    if(step2) {
                        step2.classList.remove('opacity-0', 'translate-y-4');
                        step2.classList.add('opacity-100', 'translate-y-0');
                    }
                    
                    // Setup Logic
                    setupQuotaSearchListeners();
                    document.getElementById('quotaSearchInput').focus();
                }, 50);

            }, 300); // Wait for Step 1 to leave
        }
        function setupQuotaSearchListeners() {
            const input = document.getElementById('quotaSearchInput');
            const results = document.getElementById('quotaSearchResults');
            
            if(!input || !results) return;

            input.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                results.innerHTML = '';
                
                if (term.length < 1) {
                    results.classList.remove('show');
                    return;
                }

                // Filter users from the global adminData object
                const matches = (adminData.users || []).filter(u => 
                    u.username.toLowerCase().includes(term) || 
                    (u.badge_number && u.badge_number.toLowerCase().includes(term))
                );

                if (matches.length === 0) {
                    results.innerHTML = '<div class="p-3 text-sm text-slate-400 text-center">No officers found.</div>';
                } else {
                    matches.forEach(u => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.innerHTML = `
                            <span class="font-bold text-slate-700 dark:text-slate-200">${u.username}</span>
                            <span class="dropdown-meta">${u.badge_number || 'No Badge'}</span>
                        `;
                        item.onmousedown = (e) => e.preventDefault(); 
                        item.onclick = () => selectQuotaOfficer(u);
                        results.appendChild(item);
                    });
                }
                results.classList.add('show');
            };

            // Hide dropdown when clicking away
            input.onblur = () => {
                setTimeout(() => results.classList.remove('show'), 200);
            };
            
            // Re-bind floating labels for the new input
            if(typeof bindFloatingLabels === 'function') bindFloatingLabels();
        }

        function selectQuotaOfficer(user) {
            // Update UI
            document.getElementById('quotaSearchInput').value = user.username;
            document.getElementById('quotaSearchResults').classList.remove('show');
            
            // Setup Avatar
            let avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}`;
            if(typeof fetchRobloxAvatar === 'function') {
                fetchRobloxAvatar(user.username).then(url => { 
                    if(url && document.getElementById('quotaDynamicAvatar')) document.getElementById('quotaDynamicAvatar').src = url; 
                });
            }

            // Show Container
            const container = document.getElementById('quotaStatsContainer');
            container.classList.remove('hidden');

            // Render Stats HTML Structure
            container.innerHTML = `
                <div class="flex items-center gap-4 mb-4 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 animate-fade-in-up">
                    <div class="w-12 h-12 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-white dark:border-slate-600 shadow-sm">
                        <img id="quotaDynamicAvatar" src="${avatarUrl}" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-900 dark:text-white text-lg">${user.username}</h4>
                        <p class="text-xs text-slate-500 font-mono">Badge: ${user.badge_number || 'N/A'}</p>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4 bg-blue-50/50 dark:bg-blue-900/10 p-2 rounded-lg border border-blue-100 dark:border-blue-800 animate-fade-in-up" style="animation-delay: 50ms">
                    <label class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider ml-2"><i class="ph-bold ph-calendar-check mr-1"></i> Stats Since:</label>
                    <input type="date" id="quotaStartDate" value="${appQuotaStartDate}" 
                        class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-bold rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm cursor-pointer">
                </div>

                <div id="quotaStatsGrid" class="grid grid-cols-2 gap-4 animate-fade-in-up" style="animation-delay: 100ms"></div>
            `;

            // Function to Calculate & Render Numbers
            const updateStats = () => {
                const dateInput = document.getElementById('quotaStartDate').value;
                const startDate = new Date(dateInput);
                startDate.setHours(0,0,0,0);

                const isAfterDate = (ts) => {
                    if(!ts) return false;
                    const d = new Date(ts);
                    return d >= startDate;
                };

                // Filter Data
                const citationsCount = (adminData.citations || []).filter(c => (c.submittedByUsername === user.username || c.submittedBy === user.username) && isAfterDate(c.timestamp)).length;
                const arrestsCount = (adminData.arrests || []).filter(a => (a.submittedByUsername === user.username || a.submittedBy === user.username) && isAfterDate(a.timestamp)).length;
                const warrantsCount = (adminData.warrants || []).filter(w => (w.submittedByUsername === user.username) && isAfterDate(w.dateOfIssue)).length;
                
                // Shifts > 30 mins
                const shiftsCount = (adminData.shifts || []).filter(s => {
                    const isUser = (s.submittedByUsername === user.username || s.submittedBy === user.username);
                    if (!isUser || !isAfterDate(s.timestamp)) return false;
                    
                    let minutes = 0;
                    const durStr = s.shiftDuration || s.duration || "";
                    const hMatch = durStr.match(/(\d+)\s*h/i);
                    const mMatch = durStr.match(/(\d+)\s*m/i);
                    if (hMatch) minutes += parseInt(hMatch[1]) * 60;
                    if (mMatch) minutes += parseInt(mMatch[1]);
                    
                    return minutes >= 30;
                }).length;

                // Lifetime Total
                const totalShiftsAllTime = (adminData.shifts || []).filter(s => (s.submittedByUsername === user.username || s.submittedBy === user.username)).length;

                // Render Grid
                const grid = document.getElementById('quotaStatsGrid');
                grid.innerHTML = `
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-900/30 text-center">
                        <div class="text-xs text-blue-500 uppercase font-bold tracking-wider mb-1">Citations</div>
                        <div class="text-3xl font-black text-blue-600 dark:text-blue-400">${citationsCount}</div>
                    </div>
                    <div class="p-4 bg-rose-50 dark:bg-rose-900/20 rounded-xl border border-rose-100 dark:border-rose-900/30 text-center">
                        <div class="text-xs text-rose-500 uppercase font-bold tracking-wider mb-1">Arrests</div>
                        <div class="text-3xl font-black text-rose-600 dark:text-rose-400">${arrestsCount}</div>
                    </div>
                    <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-100 dark:border-amber-900/30 text-center">
                        <div class="text-xs text-amber-500 uppercase font-bold tracking-wider mb-1">Warrants</div>
                        <div class="text-3xl font-black text-amber-600 dark:text-amber-400">${warrantsCount}</div>
                    </div>
                    <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-900/30 text-center relative overflow-hidden">
                        <div class="text-xs text-emerald-500 uppercase font-bold tracking-wider mb-1">Valid Shifts</div>
                        <div class="text-3xl font-black text-emerald-600 dark:text-emerald-400">${shiftsCount}</div>
                        <div class="absolute bottom-1 w-full text-[9px] text-emerald-600/50 dark:text-emerald-400/50 font-bold uppercase text-center left-0">Over 30 Mins</div>
                    </div>
                    <div class="col-span-2 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-between items-center px-6 mt-1">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider text-left">Total Shift Logs<br><span class="opacity-50 text-[10px] font-normal normal-case">(Lifetime Count)</span></div>
                        <div class="text-3xl font-black text-slate-700 dark:text-slate-200">${totalShiftsAllTime}</div>
                    </div>
                `;
            };

            // Listener for internal date change
            document.getElementById('quotaStartDate').addEventListener('change', updateStats);
            updateStats();
        }
        // --- FIX: Single Delete Wrappers for Batch Endpoints ---

    async function adminDeleteCitation(id) {
        if (!await customConfirm('Are you sure you want to delete this citation?', 'Confirm Deletion', 'Delete', true)) return;
        
        // Uses batch endpoint /admin/citations
        const result = await apiRequest('/admin/citations', 'DELETE', { ids: [id] });
        if (result) {
            customAlert('Citation deleted successfully.', 'Success');
            loadAdminLogs();
        }
    }

    async function adminDeleteArrest(id) {
        if (!await customConfirm('Are you sure you want to delete this arrest record?', 'Confirm Deletion', 'Delete', true)) return;
        
        // Uses batch endpoint /admin/arrests
        const result = await apiRequest('/admin/arrests', 'DELETE', { ids: [id] });
        if (result) {
            customAlert('Arrest record deleted successfully.', 'Success');
            loadAdminLogs();
        }
    }

    async function adminDeleteWarrant(id) {
        if (!await customConfirm('Are you sure you want to delete this warrant?', 'Confirm Deletion', 'Delete', true)) return;
        
        // Uses batch endpoint /admin/warrant_logs (Note the underscore to match backend)
        const result = await apiRequest('/admin/warrant_logs', 'DELETE', { ids: [id] });
        if (result) {
            customAlert('Warrant deleted successfully.', 'Success');
            loadAdminLogs();
        }
    }
    async function adminDeleteShiftLog(id) {
        if (!await customConfirm('Are you sure you want to delete this shift log?', 'Confirm Deletion', 'Delete', true)) return;

        // Fix: Use the batch endpoint with an underscore '/admin/shift_logs'
        // We send the single ID inside an array: { ids: [id] }
        const result = await apiRequest('/admin/shift_logs', 'DELETE', { 
            ids: [id] 
        });

        if (result) {
            customAlert('Shift log deleted successfully.', 'Success');
            loadAdminLogs(); // Refresh the table
        }
    }
    // --- IMAGE URL FIXER ---
function getCorrectImageUrl(url) {
    if (!url) return "";
    
    // If it's a base64 data URI (fresh upload preview), return as is
    if (url.startsWith('data:')) return url;

    try {
        // If it's already a full URL, force the hostname to the new domain
        const urlObj = new URL(url);
        urlObj.hostname = "images.shadowle.com";
        return urlObj.toString();
    } catch (e) {
        // If it's a relative path or invalid URL string, prepend the new domain
        if (url.startsWith('/')) {
             return "https://images.shadowle.com" + url;
        }
        // Fallback: assume it is a filename
        return "https://images.shadowle.com/" + url;
    }
}
// --- ADMIN SHIFT ACTIONS ---

async function adminShiftAction(id, action) {
    // action should be 'accept' or 'deny'
    if (!await customConfirm(`Are you sure you want to ${action.toUpperCase()} this shift?`, "Confirm Action", action.charAt(0).toUpperCase() + action.slice(1), action === 'deny')) return;

    const endpoint = `/v1/shift/${id}/${action}`; // e.g., /v1/shift/123/accept
    const result = await apiRequest(endpoint, 'POST');

    if (result) {
        customAlert(`Shift ${action}ed successfully.`, "Success");
        loadAdminLogs();
    }
}

async function adminBulkShiftAction(action) {
    // action: 'accept' or 'deny'
    const checkboxes = document.querySelectorAll('#adminShiftsBody input.row-checkbox:checked');
    if (checkboxes.length === 0) return customAlert("Please select items first.", "Selection Empty");

    if (!await customConfirm(`${action.toUpperCase()} ${checkboxes.length} selected shifts?`, "Confirm Bulk Action", "Yes", action === 'deny')) return;

    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    // Endpoint: /v1/shifts/accept or /v1/shifts/deny
    const endpoint = `/v1/shifts/${action}`;
    
    const result = await apiRequest(endpoint, 'POST', { ids: ids });
    
    if (result) {
         customAlert(`Successfully ${action}ed ${ids.length} shifts.`, "Batch Complete");
         loadAdminLogs(); 
         const headerCheck = document.querySelector('input[onchange*="adminShiftsBody"]');
         if(headerCheck) headerCheck.checked = false;
    }
}

// --- SHIFT LOGIC VARIABLES ---
let shiftTimerInterval = null;
let currentShiftStart = null;
// NEW: Track session stats locally
let sessionStats = { stops: 0, citations: 0, arrests: 0 };

// --- INITIALIZE SHIFT PANEL ---
async function initShiftPanel() {
    try {
        const res = await apiRequest('/v1/me');
        if (res && res.officer) {
            const officer = res.officer;
            
            if (officer.shift_start) {
                // Active Shift Found
                currentShiftStart = new Date(officer.shift_start);
                setShiftState(true);
            } else {
                // No Active Shift
                currentShiftStart = null;
                setShiftState(false);
            }
        }
        loadRecentShifts();
    } catch (err) {
        console.error("Failed to init shift panel", err);
    }
}

// --- UI STATE MANAGER ---
function setShiftState(isActive) {
    const statusText = document.getElementById('shift-status-text');
    const statusBar = document.getElementById('shift-status-bar');
    const iconContainer = document.getElementById('shift-icon-container');
    const icon = document.getElementById('shift-icon');
    const btnStart = document.getElementById('btn-start-shift');
    const btnEnd = document.getElementById('btn-end-shift');
    const trackerCard = document.getElementById('live-tracker-card'); // Get the tracker

    if (isActive) {
        // Active State
        statusText.innerText = "On Duty";
        statusText.classList.replace('text-slate-900', 'text-emerald-600');
        statusText.classList.replace('dark:text-white', 'dark:text-emerald-400');
        
        statusBar.className = "absolute top-0 left-0 w-full h-1.5 bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
        
        iconContainer.className = "w-20 h-20 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mb-4 animate-pulse-slow";
        icon.className = "ph-duotone ph-siren text-4xl text-emerald-600 dark:text-emerald-400";
        
        btnStart.classList.add('hidden');
        btnEnd.classList.remove('hidden');

        // NEW: Enable Tracker
        if(trackerCard) {
            trackerCard.classList.remove('opacity-50', 'pointer-events-none');
            trackerCard.classList.add('opacity-100', 'pointer-events-auto');
        }

        // Start Timer Loop
        if (shiftTimerInterval) clearInterval(shiftTimerInterval);
        updateShiftTimer(); 
        shiftTimerInterval = setInterval(updateShiftTimer, 1000);

    } else {
        // Inactive State
        statusText.innerText = "Off Duty";
        statusText.classList.replace('text-emerald-600', 'text-slate-900');
        statusText.classList.replace('dark:text-emerald-400', 'dark:text-white');
        
        statusBar.className = "absolute top-0 left-0 w-full h-1.5 bg-slate-300 dark:bg-slate-700";
        
        iconContainer.className = "w-20 h-20 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4";
        icon.className = "ph-duotone ph-coffee text-4xl text-slate-400";
        
        btnStart.classList.remove('hidden');
        btnEnd.classList.add('hidden');

        // NEW: Disable Tracker
        if(trackerCard) {
            trackerCard.classList.add('opacity-50', 'pointer-events-none');
            trackerCard.classList.remove('opacity-100', 'pointer-events-auto');
        }
        
        if (shiftTimerInterval) clearInterval(shiftTimerInterval);
        document.getElementById('shift-timer').innerText = "00:00:00";
    }
}

function updateShiftTimer() {
    if (!currentShiftStart) return;
    const now = new Date();
    const diff = now - currentShiftStart;
    const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
    const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
    const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
    document.getElementById('shift-timer').innerText = `${h}:${m}:${s}`;
}

// --- NEW: LIVE STATS LOGIC ---
function updateLiveStat(type, change) {
    if (sessionStats[type] === undefined) return;
    
    // Prevent negatives
    if (sessionStats[type] + change < 0) return;

    sessionStats[type] += change;
    
    // Update UI
    const el = document.getElementById(`live-${type}`);
    if (el) el.innerText = sessionStats[type];
}

function resetLiveStats() {
    sessionStats = { stops: 0, citations: 0, arrests: 0 };
    ['stops', 'citations', 'arrests'].forEach(type => {
        const el = document.getElementById(`live-${type}`);
        if(el) el.innerText = "0";
    });
}

// --- API ACTIONS ---
async function startShift() {
    const btn = document.getElementById('btn-start-shift');
    btn.disabled = true;
    btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Starting...`;

    try {
        const res = await apiRequest('/v1/shift/start', 'POST');
        if (res && res.success) {
            currentShiftStart = new Date(res.shift.startedAt);
            resetLiveStats(); // Clear tracker for new shift
            setShiftState(true);
            customAlert("You are now 10-41 (On Duty).", "Shift Started");
            loadRecentShifts(); 
        }
    } catch (err) {
        console.error(err);
        customAlert(err.message || "Failed to start shift.", "Error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<i class="ph-bold ph-play"></i> Start Shift`;
    }
}

function openEndShiftModal() {
    // 1. Auto-fill modal with tracker stats
    document.getElementById('endShiftStops').value = sessionStats.stops;
    document.getElementById('endShiftCitations').value = sessionStats.citations;
    document.getElementById('endShiftArrests').value = sessionStats.arrests;
    
    // 2. Add floating label visual fix
    document.getElementById('endShiftStops').classList.add('filled');
    document.getElementById('endShiftCitations').classList.add('filled');
    document.getElementById('endShiftArrests').classList.add('filled');

    toggleModal('endShiftModalOverlay', true);
    document.addEventListener('paste', handleShiftPaste);
}

// Handle Paste (Ctrl+V) for Screenshot
function handleShiftPaste(e) {
    if (!document.getElementById('endShiftModalOverlay').classList.contains('hidden')) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('endShiftPreviewImg').src = event.target.result;
                    document.getElementById('endShiftPreviewImg').classList.remove('hidden');
                    document.getElementById('endShiftPreviewContent').classList.add('hidden');
                    document.getElementById('endShiftPreviewImg').dataset.base64 = event.target.result;
                };
                reader.readAsDataURL(blob);
            }
        }
    }
}

function previewEndShiftImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('endShiftPreviewImg').src = e.target.result;
            document.getElementById('endShiftPreviewImg').classList.remove('hidden');
            document.getElementById('endShiftPreviewContent').classList.add('hidden');
            document.getElementById('endShiftPreviewImg').dataset.base64 = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
}

async function submitEndShift(e) {
    e.preventDefault();
    
    // Grab values from the new inputs in the modal
    const stops = parseInt(document.getElementById('endShiftStops').value) || 0;
    const citations = parseInt(document.getElementById('endShiftCitations').value) || 0;
    const arrests = parseInt(document.getElementById('endShiftArrests').value) || 0;
    const notes = document.getElementById('endShiftNotes').value;
    const imgBase64 = document.getElementById('endShiftPreviewImg').dataset.base64;

    if (!imgBase64) {
        return customAlert("Please upload or paste a screenshot for verification.", "Proof Required");
    }

    const btn = e.submitter;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Submitting...`;

    try {
        const payload = {
            traffic_stops: stops,
            citations: citations,
            arrests: arrests,
            notes: notes,
            image: imgBase64
        };

        const res = await apiRequest('/v1/shift/end', 'POST', payload);
        
        if (res && res.success) {
            toggleModal('endShiftModalOverlay', false);
            setShiftState(false);
            resetLiveStats(); // Reset tracker
            currentShiftStart = null;
            customAlert("You are now 10-42 (Off Duty). Log saved.", "Shift Ended");
            
            // Reset Form Fields
            document.getElementById('endShiftStops').value = "0";
            document.getElementById('endShiftCitations').value = "0";
            document.getElementById('endShiftArrests').value = "0";
            document.getElementById('endShiftNotes').value = "";
            document.getElementById('endShiftPreviewImg').src = "";
            document.getElementById('endShiftPreviewImg').classList.add('hidden');
            document.getElementById('endShiftPreviewContent').classList.remove('hidden');
            delete document.getElementById('endShiftPreviewImg').dataset.base64;
            
            loadRecentShifts();
        }
    } catch (err) {
        console.error(err);
        customAlert(err.message || "Failed to end shift.", "Error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function loadRecentShifts() {
    const list = document.getElementById('recent-shifts-list');
    if (!list) return;

    try {
        const res = await apiRequest('/v1/shifts?limit=5');
        if (res && res.shifts) {
            if (res.shifts.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 text-sm py-2">No recent shifts found.</div>`;
                return;
            }

            list.innerHTML = res.shifts.map(s => {
                const start = new Date(s.started_at);
                const end = s.ended_at ? new Date(s.ended_at) : null;
                
                // Duration Calculation
                let duration = "Active";
                if (end) {
                    const diff = end - start;
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    duration = `${h}h ${m}m`;
                }
                
                let statusColor = 'bg-slate-100 text-slate-600';
                if(s.status === 'active') statusColor = 'bg-emerald-100 text-emerald-700';
                if(s.status === 'accepted') statusColor = 'bg-blue-100 text-blue-700';
                if(s.status === 'denied') statusColor = 'bg-rose-100 text-rose-700';

                return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div class="text-xs text-slate-400 font-mono">${start.toLocaleDateString()}</div>
                            <div class="font-bold text-slate-700 dark:text-slate-200">${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end ? end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</div>
                        </div>
                        <div class="text-right">
                             <span class="text-xs font-bold px-2 py-1 rounded ${statusColor} uppercase">${s.status}</span>
                             <div class="text-xs text-slate-500 mt-1">${duration}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (err) {
        console.warn("Failed to load history", err);
        list.innerHTML = `<div class="text-center text-red-400 text-sm py-2">Failed to load.</div>`;
    }
}
    </script>
</body>
</html>